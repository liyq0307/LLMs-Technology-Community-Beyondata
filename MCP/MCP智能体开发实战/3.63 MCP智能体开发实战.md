# MCPæ™ºèƒ½ä½“å¼€å‘å®æˆ˜å…¥é—¨

* Anthropic MCPå‘å¸ƒé€šå‘Šï¼šhttps://www.anthropic.com/news/model-context-protocol

* MCP GitHubä¸»é¡µï¼šhttps://github.com/modelcontextprotocol

## ä¸€ã€MCPæŠ€æœ¯ä½“ç³»ä»‹ç»

### 1. MCPå…¥é—¨ä»‹ç»

MCPï¼Œå…¨ç§°æ˜¯Model Context Protocolï¼Œæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼Œç”±Claudeæ¯å…¬å¸Anthropicäºå»å¹´11æœˆæ­£å¼æå‡ºã€‚

![](images/194798e6-1520-4f8e-9356-4af936d90a49.png)

MCPåˆšå‘å¸ƒçš„æ—¶å€™ä¸æ¸©ä¸ç«ï¼Œç›´åˆ°ä»Šå¹´Agentå¤§çˆ†å‘æ‰è¢«å¹¿æ³›å…³æ³¨ã€‚è€Œåœ¨ä»Šå¹´2æœˆï¼ŒCursoræ­£å¼å®£å¸ƒåŠ å…¥MCPåŠŸèƒ½æ”¯æŒï¼Œä¸€ä¸¾å°†MCPæ¨åˆ°äº†å…¨ä½“å¼€å‘äººå‘˜é¢å‰ã€‚ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼ŒMCPæ˜¯ä¸€ç§æŠ€æœ¯åè®®ï¼Œä¸€ç§æ™ºèƒ½ä½“Agentå¼€å‘è¿‡ç¨‹ä¸­å…±åŒçº¦å®šçš„ä¸€ç§è§„èŒƒã€‚è¿™å°±å¥½æ¯”ç§¦å§‹çš‡çš„â€œ**ä¹¦åŒæ–‡ã€è½¦åŒè½¨**â€ï¼Œåœ¨ç»Ÿä¸€çš„è§„èŒƒä¸‹ï¼Œå¤§å®¶çš„**åä½œæ•ˆç‡å°±èƒ½å¤§å¹…æé«˜**ï¼Œæœ€ç»ˆ**æå‡æ™ºèƒ½ä½“Agentçš„å¼€å‘æ•ˆç‡**ã€‚æˆªæ­¢ç›®å‰ï¼Œå·²ä¸Šåƒç§MCPå·¥å…·è¯ç”Ÿï¼Œåœ¨å¼ºæ‚çš„MCPç”Ÿæ€åŠ æŒä¸‹ï¼Œ äººäººæ‰‹æ“Manusçš„æ—¶ä»£å³å°†åˆ°æ¥ã€‚

![](images/48f99881-9af5-41f6-9038-2e3c31283244.png)

æ€»çš„æ¥è¯´\*\*ï¼Œ**MCP**è§£å†³çš„æœ€å¤§ç—›ç‚¹ï¼Œå°±æ˜¯Agentå¼€å‘ä¸­è°ƒç”¨å¤–éƒ¨å·¥å…·çš„æŠ€æœ¯é—¨æ§›è¿‡é«˜çš„é—®é¢˜ã€‚\*\*

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œèƒ½è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼Œæ˜¯å¤§æ¨¡å‹è¿›åŒ–ä¸ºæ™ºèƒ½ä½“Agentçš„å…³é”®ï¼Œå¦‚æœä¸èƒ½ä½¿ç”¨å¤–éƒ¨å·¥å…·ï¼Œå¤§æ¨¡å‹å°±åªèƒ½æ˜¯ä¸ªç®€å•çš„èŠå¤©æœºå™¨äººï¼Œç”šè‡³è¿æŸ¥è¯¢å¤©æ°”éƒ½åšä¸åˆ°ã€‚ç”±äºåº•å±‚æŠ€æœ¯é™åˆ¶å•Šï¼Œå¤§æ¨¡å‹æœ¬èº«æ˜¯æ— æ³•å’Œå¤–éƒ¨å·¥å…·ç›´æ¥é€šä¿¡çš„ï¼Œå› æ­¤Function callingçš„æ€è·¯ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªå¤–éƒ¨å‡½æ•°ï¼ˆfunctionï¼‰ä½œä¸ºä¸­ä»‹ï¼Œä¸€è¾¹ä¼ é€’å¤§æ¨¡å‹çš„è¯·æ±‚ï¼Œå¦ä¸€è¾¹è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼Œæœ€ç»ˆè®©å¤§æ¨¡å‹èƒ½å¤Ÿé—´æ¥çš„è°ƒç”¨å¤–éƒ¨å·¥å…·ã€‚

![](images/26fcb511-ba75-42b3-bc4a-e8310ced98b9.png)

ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬è¦æŸ¥è¯¢å½“å‰å¤©æ°”æ—¶ï¼Œè®©å¤§æ¨¡å‹è°ƒç”¨å¤–éƒ¨å·¥å…·çš„function callingçš„è¿‡ç¨‹å°±å¦‚å›¾æ‰€ç¤ºï¼š

![](images/b37c170f-e34b-4bc7-b00b-10d545df0b04.png)

Function callingæ˜¯ä¸ªéå¸¸ä¸é”™çš„æŠ€æœ¯è®¾è®¡ï¼Œè‡ªè¯ç”Ÿä»¥æ¥ï¼Œä¸€ç›´è¢«ä¸šå†…å¥‰ä¸ºåœ­è‡¬ã€‚ä½†å”¯ä¸€çš„é—®é¢˜å°±æ˜¯ï¼Œç¼–å†™è¿™ä¸ªå¤–éƒ¨å‡½æ•°çš„å·¥ä½œé‡å¤ªå¤§äº†ï¼Œä¸€ä¸ªç®€å•çš„å¤–éƒ¨å‡½æ•°å¾€å¾€å°±å¾—ä¸Šç™¾è¡Œä»£ç ï¼Œè€Œä¸”ï¼Œä¸ºäº†è®©å¤§æ¨¡å‹â€œè®¤è¯†â€è¿™äº›å¤–éƒ¨å‡½æ•°ï¼Œæˆ‘ä»¬è¿˜è¦é¢å¤–ä¸ºæ¯ä¸ªå¤–éƒ¨å‡½æ•°ç¼–å†™ä¸€ä¸ªJSON Schemaæ ¼å¼çš„åŠŸèƒ½è¯´æ˜ï¼Œæ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç²¾å¿ƒè®¾è®¡ä¸€ä¸ªæç¤ºè¯æ¨¡ç‰ˆï¼Œæ‰èƒ½æé«˜Function callingå“åº”çš„å‡†ç¡®ç‡ã€‚

è€ŒMCPçš„ç›®æ ‡ï¼Œå°±æ˜¯èƒ½åœ¨Agentå¼€å‘è¿‡ç¨‹ä¸­ï¼Œè®©å¤§æ¨¡å‹æ›´åŠ ä¾¿æ·çš„è°ƒç”¨å¤–éƒ¨å·¥å…·ã€‚ä¸ºæ­¤ï¼ŒMCPæå‡ºäº†ä¸¤ä¸ªæ–¹æ¡ˆï¼Œå…¶ä¸€ï¼Œâ€œ**è½¦åŒè½¨ã€ä¹¦åŒæ–‡**â€ï¼Œç»Ÿä¸€Function callingçš„è¿è¡Œè§„èŒƒã€‚

é¦–å…ˆæ˜¯å…ˆç»Ÿä¸€åç§°ï¼ŒMCPæŠŠå¤§æ¨¡å‹è¿è¡Œç¯å¢ƒç§°ä½œ MCP Clientï¼Œä¹Ÿå°±æ˜¯MCPå®¢æˆ·ç«¯ï¼ŒåŒæ—¶ï¼ŒæŠŠå¤–éƒ¨å‡½æ•°è¿è¡Œç¯å¢ƒç§°ä½œMCP Serverï¼Œä¹Ÿå°±æ˜¯MCPæœåŠ¡å™¨ï¼Œ

![](images/2af974f9-b19b-471c-aa3a-c031f10ab142.png)

ç„¶åï¼Œç»Ÿä¸€MCPå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„è¿è¡Œè§„èŒƒï¼Œå¹¶ä¸”è¦æ±‚MCPå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ï¼Œä¹Ÿç»Ÿä¸€æŒ‰ç…§æŸä¸ªæ—¢å®šçš„æç¤ºè¯æ¨¡æ¿è¿›è¡Œé€šä¿¡ã€‚

â€œè½¦åŒè½¨ã€ä¹¦åŒæ–‡â€æœ€å¤§çš„å¥½å¤„å°±åœ¨äºï¼Œå¯ä»¥é¿å…MCPæœåŠ¡å™¨çš„é‡å¤å¼€å‘ï¼Œä¹Ÿå°±æ˜¯é¿å…å¤–éƒ¨å‡½æ•°é‡å¤ç¼–å†™ã€‚ä¾‹å¦‚ï¼ŒåƒæŸ¥è¯¢å¤©æ°”ã€ç½‘é¡µçˆ¬å–ã€æŸ¥è¯¢æœ¬åœ°MySQLæ•°æ®åº“è¿™ç§é€šç”¨çš„éœ€æ±‚ï¼Œå¤§å®¶æœ‰ä¸€ä¸ªäººå¼€å‘äº†ä¸€ä¸ªæœåŠ¡å™¨å°±å¥½ï¼Œå¼€å‘å®Œå¤§å®¶éƒ½èƒ½å¤åˆ¶åˆ°è‡ªå·±çš„é¡¹ç›®é‡Œæ¥ä½¿ç”¨ï¼Œä¸ç”¨æ¯ä¸ªäººæ¯æ¬¡éƒ½å•ç‹¬å†™ä¸€å¥—ã€‚

è¿™å¯æ˜¯ä¿ƒè¿›å…¨çƒAIå¼€å‘è€…å…±åŒåä½œçš„å¥½äº‹å„¿ï¼Œå¾ˆå¿«ï¼ŒGitHubä¸Šå°±å‡ºç°äº†æµ·é‡çš„å·²ç»å¼€å‘å¥½çš„MCP æœåŠ¡å™¨ï¼Œä»SQLæ•°æ®åº“æ£€ç´¢ã€åˆ°ç½‘é¡µæµè§ˆä¿¡æ¯çˆ¬å–ï¼Œä»å‘½ä»¤è¡Œæ“ä½œç”µè„‘ã€åˆ°æ•°æ®åˆ†ææœºå™¨å­¦ä¹ å»ºæ¨¡ï¼Œç­‰ç­‰ç­‰ç­‰ï¼Œä¸ä¸€è€Œè¶³ã€‚

![](images/3aecfaf0-f7bb-4072-a78d-9f92d5a4c85d.png)

ç°åœ¨ï¼Œåªè¦ä½ æœ¬åœ°è¿è¡Œçš„å¤§æ¨¡å‹æ”¯æŒMCPåè®®ï¼Œä¹Ÿå°±æ˜¯åªè¦å®‰è£…äº†ç›¸å…³çš„åº“ï¼Œä»…éœ€å‡ è¡Œä»£ç å³å¯æ¥å…¥è¿™äº›æµ·é‡çš„å¤–éƒ¨å·¥å…·ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰Agentå¼€å‘é—¨æ§›ç¬é—´é™ä½äº†å‘¢ã€‚

è¿™ç§â€œè½¦åŒè½¨ã€ä¹¦åŒæ–‡â€çš„è§„èŒƒï¼Œåœ¨æŠ€æœ¯é¢†åŸŸå°±è¢«ç§°ä½œåè®®ï¼Œä¾‹å¦‚httpå°±æ˜¯ç½‘ç»œä¿¡æ¯äº¤æ¢çš„æŠ€æœ¯åè®®ã€‚å„ç±»æŠ€æœ¯åè®®çš„ç›®æ ‡ï¼Œéƒ½æ˜¯å¸Œæœ›**é€šè¿‡æé«˜åä½œæ•ˆç‡æ¥æå‡å¼€å‘æ•ˆç‡**ï¼Œè€ŒMCPï¼ŒModel Context Protocolï¼Œå°±æ˜¯ä¸€ç§æ—¨åœ¨æé«˜å¤§æ¨¡å‹Agentå¼€å‘æ•ˆç‡çš„æŠ€æœ¯åè®®ã€‚

é‚£æ—¢ç„¶æ˜¯åè®®ï¼Œå¿…ç„¶æ˜¯ä½¿ç”¨çš„äººè¶Šå¤šæ‰è¶Šæœ‰ç”¨ã€‚å› æ­¤ï¼Œä¸ºäº†è¿›ä¸€æ™®åŠMCPåè®®ï¼ŒAnthropicè¿˜æä¾›äº†ä¸€æ•´å¥—MCPå®¢æˆ·ç«¯ã€æœåŠ¡å™¨å¼€å‘çš„SDKï¼Œä¹Ÿå°±æ˜¯å¼€å‘å·¥å…·ï¼Œå¹¶ä¸”æ”¯æŒPythonã€TSå’ŒJavaç­‰å¤šç§è¯­è¨€ï¼Œå€ŸåŠ©SDKï¼Œä»…éœ€å‡ è¡Œä»£ç ï¼Œå°±å¯ä»¥å¿«é€Ÿå¼€å‘ä¸€ä¸ªMCPæœåŠ¡å™¨ã€‚

![](images/07f2ae84-0e91-4c55-89f4-f47ee7347099.png)

ç„¶åï¼Œä½ å°±å¯ä»¥æŠŠå®ƒæ¥å…¥ä»»æ„ä¸€ä¸ªMCPå®¢æˆ·ç«¯æ¥æ„å»ºæ™ºèƒ½ä½“ï¼Œå¦‚æœæ„¿æ„ï¼Œè¿˜å¯ä»¥æŠŠMCPæœåŠ¡å™¨åˆ†äº«åˆ°ç¤¾åŒºï¼Œç»™æœ‰éœ€æ±‚çš„å¼€å‘è€…ä½¿ç”¨ï¼Œç”šè‡³ä½ è¿˜å¯ä»¥æŠŠä½ çš„MCPæœåŠ¡å™¨æ”¾åˆ°çº¿ä¸Šè¿è¡Œï¼Œè®©ç”¨æˆ·ä»˜è´¹ä½¿ç”¨ã€‚

è€ŒMCPçš„å®¢æˆ·ç«¯ï¼Œä¸ä»…æ”¯æŒClaudeæ¨¡å‹ï¼Œä¹Ÿæ”¯æŒä»»æ„æœ¬åœ°æ¨¡å‹æˆ–è€…åœ¨çº¿å¤§æ¨¡å‹ï¼Œæˆ–è€…æ˜¯ä¸€äº›IDEã€‚ä¾‹å¦‚ï¼Œç°åœ¨Cursoræ­£å¼æ¥å…¥MCPï¼Œä»£è¡¨ç€Cursoræ­£å¼æˆä¸ºMCPå®¢æˆ·ç«¯ï¼Œåœ¨Cursorä¸­ï¼Œæˆ‘ä»¬ä¸ä»…èƒ½å¿«é€Ÿç¼–å†™MCPæœåŠ¡å™¨ï¼ˆå¤–éƒ¨å‡½æ•°ï¼‰ï¼Œæ›´èƒ½å€ŸåŠ©Cursorä¸€é”®è¿æ¥ä¸Šæˆç™¾ä¸Šåƒçš„å¼€æºMCPæœåŠ¡å™¨ï¼Œè®©å¤§æ¨¡å‹å¿«é€Ÿæ¥å…¥æµ·é‡å·¥å…·ï¼Œä»è€Œå¤§å¹…åŠ å¿«Agentå¼€å‘è¿›åº¦ã€‚

![](images/0db9fd66-a616-46d9-92a2-a5fef61c1d41.png)

*

![](images/7f83816a-192f-4c0e-adc0-0051b7cd5a80.png)

&#x20;

![](images/663867c9-5ae1-45de-a2db-9857cb6e682f.png)

&#x20;

![](images/default.png)

&#x20;

![](images/b7128c7c-efac-4f2c-9fea-bc31528fc970.png)

&#x20;

![](images/a93edb66-a491-4218-a958-47785310d80e.png)

### 2. MCPæ™ºèƒ½ä½“å¼€å‘å…¥é—¨é¡¹ç›®

![](images/86cd643f-2d84-41b6-b2b0-1116f7b4fb69.png)

&#x20;

![](images/05bb3636-fa75-4bfc-b136-67b1f52f5a49.png)

## äºŒã€GraphRAGåŸºäºçŸ¥è¯†å›¾è°±çš„æ£€ç´¢å¢å¼ºæŠ€æœ¯

![](images/4e25b1e2-a671-4b46-94a4-4b5f70ba98a7.png)

![](images/07ac16b6-8c0c-47f0-9c14-47670e58d83c.png)

### 1.GraphRAGå…¥é—¨ä»‹ç»

â€ƒâ€ƒ**æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰** æ˜¯ä¸€ç§é€šè¿‡ç»“åˆçœŸå®ä¸–ç•Œçš„ä¿¡æ¯æ¥æå‡å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰è¾“å‡ºè´¨é‡çš„æŠ€æœ¯ã€‚RAG æŠ€æœ¯æ˜¯å¤§å¤šæ•°åŸºäº LLM çš„å·¥å…·ä¸­çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ã€‚å¤§å¤šæ•° RAG æ–¹æ³•ä½¿ç”¨ **å‘é‡ç›¸ä¼¼æ€§** ä½œä¸ºæ£€ç´¢æŠ€æœ¯ï¼Œæˆ‘ä»¬å°†å…¶ç§°ä¸º **åŸºçº¿ RAGï¼ˆBaseline RAGï¼‰**ã€‚

â€ƒâ€ƒRAG æŠ€æœ¯åœ¨å¸®åŠ© LLM æ¨ç†ç§æœ‰æ•°æ®é›†æ–¹é¢æ˜¾ç¤ºäº†å¾ˆå¤§çš„æ½œåŠ›â€”â€”ä¾‹å¦‚ï¼ŒLLM æ²¡æœ‰åœ¨è®­ç»ƒæ—¶æ¥è§¦è¿‡çš„ã€ä¼ä¸šçš„ä¸“æœ‰ç ”ç©¶ã€ä¸šåŠ¡æ–‡æ¡£æˆ–é€šä¿¡æ•°æ®ã€‚åŸºçº¿ RAG æŠ€æœ¯æœ€åˆæ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œæå‡ºçš„ï¼Œä½†æˆ‘ä»¬è§‚å¯Ÿåˆ°ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒåŸºçº¿ RAG çš„è¡¨ç°å¹¶ä¸ç†æƒ³ã€‚ä»¥ä¸‹æ˜¯å‡ ä¸ªå…¸å‹çš„åœºæ™¯ï¼š

1. **åŸºçº¿ RAG å¾ˆéš¾å°†ä¿¡æ¯ä¸²è”èµ·æ¥**ï¼šå½“ä¸€ä¸ªé—®é¢˜çš„ç­”æ¡ˆéœ€è¦é€šè¿‡å¤šä¸ªä¸åŒçš„ä¿¡æ¯ç‰‡æ®µï¼Œå¹¶é€šè¿‡å®ƒä»¬å…±äº«çš„å±æ€§æ¥è¿æ¥ï¼Œè¿›è€Œæä¾›æ–°çš„ç»¼åˆè§è§£æ—¶ï¼ŒåŸºçº¿ RAG è¡¨ç°å¾—å¾ˆå·®ã€‚

2. ä¾‹å¦‚ï¼Œåœ¨å›ç­”ç±»ä¼¼â€œå¦‚ä½•é€šè¿‡ç°æœ‰çš„æ•°æ®æ¨æ–­å‡ºæ–°ç»“è®ºâ€è¿™ç§é—®é¢˜æ—¶ï¼ŒåŸºçº¿ RAG æ— æ³•å¾ˆå¥½åœ°å¤„ç†è¿™äº›æ•£å¸ƒåœ¨ä¸åŒæ–‡æ¡£ä¸­çš„ç›¸å…³ä¿¡æ¯ï¼Œå®ƒå¯èƒ½ä¼šé—æ¼ä¸€äº›å…³é”®è”ç³»ç‚¹ã€‚

3. **åŸºçº¿ RAG æ— æ³•æœ‰æ•ˆç†è§£å¤§å‹æ•°æ®é›†æˆ–å•ä¸€å¤§æ–‡æ¡£çš„æ•´ä½“è¯­ä¹‰æ¦‚å¿µ**ï¼šå½“è¢«è¦æ±‚åœ¨å¤§é‡æ•°æ®æˆ–å¤æ‚æ–‡æ¡£ä¸­è¿›è¡Œæ€»ç»“ã€æç‚¼å’Œç†è§£æ—¶ï¼ŒåŸºçº¿ RAG å¾€å¾€è¡¨ç°ä¸ä½³ã€‚

4. ä¾‹å¦‚ï¼Œå¦‚æœé—®é¢˜è¦æ±‚å¯¹æ•´ä¸ªæ–‡æ¡£æˆ–å¤šç¯‡æ–‡æ¡£çš„ä¸»é¢˜è¿›è¡Œæ€»ç»“å’Œç†è§£ï¼ŒåŸºçº¿ RAG çš„ç®€å•å‘é‡æ£€ç´¢æ–¹æ³•å¯èƒ½æ— æ³•å¤„ç†æ–‡æ¡£é—´çš„å¤æ‚å…³ç³»ï¼Œå¯¼è‡´å¯¹å…¨å±€è¯­ä¹‰çš„ç†è§£ä¸å®Œæ•´ã€‚

â€ƒâ€ƒä¸ºäº†åº”å¯¹è¿™äº›æŒ‘æˆ˜ï¼ŒæŠ€æœ¯ç¤¾åŒºæ­£åœ¨åŠªåŠ›å¼€å‘æ‰©å±•å’Œå¢å¼º RAG çš„æ–¹æ³•ã€‚**å¾®è½¯ç ”ç©¶é™¢**ï¼ˆMicrosoft Researchï¼‰æå‡ºçš„ **GraphRAG** æ–¹æ³•ï¼Œä½¿ç”¨ **LLM** åŸºäºè¾“å…¥è¯­æ–™åº“æ„å»º **çŸ¥è¯†å›¾è°±**ã€‚è¿™ä¸ªå›¾è°±ä¸ç¤¾åŒºæ€»ç»“å’Œå›¾è°±æœºå™¨å­¦ä¹ è¾“å‡ºç»“åˆï¼Œèƒ½å¤Ÿåœ¨æŸ¥è¯¢æ—¶å¢å¼ºæç¤ºï¼ˆpromptï¼‰ã€‚GraphRAG åœ¨å›ç­”ä»¥ä¸Šä¸¤ç±»é—®é¢˜æ—¶ï¼Œå±•ç¤ºäº† **æ˜¾è‘—çš„æ”¹è¿›**ï¼Œå°¤å…¶æ˜¯åœ¨ **å¤æ‚ä¿¡æ¯çš„æ¨ç†èƒ½åŠ›** å’Œ **æ™ºèƒ½æ€§** ä¸Šï¼Œè¶…è¶Šäº†åŸºçº¿ RAG ä¹‹å‰åº”ç”¨äºç§æœ‰æ•°æ®é›†çš„å…¶ä»–æ–¹æ³•ã€‚

![](images/fbaf577d-65fb-4507-8881-f68b38c606ca.png)

### 2.GraphRAGåŸºæœ¬åŸç†å›é¡¾

&#x20;       **GraphRAG** æ˜¯å¾®è½¯ç ”ç©¶é™¢å¼€å‘çš„ä¸€ç§å…ˆè¿›çš„å¢å¼ºæ£€ç´¢ç”Ÿæˆï¼ˆRAGï¼‰æ¡†æ¶ï¼Œæ—¨åœ¨æå‡è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰åœ¨å¤„ç†å¤æ‚æ•°æ®æ—¶çš„æ€§èƒ½ã€‚ä¸ä¼ ç»Ÿçš„ RAG æ–¹æ³•ä¾èµ–å‘é‡ç›¸ä¼¼æ€§æ£€ç´¢ä¸åŒï¼Œ**GraphRAG** åˆ©ç”¨ **çŸ¥è¯†å›¾è°±** æ¥æ˜¾è‘—å¢å¼ºè¯­è¨€æ¨¡å‹çš„é—®ç­”èƒ½åŠ›ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†ç§æœ‰æ•°æ®é›†æˆ–å¤§å‹ã€å¤æ‚æ•°æ®é›†æ—¶è¡¨ç°å°¤ä¸ºå‡ºè‰²ã€‚

![](images/86cd643f-2d84-41b6-b2b0-1116f7b4fb69-1.png)

â€ƒâ€ƒä¼ ç»Ÿçš„ **Baseline RAG** æ–¹æ³•åœ¨æŸäº›æƒ…å†µä¸‹è¡¨ç°ä¸ä½³ï¼Œå°¤å…¶æ˜¯å½“æŸ¥è¯¢éœ€è¦åœ¨ä¸åŒä¿¡æ¯ç‰‡æ®µä¹‹é—´å»ºç«‹è”ç³»æ—¶ï¼Œæˆ–æ˜¯å½“éœ€è¦å¯¹å¤§è§„æ¨¡æ•°æ®é›†è¿›è¡Œæ•´ä½“ç†è§£æ—¶ã€‚GraphRAG é€šè¿‡ä»¥ä¸‹æ–¹å¼å…‹æœäº†è¿™äº›é—®é¢˜ï¼š

* **æ›´å¥½çš„è¿æ¥ä¿¡æ¯ç‚¹**ï¼šGraphRAG èƒ½å¤Ÿå¤„ç†é‚£äº›éœ€è¦ä»å¤šä¸ªæ•°æ®ç‚¹åˆæˆæ–°è§è§£çš„ä»»åŠ¡ã€‚

* **æ›´å…¨é¢çš„ç†è§£èƒ½åŠ›**ï¼šGraphRAG æ›´æ“…é•¿å¯¹å¤§å‹æ•°æ®é›†è¿›è¡Œå…¨é¢ç†è§£ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°å¤„ç†å¤æ‚çš„æŠ½è±¡é—®é¢˜ã€‚

â€ƒâ€ƒè€Œå€ŸåŠ©å¾®è½¯å¼€æºçš„GeaphRAGé¡¹ç›®ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿåšåˆ°ä»¥ä¸‹äº‹é¡¹ï¼š

* **åŸºäºå›¾çš„æ£€ç´¢**ï¼šä¼ ç»Ÿçš„ RAG æ–¹æ³•ä½¿ç”¨å‘é‡ç›¸ä¼¼æ€§è¿›è¡Œæ£€ç´¢ï¼Œè€Œ GraphRAG å¼•å…¥äº†çŸ¥è¯†å›¾è°±æ¥æ•æ‰å®ä½“ã€å…³ç³»åŠå…¶ä»–é‡è¦å…ƒæ•°æ®ï¼Œä»è€Œæ›´æœ‰æ•ˆåœ°è¿›è¡Œæ¨ç†ã€‚

* **å±‚æ¬¡èšç±»**ï¼šGraphRAG ä½¿ç”¨ **Leiden** æŠ€æœ¯è¿›è¡Œå±‚æ¬¡èšç±»ï¼Œå°†å®ä½“åŠå…¶å…³ç³»è¿›è¡Œç»„ç»‡ï¼Œæä¾›æ›´ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯æ¥å¤„ç†å¤æ‚çš„æŸ¥è¯¢ã€‚

* **å¤šæ¨¡å¼æŸ¥è¯¢**ï¼šæ”¯æŒå¤šç§æŸ¥è¯¢æ¨¡å¼ï¼š

  * **å…¨å±€æœç´¢**ï¼šé€šè¿‡åˆ©ç”¨ç¤¾åŒºæ€»ç»“æ¥è¿›è¡Œå…¨å±€æ€§æ¨ç†ã€‚

  * **å±€éƒ¨æœç´¢**ï¼šé€šè¿‡æ‰©å±•ç›¸å…³å®ä½“çš„é‚»å±…å’Œå…³è”æ¦‚å¿µæ¥è¿›è¡Œå…·ä½“å®ä½“çš„æ¨ç†ã€‚

  * **DRIFT æœç´¢**ï¼šç»“åˆå±€éƒ¨æœç´¢å’Œç¤¾åŒºä¿¡æ¯ï¼Œæä¾›æ›´å‡†ç¡®å’Œç›¸å…³çš„ç­”æ¡ˆã€‚

* **å›¾æœºå™¨å­¦ä¹ **ï¼šé›†æˆäº†å›¾æœºå™¨å­¦ä¹ æŠ€æœ¯ï¼Œæå‡æŸ¥è¯¢å“åº”è´¨é‡ï¼Œå¹¶æä¾›æ¥è‡ªç»“æ„åŒ–å’Œéç»“æ„åŒ–æ•°æ®çš„æ·±åº¦æ´å¯Ÿã€‚

* **Prompt è°ƒä¼˜**ï¼šæä¾›è°ƒä¼˜å·¥å…·ï¼Œå¸®åŠ©æ ¹æ®ç‰¹å®šæ•°æ®å’Œéœ€æ±‚è°ƒæ•´æŸ¥è¯¢æç¤ºï¼Œä»è€Œæé«˜ç»“æœè´¨é‡ã€‚

### 3. GraphRAGè¿è¡Œæµç¨‹

#### 3.1 **ç´¢å¼•ï¼ˆIndexingï¼‰è¿‡ç¨‹**

1. **æ–‡æœ¬å•å…ƒåˆ‡åˆ†**ï¼šå°†è¾“å…¥æ–‡æœ¬åˆ†å‰²æˆ **TextUnits**ï¼Œæ¯ä¸ª TextUnit æ˜¯ä¸€ä¸ªå¯åˆ†æçš„å•å…ƒï¼Œç”¨äºæå–å…³é”®ä¿¡æ¯ã€‚

2. **å®ä½“å’Œå…³ç³»æå–**ï¼šä½¿ç”¨ LLM ä» TextUnits ä¸­æå–å®ä½“ã€å…³ç³»å’Œå…³é”®å£°æ˜ã€‚

3. **å›¾æ„å»º**ï¼šæ„å»ºçŸ¥è¯†å›¾è°±ï¼Œä½¿ç”¨ Leiden ç®—æ³•è¿›è¡Œå®ä½“çš„å±‚æ¬¡èšç±»ã€‚æ¯ä¸ªå®ä½“ç”¨èŠ‚ç‚¹è¡¨ç¤ºï¼ŒèŠ‚ç‚¹çš„å¤§å°å’Œé¢œè‰²åˆ†åˆ«ä»£è¡¨å®ä½“çš„åº¦æ•°å’Œæ‰€å±ç¤¾åŒºã€‚

4. **ç¤¾åŒºæ€»ç»“**ï¼šä»ä¸‹åˆ°ä¸Šç”Ÿæˆæ¯ä¸ªç¤¾åŒºåŠå…¶æˆå‘˜çš„æ€»ç»“ï¼Œå¸®åŠ©å…¨å±€ç†è§£æ•°æ®é›†ã€‚

#### 3.2 **æŸ¥è¯¢ï¼ˆQueryï¼‰è¿‡ç¨‹**

ç´¢å¼•å®Œæˆåï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä¸åŒçš„æœç´¢æ¨¡å¼è¿›è¡ŒæŸ¥è¯¢ï¼š

* **å…¨å±€æœç´¢**ï¼šå½“æˆ‘ä»¬æƒ³äº†è§£æ•´ä¸ªè¯­æ–™åº“æˆ–æ•°æ®é›†çš„æ•´ä½“æ¦‚å†µæ—¶ï¼ŒGraphRAG å¯ä»¥åˆ©ç”¨ ç¤¾åŒºæ€»ç»“ æ¥å¿«é€Ÿæ¨ç†å’Œè·å–ä¿¡æ¯ã€‚è¿™ç§æ–¹å¼é€‚ç”¨äºå¤§èŒƒå›´é—®é¢˜ï¼Œå¦‚æŸä¸ªä¸»é¢˜çš„æ€»ä½“ç†è§£ã€‚

* **å±€éƒ¨æœç´¢**ï¼šå¦‚æœé—®é¢˜å…³æ³¨äºæŸä¸ªç‰¹å®šçš„å®ä½“ï¼ŒGraphRAG ä¼šå‘è¯¥å®ä½“çš„ é‚»å±…ï¼ˆå³ç›¸å…³å®ä½“ï¼‰æ‰©å±•æœç´¢ï¼Œä»¥è·å¾—æ›´è¯¦ç»†å’Œç²¾å‡†çš„ç­”æ¡ˆã€‚

* **DRIFT æœç´¢**ï¼šè¿™æ˜¯å¯¹å±€éƒ¨æœç´¢çš„å¢å¼ºï¼Œé™¤äº†è·å–é‚»å±…å’Œç›¸å…³æ¦‚å¿µï¼Œè¿˜å¼•å…¥äº† ç¤¾åŒºä¿¡æ¯ çš„ä¸Šä¸‹æ–‡ï¼Œä»è€Œæä¾›æ›´æ·±å…¥çš„æ¨ç†å’Œè¿æ¥ã€‚

#### 3.3 **Prompt è°ƒä¼˜**

ä¸ºäº†è·å¾—æœ€ä½³æ€§èƒ½ï¼ŒGraphRAG å¼ºçƒˆå»ºè®®è¿›è¡Œ **Prompt è°ƒä¼˜**ï¼Œç¡®ä¿æ¨¡å‹å¯ä»¥æ ¹æ®ä½ çš„ç‰¹å®šæ•°æ®å’ŒæŸ¥è¯¢éœ€æ±‚è¿›è¡Œä¼˜åŒ–ï¼Œä»è€Œæä¾›æ›´å‡†ç¡®å’Œç›¸å…³çš„ç­”æ¡ˆã€‚

#### 3.4 GraphRAGè®¡ç®—æµç¨‹æç®€ç¤ºä¾‹

![](images/efe582b0-d289-4829-8ce5-15d7b2275e99.png)

### 4.GraphRAGå®‰è£…ä¸Indexing\&Queryæµç¨‹å®ç°

æ³¨æ„ï¼Œä»¥ä¸‹å†…å®¹åœ¨Jupyterä¸­é€šè¿‡ä»£ç å®Œæˆï¼Œæ‰«ç å³å¯é¢†å–è¯¾ä»¶ä»£ç ã€‚

![](images/0961685a-0d40-417d-ad02-ed120d1533d0.png)

&#x20;

![](images/b7128c7c-efac-4f2c-9fea-bc31528fc970-1.png)

### 5.GraphRAG APIä½¿ç”¨æ–¹æ³•

![](images/ee7bfa76-45b6-40d7-8abb-cfc71ea11fdd.png)

## ä¸‰ã€MCP+GraphRAGæ­å»ºæ£€ç´¢å¢å¼ºæ™ºèƒ½ä½“

&#x20;       æ¥ä¸‹æ¥å³å¯æ ¹æ®GraphRAG APIçš„è°ƒç”¨æ–¹æ³•ï¼Œæ¥åˆ›å»ºä¸€ä¸ªåŸºäºGraphRAGçš„MCPæ™ºèƒ½ä½“æœåŠ¡å™¨ï¼Œå¹¶å°è¯•åœ¨æœ¬åœ°clientå¯¹å…¶è¿›è¡Œè°ƒç”¨ã€‚

### 1.MCP+GraphRAGé¡¹ç›®ç¯å¢ƒæ­å»º

#### 1.1 åˆ›å»º MCP å®¢æˆ·ç«¯é¡¹ç›®

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
uv init mcp-graphrag
cd mcp-graphrag
```

![](images/d62bf423-57e3-4c4f-bbb4-f2ede273ed6b.png)

&#x20;

![](images/d53363bd-3260-4b2d-9dc6-2ac765132169.png)

#### 1.2 åˆ›å»ºMCPå®¢æˆ·ç«¯è™šæ‹Ÿç¯å¢ƒ

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
uv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate
```

![](images/47543e4f-c4c6-46f8-b823-550d7b1018f0.png)

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›¸æ¯”pipï¼Œuvä¼šè‡ªåŠ¨è¯†åˆ«å½“å‰é¡¹ç›®ä¸»ç›®å½•å¹¶åˆ›å»ºè™šæ‹Ÿç¯å¢ƒã€‚

ç„¶åå³å¯é€šè¿‡addæ–¹æ³•åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…ç›¸å…³çš„åº“ã€‚

```bash
# å®‰è£… MCP SDK
uv add mcp graphrag pathlib pandas
```

![](images/6808b832-fc44-421d-8e2a-f6d795fbf1a9.png)

#### 1.3 åˆ›å»ºGraphRAGå¹¶æ„å»ºç´¢å¼•ï¼ˆIndexï¼‰

* åˆ›å»ºé¡¹ç›®ç›®å½•å¹¶è¿›è¡Œåˆå§‹åŒ–

```bash
mkdir -p ./graphrag/input
graphrag init --root ./graphrag
```

![](images/0af0428e-ddce-497e-bba8-d865a59823a8.png)

* ä¿®æ”¹é…ç½®æ–‡ä»¶

æ‰“å¼€.envæ–‡ä»¶ï¼Œå¡«å†™DeepSeek API-KEYæˆ–OpenAI API-Key

![](images/e41f5c94-c225-47fd-be87-55937f2c063b.png)

æ‰“å¼€setting.yamlæ–‡ä»¶ï¼Œå¡«å†™æ¨¡å‹åç§°å’Œä»£ç†åœ°å€ï¼š

![](images/fffecc94-d30b-4f13-a0f1-4080518f7d81.png)

* ä¸Šä¼ æ–‡æœ¬æ•°æ®

![](images/825f7430-b27e-495d-a33c-e5313af573ec.png)

* indexè¿‡ç¨‹

```bash
graphrag index --root ./graphrag
```

![](images/b87da255-f538-4837-afa3-ccd0177f8bd7.png)

### 2.åˆ›å»ºGraphRAGæœåŠ¡å™¨Server

&#x20;       è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå½“å‰åˆ›å»ºçš„GraphRAG Serveråªè´Ÿè´£è¿›è¡Œå¯¹æŸä¸€ä¸ªå®ŒæˆIndexçš„çŸ¥è¯†åº“è¿›è¡ŒQueryï¼Œæ›´åŠ å¤æ‚çš„å¦‚æ–‡ä»¶ç®¡ç†ã€å®æ—¶å¢åŠ æ£€ç´¢ã€å¤šæ–‡ä»¶åº“æ£€ç´¢ç­‰ï¼Œè¯¦è§2025å¤§æ¨¡å‹Agentæ™ºèƒ½ä½“å¼€å‘å®æˆ˜ã€‹ï¼ˆæ˜¥å­£ç­ï¼‰https://whakv.xetslk.com/s/pxKHGå†…å®¹ä»‹ç»ã€‚

![](images/1270ec0d-9442-47bf-b8e3-4af376f3ba90-1.jpeg)

&#x20;

![](images/399b5dc3-2066-485b-a9a6-3f156d497c72.png)

&#x20;

![](images/1536b607-9c9c-4010-954b-a7aefab8568f.jpeg)

è¿™é‡Œæˆ‘ä»¬åœ¨å½“å‰é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºrag\_server.pyçš„serverï¼Œ

![](images/a0842c3d-9f71-4c04-9778-86e03a30dd50.png)

å¹¶å†™å…¥å¦‚ä¸‹ä»£ç ï¼š

```python
from pathlib import Path
from pprint import pprint

import pandas as pd

import graphrag.api as api
from graphrag.config.load_config import load_config
from graphrag.index.typing.pipeline_run_result import PipelineRunResult

from typing import Any
from mcp.server.fastmcp import FastMCP

# åˆå§‹åŒ– MCP æœåŠ¡å™¨
mcp = FastMCP("rag_ML")
USER_AGENT = "rag_ML-app/1.0"

@mcp.tool()
async def rag_ML(query: str) -> str:
    """
    ç”¨äºæŸ¥è¯¢æœºå™¨å­¦ä¹ å†³ç­–æ ‘ç›¸å…³ä¿¡æ¯ã€‚
    :param query: ç”¨æˆ·æå‡ºçš„å…·ä½“é—®é¢˜
    :return: æœ€ç»ˆè·å¾—çš„ç­”æ¡ˆ
    """
    PROJECT_DIRECTORY = "/root/autodl-tmp/MCP/mcp-graphrag/graphrag"
    graphrag_config = load_config(Path(PROJECT_DIRECTORY))
    
    # åŠ è½½å®ä½“
    entities = pd.read_parquet(f"{PROJECT_DIRECTORY}/output/entities.parquet")
    # åŠ è½½ç¤¾åŒº
    communities = pd.read_parquet(f"{PROJECT_DIRECTORY}/output/communities.parquet")
    # åŠ è½½ç¤¾åŒºæŠ¥å‘Š
    community_reports = pd.read_parquet(
        f"{PROJECT_DIRECTORY}/output/community_reports.parquet"
    )
    # è¿›è¡Œå…¨å±€æœç´¢
    response, context = await api.global_search(
        config=graphrag_config,
        entities=entities,
        communities=communities,
        community_reports=community_reports,
        community_level=2,
        dynamic_community_selection=False,
        response_type="Multiple Paragraphs",
        query=query,
    )
    
    return response

if __name__ == "__main__":
    # ä»¥æ ‡å‡† I/O æ–¹å¼è¿è¡Œ MCP æœåŠ¡å™¨
    mcp.run(transport='stdio')
```

**ä»£ç è§£é‡Šå¦‚ä¸‹ï¼š**

1. **å¯¼å…¥å¿…è¦çš„æ¨¡å—å’Œåº“ï¼š**

   * `Path` å’Œ `pprint`ï¼šç”¨äºè·¯å¾„æ“ä½œå’Œç¾åŒ–æ‰“å°è¾“å‡ºã€‚

   * `pandas`ï¼šç”¨äºæ•°æ®å¤„ç†ï¼Œç‰¹åˆ«æ˜¯è¯»å– Parquet æ ¼å¼çš„æ•°æ®æ–‡ä»¶ã€‚

   * `graphrag.api` å’Œç›¸å…³é…ç½®æ¨¡å—ï¼šç”¨äºåŠ è½½é…ç½®å’Œè°ƒç”¨ GraphRAG çš„ APIã€‚

   * `FastMCP`ï¼šMCP åè®®çš„å¿«é€Ÿå®ç°ï¼Œç”¨äºåˆ›å»º MCP æœåŠ¡å™¨ã€‚

2. **åˆå§‹åŒ– MCP æœåŠ¡å™¨ï¼š**

   * `mcp = FastMCP("rag_ML")`ï¼šåˆ›å»ºä¸€ä¸ªåä¸º `rag_ML` çš„ MCP æœåŠ¡å™¨å®ä¾‹ã€‚

   * `USER_AGENT = "rag_ML-app/1.0"`ï¼šå®šä¹‰ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²ï¼Œå¯èƒ½ç”¨äºæ ‡è¯†å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºçš„ç‰ˆæœ¬ä¿¡æ¯ã€‚

3. **å®šä¹‰å·¥å…·å‡½æ•° `rag_ML`ï¼š**

   * ä½¿ç”¨è£…é¥°å™¨ `@mcp.tool()` å°†å‡½æ•°æ³¨å†Œä¸º MCP å·¥å…·ï¼Œä½¿å…¶å¯è¢«å®¢æˆ·ç«¯è°ƒç”¨ã€‚îˆ†

   * å‡½æ•°ä¸ºå¼‚æ­¥å‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„ `query` å‚æ•°ï¼Œè¡¨ç¤ºç”¨æˆ·çš„æŸ¥è¯¢ã€‚

   * å‡½æ•°å†…éƒ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

     * åŠ è½½ GraphRAG é…ç½®ï¼š

       * `PROJECT_DIRECTORY`ï¼šå®šä¹‰é¡¹ç›®ç›®å½•è·¯å¾„ã€‚

       * `graphrag_config = load_config(Path(PROJECT_DIRECTORY))`ï¼šåŠ è½½ GraphRAG çš„é…ç½®æ–‡ä»¶ã€‚

     * åŠ è½½æ•°æ®æ–‡ä»¶ï¼š

       * ä½¿ç”¨ `pandas` çš„ `read_parquet` æ–¹æ³•åˆ†åˆ«åŠ è½½å®ä½“ã€ç¤¾åŒºå’Œç¤¾åŒºæŠ¥å‘Šçš„ Parquet æ–‡ä»¶ã€‚

     * è°ƒç”¨

     ```plaintext
     api.global_search
     ```

     * æ–¹æ³•è¿›è¡Œå…¨å±€æœç´¢ï¼š

       * ä¼ å…¥é…ç½®ã€å®ä½“ã€ç¤¾åŒºå’Œç¤¾åŒºæŠ¥å‘Šç­‰å‚æ•°ã€‚

       * è®¾ç½® `community_level=2` å’Œ `dynamic_community_selection=False`ï¼Œç”¨äºæ§åˆ¶ç¤¾åŒºå±‚çº§å’Œæ˜¯å¦åŠ¨æ€é€‰æ‹©ç¤¾åŒºã€‚

       * è®¾ç½® `response_type="Multiple Paragraphs"`ï¼ŒæŒ‡å®šå“åº”ç±»å‹ä¸ºå¤šæ®µè½æ–‡æœ¬ã€‚

     * è¿”å›æœç´¢ç»“æœ `response`ã€‚

4. **è¿è¡Œ MCP æœåŠ¡å™¨ï¼š**

   * åœ¨ä¸»ç¨‹åºä¸­ï¼Œè°ƒç”¨ `mcp.run(transport='stdio')` ä»¥æ ‡å‡†è¾“å…¥è¾“å‡ºï¼ˆ`stdio`ï¼‰çš„æ–¹å¼è¿è¡Œ MCP æœåŠ¡å™¨ï¼Œä½¿å…¶èƒ½å¤Ÿæ¥æ”¶å’Œå“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚

![](images/b7128c7c-efac-4f2c-9fea-bc31528fc970-2.png)

### 3.åˆ›å»ºGraphRAGæœåŠ¡å™¨client

æ¥ä¸‹æ¥ç»§ç»­åˆ›å»ºå®¢æˆ·ç«¯ï¼Œåœ¨é¡¹ç›®ä¸»ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`client.py`çš„å®¢æˆ·ç«¯ï¼Œ

![](images/4d0d4115-daf9-498a-9f59-81c022313c2c.png)

å¹¶å†™å…¥å¦‚ä¸‹ä»£ç ï¼š

```python
import asyncio
import os
import json
from typing import Optional
from contextlib import AsyncExitStack

from openai import OpenAI  
from dotenv import load_dotenv

from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client

# åŠ è½½ .env æ–‡ä»¶ï¼Œç¡®ä¿ API Key å—åˆ°ä¿æŠ¤
load_dotenv()

class MCPClient:
    def __init__(self):
        """åˆå§‹åŒ– MCP å®¢æˆ·ç«¯"""
        self.exit_stack = AsyncExitStack()
        self.openai_api_key = os.getenv("OPENAI_API_KEY")  # è¯»å– OpenAI API Key
        self.base_url = os.getenv("BASE_URL")  # è¯»å– BASE YRL
        self.model = os.getenv("MODEL")  # è¯»å– model
        if not self.openai_api_key:
            raise ValueError("âŒ æœªæ‰¾åˆ° OpenAI API Keyï¼Œè¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® OPENAI_API_KEY")
        self.client = OpenAI(api_key=self.openai_api_key, base_url=self.base_url) # åˆ›å»ºOpenAI client
        self.session: Optional[ClientSession] = None   

    async def transform_json(self, json2_data):
        """
        å°†Claude Function callingå‚æ•°æ ¼å¼è½¬æ¢ä¸ºOpenAI Function callingå‚æ•°æ ¼å¼ï¼Œå¤šä½™å­—æ®µä¼šè¢«ç›´æ¥åˆ é™¤ã€‚
        
        :param json2_data: ä¸€ä¸ªå¯è¢«è§£é‡Šä¸ºåˆ—è¡¨çš„ Python å¯¹è±¡ï¼ˆæˆ–å·²è§£æçš„ JSON æ•°æ®ï¼‰
        :return: è½¬æ¢åçš„æ–°åˆ—è¡¨
        """
        result = []
        
        for item in json2_data:
            # ç¡®ä¿æœ‰ "type" å’Œ "function" ä¸¤ä¸ªå…³é”®å­—æ®µ
            if not isinstance(item, dict) or "type" not in item or "function" not in item:
                continue
        
            old_func = item["function"]
        
            # ç¡®ä¿ function ä¸‹æœ‰æˆ‘ä»¬éœ€è¦çš„å…³é”®å­å­—æ®µ
            if not isinstance(old_func, dict) or "name" not in old_func or "description" not in old_func:
                continue
        
            # å¤„ç†æ–° function å­—æ®µ
            new_func = {
                "name": old_func["name"],
                "description": old_func["description"],
                "parameters": {}
            }
        
            # è¯»å– input_schema å¹¶è½¬æˆ parameters
            if "input_schema" in old_func and isinstance(old_func["input_schema"], dict):
                old_schema = old_func["input_schema"]
                
                # æ–°çš„ parameters ä¿ç•™ type, properties, required è¿™ä¸‰ä¸ªå­—æ®µ
                new_func["parameters"]["type"] = old_schema.get("type", "object")
                new_func["parameters"]["properties"] = old_schema.get("properties", {})
                new_func["parameters"]["required"] = old_schema.get("required", [])
            
            new_item = {
                "type": item["type"],
                "function": new_func
            }
        
            result.append(new_item)
    
        return result

    async def connect_to_server(self, server_script_path: str):
        """è¿æ¥åˆ° MCP æœåŠ¡å™¨å¹¶åˆ—å‡ºå¯ç”¨å·¥å…·"""
        is_python = server_script_path.endswith('.py')
        is_js = server_script_path.endswith('.js')
        if not (is_python or is_js):
            raise ValueError("æœåŠ¡å™¨è„šæœ¬å¿…é¡»æ˜¯ .py æˆ– .js æ–‡ä»¶")

        command = "python" if is_python else "node"
        server_params = StdioServerParameters(
            command=command,
            args=[server_script_path],
            env=None
        )

        # å¯åŠ¨ MCP æœåŠ¡å™¨å¹¶å»ºç«‹é€šä¿¡
        stdio_transport = await self.exit_stack.enter_async_context(stdio_client(server_params))
        self.stdio, self.write = stdio_transport
        self.session = await self.exit_stack.enter_async_context(ClientSession(self.stdio, self.write))

        await self.session.initialize()

        # åˆ—å‡º MCP æœåŠ¡å™¨ä¸Šçš„å·¥å…·
        response = await self.session.list_tools()
        tools = response.tools
        print("\nå·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œæ”¯æŒä»¥ä¸‹å·¥å…·:", [tool.name for tool in tools])     
        
    async def process_query(self, query: str) -> str:
        """
        ä½¿ç”¨å¤§æ¨¡å‹å¤„ç†æŸ¥è¯¢å¹¶è°ƒç”¨å¯ç”¨çš„ MCP å·¥å…· (Function Calling)
        """
        messages = [{"role": "user", "content": query}]
        
        response = await self.session.list_tools()
        
        available_tools = [{
            "type": "function",
            "function": {
                "name": tool.name,
                "description": tool.description,
                "input_schema": tool.inputSchema
            }
        } for tool in response.tools]
        # print(available_tools)

        # è¿›è¡Œå‚æ•°æ ¼å¼è½¬åŒ–
        available_tools = await self.transform_json(available_tools)
        
        response = self.client.chat.completions.create(
            model=self.model,            
            messages=messages,
            tools=available_tools     
        )
        
        # å¤„ç†è¿”å›çš„å†…å®¹
        content = response.choices[0]
        if content.finish_reason == "tool_calls":
            # å¦‚ä½•æ˜¯éœ€è¦ä½¿ç”¨å·¥å…·ï¼Œå°±è§£æå·¥å…·
            tool_call = content.message.tool_calls[0]
            tool_name = tool_call.function.name
            tool_args = json.loads(tool_call.function.arguments)
            
            # æ‰§è¡Œå·¥å…·
            result = await self.session.call_tool(tool_name, tool_args)
            print(f"\n\n[Calling tool {tool_name} with args {tool_args}]\n\n")
            
            # å°†æ¨¡å‹è¿”å›çš„è°ƒç”¨å“ªä¸ªå·¥å…·æ•°æ®å’Œå·¥å…·æ‰§è¡Œå®Œæˆåçš„æ•°æ®éƒ½å­˜å…¥messagesä¸­
            messages.append(content.message.model_dump())
            messages.append({
                "role": "tool",
                "content": result.content[0].text,
                "tool_call_id": tool_call.id,
            })
            
            # å°†ä¸Šé¢çš„ç»“æœå†è¿”å›ç»™å¤§æ¨¡å‹ç”¨äºç”Ÿäº§æœ€ç»ˆçš„ç»“æœ
            response = self.client.chat.completions.create(
                model=self.model,
                messages=messages,
            )
            return response.choices[0].message.content
            
        return content.message.content
    
    async def chat_loop(self):
        """è¿è¡Œäº¤äº’å¼èŠå¤©å¾ªç¯"""
        print("\nğŸ¤– MCP å®¢æˆ·ç«¯å·²å¯åŠ¨ï¼è¾“å…¥ 'quit' é€€å‡º")

        while True:
            try:
                query = input("\nä½ : ").strip()
                if query.lower() == 'quit':
                    break
                
                response = await self.process_query(query)  # å‘é€ç”¨æˆ·è¾“å…¥åˆ° OpenAI API
                print(f"\nğŸ¤– OpenAI: {response}")

            except Exception as e:
                print(f"\nâš ï¸ å‘ç”Ÿé”™è¯¯: {str(e)}")

    async def cleanup(self):
        """æ¸…ç†èµ„æº"""
        await self.exit_stack.aclose()

async def main():
    if len(sys.argv) < 2:
        print("Usage: python client.py <path_to_server_script>")
        sys.exit(1)

    client = MCPClient()
    try:
        await client.connect_to_server(sys.argv[1])
        await client.chat_loop()
    finally:
        await client.cleanup()

if __name__ == "__main__":
    import sys
    asyncio.run(main())
```

è¿™æ®µä»£ç å®ç°äº†ä¸€ä¸ª **MCP å®¢æˆ·ç«¯**ï¼Œç”¨äºè¿æ¥ MCP æœåŠ¡å™¨ï¼Œå¹¶åˆ©ç”¨ OpenAI çš„ API è¿›è¡Œ Function Callingï¼ˆå‡½æ•°è°ƒç”¨ï¼‰ã€‚è¯¥å®¢æˆ·ç«¯èƒ½å¤Ÿä¸ MCP æœåŠ¡å™¨äº¤äº’ï¼Œåˆ—å‡ºå¯ç”¨å·¥å…·ï¼Œå¹¶æ ¹æ®ç”¨æˆ·è¾“å…¥é€‰æ‹©é€‚å½“çš„å·¥å…·è°ƒç”¨ã€‚

1. **åˆå§‹åŒ–**

* `AsyncExitStack()` å¤„ç†å¤šä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ï¼ˆå¦‚ MCP è¿æ¥ï¼‰ã€‚

* è¯»å– .envé…ç½®ï¼š

  * `OPENAI_API_KEY`

  * `BASE_URL`ï¼ˆå¯é€‰ï¼Œç”¨äºè‡ªå®šä¹‰ API ä»£ç†ï¼‰

  * `MODEL`ï¼ˆæŒ‡å®š OpenAI ä½¿ç”¨çš„æ¨¡å‹ï¼‰

* `self.client = OpenAI(...)` åˆ›å»º OpenAI API å®¢æˆ·ç«¯ã€‚

2. **è½¬æ¢ API æ ¼å¼ (`transform_json`)**

* OpenAI å’Œ Claude API çš„ Function Calling æ ¼å¼ä¸åŒã€‚

* è¯¥å‡½æ•°å°† Claude çš„ `input_schema` è½¬æ¢ä¸º OpenAI å…¼å®¹æ ¼å¼ã€‚

3. **è¿æ¥ MCP æœåŠ¡å™¨**

* è¿æ¥ MCP æœåŠ¡å™¨ï¼Œæ”¯æŒ Python æˆ– JavaScript æœåŠ¡å™¨è„šæœ¬ã€‚

* `stdio_client(server_params)` é€šè¿‡ `stdio` è¿›è¡Œé€šä¿¡ã€‚

* `await self.session.list_tools()` åˆ—å‡º MCP æœåŠ¡å™¨ä¸Šå¯ç”¨çš„å·¥å…·ã€‚

4. **å¤„ç†ç”¨æˆ·æŸ¥è¯¢ (`process_query`)**

* è·å– MCP æœåŠ¡å™¨ä¸Šå¯ç”¨çš„å·¥å…· (`list_tools`)ã€‚

* è®© OpenAI é€‰æ‹©æ˜¯å¦éœ€è¦è°ƒç”¨ MCP æœåŠ¡å™¨ä¸Šçš„å·¥å…· (`tool_calls`)ã€‚

* è‹¥éœ€è¦å·¥å…·è°ƒç”¨ï¼š

  * è§£æ `tool_calls`

  * `call_tool(tool_name, tool_args)` è°ƒç”¨ MCP æœåŠ¡å™¨ä¸Šçš„å·¥å…·

  * å†æ¬¡å‘ OpenAI æäº¤æ–°ä¿¡æ¯ï¼Œè·å–æœ€ç»ˆç­”æ¡ˆ

5. **äº¤äº’å¼èŠå¤© (`chat_loop`)**

* å…è®¸ç”¨æˆ·è¾“å…¥æŸ¥è¯¢ï¼Œè‡ªåŠ¨é€‰æ‹© MCP å·¥å…·æˆ–ç›´æ¥å›ç­”ã€‚

* è¾“å…¥ `quit` é€€å‡ºèŠå¤©ã€‚

ç„¶ååˆ›å»ºé…ç½®æ–‡ä»¶.envï¼š

![](images/265cb252-fbdf-4bec-a4fa-36e8aa877d42.png)

å¹¶æ‰‹åŠ¨è¾“å…¥

```bash
BASE_URL=
MODEL=
OPENAI_API_KEY=
```

![](images/a47c6cee-fe58-48cd-868f-c35102ad5bb0.png)

æ­¤å¤„å¯ä»¥è®¾ç½®OpenAIã€DeepSeekæˆ–è€…ä»»ä½•ollamaã€vLLMè°ƒåº¦çš„æœ¬åœ°æ¨¡å‹ã€‚å…·ä½“é…ç½®æ–¹æ³•å‚è€ƒã€ŠMCPå…¥é—¨å®æˆ˜æ•™ç¨‹ã€‹ã€‚

![](images/b7128c7c-efac-4f2c-9fea-bc31528fc970-3.png)

### 4.MCP+GraphRAGé—®ç­”æµ‹è¯•

#### 4.1 å‘½ä»¤è¡Œé—®ç­”

æœ€åå³å¯å¼€å§‹è¿›è¡Œé—®ç­”æµ‹è¯•ï¼Œåœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥å¦‚ä¸‹å‘½ä»¤å³å¯å¯åŠ¨é—®ç­”ï¼š

```python
uv run client.py rag_server.py
```

é—®ç­”æ•ˆæœå¦‚å›¾æ‰€ç¤ºï¼š

![](images/5e415a41-7bf9-4053-af3a-a9d927d42108.png)

#### 4.2 Claude Desktopé—®ç­”

è¯¦è§2025å¤§æ¨¡å‹Agentæ™ºèƒ½ä½“å¼€å‘å®æˆ˜ã€‹ï¼ˆæ˜¥å­£ç­ï¼‰https://whakv.xetslk.com/s/pxKHGå†…å®¹ä»‹ç»ã€‚

![](images/1270ec0d-9442-47bf-b8e3-4af376f3ba90.jpeg)

&#x20;

![](images/399b5dc3-2066-485b-a9a6-3f156d497c72-1.png)

&#x20;

![](images/172a009f-2cb4-4033-8773-729d43657e15.png)

&#x20;

![](images/3a9be539-8dfb-450a-b3b2-f75a0973a2c5.png)

&#x20;

![](images/1536b607-9c9c-4010-954b-a7aefab8568f-2.jpeg)

***

## å››ã€MCPæ™ºèƒ½ä½“å¼€å‘åŸºç¡€ç†è®ºå…¥é—¨

### 1. çœŸå®ä¸–ç•Œçš„å¤æ‚æ™ºèƒ½ä½“å¼€å‘é¡¹ç›®

#### 1.1 2023å¹´MateGen 1.0ä»£ç ç»“æ„å›¾

![](images/f27ab89f-a6ec-4ceb-b021-000f9802ec0d.png)

#### 1.2 2025å¤§æ¨¡å‹Agentå¼€å‘å®æˆ˜ä»˜è´¹è¯¾ç¨‹ä¼ä¸šé—®ç­”æ™ºèƒ½ä½“é¡¹ç›®æµç¨‹å›¾

![](images/13ac5eb6-abc0-45ee-a549-11e84f108e40.png)

#### 1.3 2025å¤§æ¨¡å‹Agentå¼€å‘å®æˆ˜ä»˜è´¹è¯¾ç¨‹æ™ºèƒ½å®¢æœé¡¹ç›®æµç¨‹å›¾

![](images/bb83cd0d-eaf2-410c-a1f9-e27d9ec106fa.png)

#### 1.4 2025å¤§æ¨¡å‹Agentå¼€å‘å®æˆ˜ä»˜è´¹è¯¾ç¨‹æ™ºèƒ½å¸‚åœºåˆ†æé¡¹ç›®æµç¨‹å›¾

![](images/f6bd4177-8a19-4ad6-9ee3-338f376abfe7.png)

#### 1.5 2025å¤§æ¨¡å‹Agentå¼€å‘å®æˆ˜ä»˜è´¹è¯¾ç¨‹MateGen 2.0é¡¹ç›®æ¶æ„

![](images/4502cff2-c833-4526-9ff6-82ac240f64c2.png)

è¯¦è§2025å¤§æ¨¡å‹Agentæ™ºèƒ½ä½“å¼€å‘å®æˆ˜ã€‹ï¼ˆæ˜¥å­£ç­ï¼‰https://whakv.xetslk.com/s/pxKHGå†…å®¹ä»‹ç»ã€‚

![](images/1270ec0d-9442-47bf-b8e3-4af376f3ba90-2.jpeg)

&#x20;

![](images/1536b607-9c9c-4010-954b-a7aefab8568f-1.jpeg)

### 2. æ™ºèƒ½ä½“å¼€å‘æ¡†æ¶é€‰å‹

12é¡¹Agentæ™ºèƒ½ä½“å¼€å‘æ¡†æ¶å…¥é—¨ä¸é€‰å‹ï¼https://www.bilibili.com/video/BV16NBJYRE3s/

![](images/b861d631-4ccd-4776-a804-565a8cae151a.png)

### 3. ä»é›¶å¿«é€Ÿäº†è§£æ™ºèƒ½ä½“å¼€å‘

&#x20;       åœ¨ä½¿ç”¨ LLM æ„å»ºåº”ç”¨æ—¶ï¼Œæˆ‘ä»¬å»ºè®®**å°½å¯èƒ½é€‰æ‹©æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆ**ï¼Œåªæœ‰åœ¨**ç¡®å®éœ€è¦**æ—¶æ‰å¢åŠ å¤æ‚æ€§ã€‚è¿™æ„å‘³ç€ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½æ ¹æœ¬**ä¸éœ€è¦æ„å»ºä»£ç†ç³»ç»Ÿ**ã€‚

&#x20;       **ä»£ç†ç³»ç»Ÿï¼ˆAgentic Systemsï¼‰\*\*é€šå¸¸ä¼š\*\*ç‰ºç‰²å“åº”é€Ÿåº¦ï¼ˆlatencyï¼‰å’Œæˆæœ¬ï¼ˆcostï¼‰**ï¼Œä»¥æ¢å–æ›´å¥½çš„ä»»åŠ¡æ‰§è¡Œèƒ½åŠ›ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨ä»£ç†ä¹‹å‰ï¼Œä½ éœ€è¦è€ƒè™‘è¿™ç§**æƒè¡¡æ˜¯å¦åˆç†**ã€‚

å½“åº”ç”¨åœºæ™¯**éœ€è¦æ›´å¤æ‚çš„é€»è¾‘**æ—¶ï¼š

* **å·¥ä½œæµï¼ˆWorkflowsï¼‰** æä¾›äº†**å¯é¢„æµ‹æ€§**å’Œ**ä¸€è‡´æ€§**ï¼Œé€‚ç”¨äº**ä»»åŠ¡æµç¨‹æ¸…æ™°çš„æƒ…å†µ**ã€‚

* **ä»£ç†ï¼ˆAgentsï¼‰** æ›´é€‚ç”¨äº**éœ€è¦çµæ´»æ€§å’Œå¤§è§„æ¨¡æ¨¡å‹é©±åŠ¨å†³ç­–**çš„åœºæ™¯ã€‚

ç„¶è€Œï¼Œå¯¹äºè®¸å¤šåº”ç”¨æ¥è¯´ï¼Œ**ä¼˜åŒ–å•æ¬¡ LLM è°ƒç”¨**ï¼ˆä¾‹å¦‚ç»“åˆ**æ£€ç´¢å¢å¼ºï¼ˆRAGï¼‰\*\*å’Œ\*\*ä¸Šä¸‹æ–‡ç¤ºä¾‹ï¼ˆin-context examplesï¼‰**ï¼‰é€šå¸¸å·²ç»è¶³å¤Ÿï¼Œæ— éœ€ä½¿ç”¨å¤æ‚çš„ä»£ç†ç³»ç»Ÿã€‚

&#x20;       åˆ†å‘æ¨¡å¼ï¼šå°†ä»»åŠ¡åˆ†å‘ï¼ˆFan-outï¼‰ç»™å¤šä¸ªå­ä»£ç†ï¼ˆsub-agentsï¼‰ï¼Œç„¶åæ±‡æ€»ï¼ˆFan-inï¼‰ç»“æœã€‚æ¯ä¸ªå­ä»»åŠ¡éƒ½æ˜¯ä¸€ä¸ª **AugmentedLLM**ï¼Œæ•´ä¸ª **Parallel** å·¥ä½œæµæœ¬èº«ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªå­ä»»åŠ¡å¯ä»¥é€‰æ‹©æ€§åœ°æˆä¸ºä¸€ä¸ªæ›´å¤æ‚çš„å·¥ä½œæµã€‚

![](images/dd081084-c2d0-4d42-a077-b99667234d9b.png)

&#x20;       è·¯ç”±æ¨¡å¼ï¼š**å¯¹äºç»™å®šçš„è¾“å…¥ï¼Œç³»ç»Ÿä¼šå°†å…¶è·¯ç”±ï¼ˆåˆ†é…ï¼‰åˆ°æœ€ç›¸å…³çš„ `top_k` ä¸ªç±»åˆ«ã€‚**
å…¶ä¸­ï¼Œæ¯ä¸ªç±»åˆ«ï¼ˆcategoryï¼‰å¯ä»¥æ˜¯ï¼š

1. **Agent**ï¼ˆæ™ºèƒ½ä»£ç†ï¼‰ï¼šå¯èƒ½æ˜¯ä¸€ä¸ª AI ä»£ç†ï¼ˆå¦‚ LLM é©±åŠ¨çš„ä»»åŠ¡å¤„ç†å•å…ƒï¼‰ã€‚

2. **MCP æœåŠ¡å™¨**ï¼ˆMCP Serverï¼‰ï¼šå¯ä»¥æ˜¯åŸºäº **Model Context Protocol (MCP)** çš„æœåŠ¡å™¨ï¼Œç”¨äºå¤„ç†ç‰¹å®šä»»åŠ¡æˆ–æä¾›å¤–éƒ¨æ•°æ®æ”¯æŒã€‚

3. **å¸¸è§„å‡½æ•°**ï¼ˆRegular Functionï¼‰ï¼šå³æ™®é€šçš„ä»£ç å‡½æ•°ï¼Œå¯èƒ½æ˜¯æ‰§è¡Œè®¡ç®—ã€æ•°æ®å¤„ç†ç­‰ä»»åŠ¡çš„å‡½æ•°ã€‚

![](images/0710897f-35cf-4e7e-9393-6ef5357487ad.png)

&#x20;       ç¼–æ’æ¨¡å¼ï¼š**ä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„ LLMï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰è´Ÿè´£ç”Ÿæˆä»»åŠ¡è®¡åˆ’ï¼ˆplanï¼‰ï¼Œç„¶åå°†å„ä¸ªå­ä»»åŠ¡åˆ†é…ç»™å­ä»£ç†ï¼ˆsub-agentsï¼‰ï¼Œå¹¶æœ€ç»ˆæ•´åˆï¼ˆsynthesizeï¼‰è¿™äº›å­ä»»åŠ¡çš„ç»“æœã€‚**

å…¶ä¸­ï¼š

* **é«˜å±‚ LLM ç”Ÿæˆè®¡åˆ’**ï¼šè¿™ä¸ª LLM å……å½“â€œæŒ‡æŒ¥å®˜â€ï¼Œæ ¹æ®è¾“å…¥ä»»åŠ¡åˆ¶å®šæ‰§è¡Œæ­¥éª¤ã€‚

* **å­ä»£ç†ï¼ˆsub-agentsï¼‰æ‰§è¡Œä»»åŠ¡**ï¼šæ¯ä¸ªå­ä»»åŠ¡è¢«åˆ†é…ç»™ä¸åŒçš„å­ä»£ç†ï¼Œå¯èƒ½æ˜¯ä¸åŒçš„ AI ç»„ä»¶ã€MCP æœåŠ¡å™¨æˆ–ç‰¹å®šå‡½æ•°ã€‚

* **æ•´åˆï¼ˆsynthesizeï¼‰ç»“æœ**ï¼šåœ¨æ‰€æœ‰å­ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œç³»ç»Ÿä¼šå°†å®ƒä»¬çš„ç»“æœåˆå¹¶ï¼Œç”Ÿæˆæœ€ç»ˆè¾“å‡ºã€‚

![](images/fa330305-c514-43ba-bddf-3ff9fdf5325c.png)

&#x20;       ä¼˜åŒ–å™¨æ¨¡å¼ï¼š**ä¸€ä¸ª LLM å……å½“â€œä¼˜åŒ–å™¨â€ï¼ˆoptimizerï¼‰ï¼Œä¸æ–­ä¼˜åŒ–å›ç­”ï¼›å¦ä¸€ä¸ª LLM å……å½“â€œè¯„ä¼°è€…â€ï¼ˆevaluatorï¼‰ï¼Œå¯¹å›ç­”è¿›è¡Œæ‰¹åˆ¤æ€§è¯„ä¼°ï¼Œç›´åˆ°å›ç­”è¾¾åˆ°è´¨é‡æ ‡å‡†ã€‚**

**å…·ä½“æµç¨‹**

1. ä¼˜åŒ–å™¨ï¼ˆoptimizerï¼‰

   * ç”Ÿæˆåˆæ­¥çš„å›ç­”ï¼Œå¹¶åœ¨æ¯è½®è¿­ä»£ä¸­ä¸æ–­ä¼˜åŒ–å®ƒï¼Œä½¿å…¶æ›´å‡†ç¡®ã€æ›´ç¬¦åˆè¦æ±‚ã€‚

2. è¯„ä¼°è€…ï¼ˆevaluatorï¼‰

   * å¯¹ä¼˜åŒ–å™¨ç”Ÿæˆçš„å›ç­”è¿›è¡Œ**å®¡æŸ¥å’Œæ‰¹è¯„**ï¼ŒæŒ‡å‡ºå…¶ä¸­çš„é—®é¢˜ï¼ˆå¦‚é€»è¾‘é”™è¯¯ã€ä¿¡æ¯ç¼ºå¤±ã€è¯­ä¹‰ä¸æ¸…ç­‰ï¼‰ã€‚

   * å¦‚æœå›ç­”æœªè¾¾åˆ°è´¨é‡æ ‡å‡†ï¼Œå®ƒä¼šè¦æ±‚ä¼˜åŒ–å™¨è¿›è¡Œä¿®æ”¹å’Œæ”¹è¿›ã€‚

3. å¾ªç¯ä¼˜åŒ–

   * è¿™ä¸ªè¿‡ç¨‹ä¼š**åå¤è¿›è¡Œ**ï¼Œç›´åˆ°è¯„ä¼°è€…è®¤å¯ç­”æ¡ˆçš„è´¨é‡ï¼ˆå³è¶…è¿‡æŸä¸ªè´¨é‡æ ‡å‡†ï¼‰ã€‚

![](images/260afb36-0b3a-4e36-9cf8-c8e5719235da.png)

æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•å€ŸåŠ©MCPï¼Œå®ç°åˆ†å‘æ¨¡å¼å’Œè·¯ç”±æ¨¡å¼ï¼Œå¹¶æ®æ­¤æ­å»ºä¸€ä¸ªNL2SQL+NL2Pythonçš„åˆçº§æ•°æ®åˆ†ææ™ºèƒ½ä½“ã€‚

## äº”ã€OpenAIé£æ ¼API Function callingè¿›é˜¶åŠŸèƒ½ä»‹ç»

æœ¬éƒ¨åˆ†å†…å®¹éœ€å‚è€ƒä»¥ä¸‹Jupyeréƒ¨åˆ†ä»£ç è¿›è¡Œå­¦ä¹ ã€‚

![](images/44596ec4-4d46-44c5-ae85-13866c48d848.png)

&#x20;

![](images/8c2667ea-545f-4bce-a4ec-c553100f1896.png)

## å…­ã€å€ŸåŠ©MCPæ­å»ºAIæ•°æ®åˆ†ææ™ºèƒ½ä½“

&#x20;       åœ¨äº†è§£äº†Function callingçš„è¿›é˜¶åŠŸèƒ½å¤–ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­ä»‹ç»å¦‚ä½•åŸºäºä¸Šè¿°åŠŸèƒ½ï¼Œæ¥è¿›è¡ŒMCPæ™ºèƒ½ä½“å¿«é€Ÿå‘å¼€å‘ï¼Œæ¥æ­å»ºä¸€ä¸ªèƒ½å¤Ÿè¿›è¡ŒSQLæŸ¥è¯¢å’ŒPythonè‡ªåŠ¨ç¼–å†™çš„å…¥é—¨çº§æ•°æ®åˆ†ææ™ºèƒ½ä½“ã€‚

### 1. miniMateGené¡¹ç›®åˆå§‹åŒ–

```bash
cd /root/autodl-tmp/MCP
# åˆ›å»ºé¡¹ç›®ç›®å½•
uv init miniMateGen
cd miniMateGen
```

![](images/a170aa1e-5d74-44d1-9175-174d4ddf660b.png)

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
uv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate
```

![](images/65e4963f-17e2-47ed-b6ea-ffcf7fd17b6a.png)

åˆ›å»ºé¡¹ç›®å¦‚ä¸‹ï¼š

![](images/46b94ed2-ffc7-47ca-b256-d7679ce8f3e8.png)

### 2. åˆ›å»ºMCPæœåŠ¡å™¨ä¸€ï¼šSQL\_server

#### 2.1 Linuxç¯å¢ƒä¸‹å®‰è£…MySQLæœåŠ¡å™¨å¹¶åˆ›å»ºç®€å•æ•°æ®é›†

* åˆ›å»ºMySQLæ•°æ®åº“

```bash
apt install mysql-server
```

![](images/e8cd7817-52c2-4651-b3eb-ad9399ab7f8e.png)

ç„¶åå¯åŠ¨mysqlï¼Œå¹¶è®¾ç½®åˆå§‹å¯†ç ï¼š

```bash
mysqld &
mysql
```

è¿›å…¥åˆ°SQLå‘½ä»¤è¡Œåï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š

```sql
ALTER USER 'root'@'localhost' IDENTIFIED BY '123';
```

![](images/1bf2381f-6aaf-498a-86d4-ee24a5072c36.png)

ç„¶åè¾“å…¥`exit;`å³å¯é€€å‡ºã€‚

ç„¶åå†æ¬¡è¿›å…¥MySQLï¼Œå¹¶æ ¹æ®è¦æ±‚è¾“å…¥å¯†ç ï¼š

```bash
mysql -u root -p
```

ç„¶ååˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼š

```sql
CREATE DATABASE school;
USE school;
```

ç„¶ååˆ›å»ºä¸€ä¸ªè™šæ‹Ÿè¡¨æ ¼ï¼Œé‡Œé¢åŒ…å«äº†10ä½åŒå­¦å„è‡ª3é—¨è¯¾ç¨‹çš„åˆ†æ•°ï¼š

```sql
CREATE TABLE students_scores (
    id INT AUTO_INCREMENT PRIMARY KEY,  
    name VARCHAR(50),                   
    course1 INT,                        
    course2 INT,                       
    course3 INT                        
);
```

```sql
INSERT INTO students_scores (name, course1, course2, course3)
VALUES
    ('å­¦ç”Ÿ1', 85, 92, 78),
    ('å­¦ç”Ÿ2', 76, 88, 91),
    ('å­¦ç”Ÿ3', 90, 85, 80),
    ('å­¦ç”Ÿ4', 65, 70, 72),
    ('å­¦ç”Ÿ5', 82, 89, 95),
    ('å­¦ç”Ÿ6', 91, 93, 87),
    ('å­¦ç”Ÿ7', 77, 78, 85),
    ('å­¦ç”Ÿ8', 88, 92, 91),
    ('å­¦ç”Ÿ9', 84, 76, 80),
    ('å­¦ç”Ÿ10', 89, 90, 92);
```

![](images/ceef4fab-3077-464e-b9f6-40ddaaa469b4.png)

ç„¶åå³å¯æŸ¥çœ‹æ•°æ®é›†åŸºæœ¬æƒ…å†µï¼š

```sql
SELECT * FROM students_scores;
```

![](images/e09f4929-b145-48d6-8a59-7a3c287b690a.png)

æ­¤å¤–ï¼Œè¿˜éœ€è¦åˆ·æ–°èº«ä»½éªŒè¯ï¼Œä½¿å¾—å…¶ä»–åº“ï¼ˆå¦‚pymysqlï¼‰å¯ä»¥é€šè¿‡å¯†ç éªŒè¯ç™»å½•ï¼š

```sql
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '123';
```

![](images/d1df071f-c9c0-4e03-9a8d-3b6a4419a49b.png)

#### 2.2 ç¼–å†™SQL\_server.pyä»£ç 

* åŠŸèƒ½ç¤ºæ„å›¾

![](images/bd48cadd-8ff0-4396-8691-294ce0d4390e.png)

* ä»£ç ä½ç½®

![](images/4c7bebe7-4751-44b1-9806-ecfe72c88aed.png)

éœ€è¦å¢åŠ é¢å¤–ä¾èµ–ï¼š

```bash
uv add pymysql numpy pandas
```

ä»£ç å†…å®¹å¦‚ä¸‹ï¼š

```python
import json
import httpx
from typing import Any
import pymysql
import csv
from mcp.server.fastmcp import FastMCP

# åˆå§‹åŒ– MCP æœåŠ¡å™¨
mcp = FastMCP("SQLServer")
USER_AGENT = "SQLserver-app/1.0"

@mcp.tool()
async def sql_inter(sql_query):
    """
    æŸ¥è¯¢æœ¬åœ°MySQLæ•°æ®åº“ï¼Œé€šè¿‡è¿è¡Œä¸€æ®µSQLä»£ç æ¥è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢ã€‚\
    :param sql_query: å­—ç¬¦ä¸²å½¢å¼çš„SQLæŸ¥è¯¢è¯­å¥ï¼Œç”¨äºæ‰§è¡Œå¯¹MySQLä¸­schoolæ•°æ®åº“ä¸­å„å¼ è¡¨è¿›è¡ŒæŸ¥è¯¢ï¼Œå¹¶è·å¾—å„è¡¨ä¸­çš„å„ç±»ç›¸å…³ä¿¡æ¯
    :returnï¼šsql_queryåœ¨MySQLä¸­çš„è¿è¡Œç»“æœã€‚
    """
    
    connection = pymysql.connect(
            host='localhost',  # æ•°æ®åº“åœ°å€
            user='root',  # æ•°æ®åº“ç”¨æˆ·å
            passwd='123',  # æ•°æ®åº“å¯†ç 
            db='school',  # æ•°æ®åº“å
            charset='utf8'  # å­—ç¬¦é›†é€‰æ‹©utf8
        )
    
    try:
        with connection.cursor() as cursor:
            # SQLæŸ¥è¯¢è¯­å¥
            sql = sql_query
            cursor.execute(sql)

            # è·å–æŸ¥è¯¢ç»“æœ
            results = cursor.fetchall()

    finally:
        connection.close()
    
    
    return json.dumps(results)

@mcp.tool()
async def export_table_to_csv(table_name, output_file):
    """
    å°† MySQL æ•°æ®åº“ä¸­çš„æŸä¸ªè¡¨å¯¼å‡ºä¸º CSV æ–‡ä»¶ã€‚
    
    :param table_name: éœ€è¦å¯¼å‡ºçš„è¡¨å
    :param output_file: è¾“å‡ºçš„ CSV æ–‡ä»¶è·¯å¾„
    """
    # è¿æ¥ MySQL æ•°æ®åº“
    connection = pymysql.connect(
        host='localhost',  # æ•°æ®åº“åœ°å€
        user='root',  # æ•°æ®åº“ç”¨æˆ·å
        passwd='123',  # æ•°æ®åº“å¯†ç 
        db='school',  # æ•°æ®åº“å
        charset='utf8'  # å­—ç¬¦é›†
    )

    try:
        with connection.cursor() as cursor:
            # æŸ¥è¯¢æ•°æ®è¡¨çš„æ‰€æœ‰æ•°æ®
            query = f"SELECT * FROM {table_name};"
            cursor.execute(query)

            # è·å–æ‰€æœ‰åˆ—å
            column_names = [desc[0] for desc in cursor.description]

            # è·å–æŸ¥è¯¢ç»“æœ
            rows = cursor.fetchall()

            # å°†æ•°æ®å†™å…¥ CSV æ–‡ä»¶
            with open(output_file, mode='w', newline='', encoding='utf-8') as file:
                writer = csv.writer(file)
                
                # å†™å…¥è¡¨å¤´
                writer.writerow(column_names)
                
                # å†™å…¥æ•°æ®
                writer.writerows(rows)

            print(f"æ•°æ®è¡¨ {table_name} å·²æˆåŠŸå¯¼å‡ºè‡³ {output_file}")

    except Exception as e:
        print(f"å¯¼å‡ºå¤±è´¥: {e}")

    finally:
        connection.close()

if __name__ == "__main__":
    # ä»¥æ ‡å‡† I/O æ–¹å¼è¿è¡Œ MCP æœåŠ¡å™¨
    mcp.run(transport='stdio')
```

**ä»£ç è¯¦ç»†è§£é‡Š**

è¿™æ®µä»£ç æ˜¯ä¸€ä¸ª **MCP æœåŠ¡å™¨ï¼ˆModel Context Protocol Serverï¼‰**ï¼Œå®ƒæä¾›äº†ä¸¤ä¸ªä¸»è¦åŠŸèƒ½ï¼š

1. **æŸ¥è¯¢ MySQL æ•°æ®åº“ï¼ˆ`sql_inter`ï¼‰**ï¼šå…è®¸ç”¨æˆ·è¾“å…¥ SQL æŸ¥è¯¢ï¼Œå¹¶è·å– MySQL æ•°æ®åº“çš„æŸ¥è¯¢ç»“æœã€‚

2. **å°†æ•°æ®åº“è¡¨å¯¼å‡ºä¸º CSV æ–‡ä»¶ï¼ˆ`export_table_to_csv`ï¼‰**ï¼šæŠŠ MySQL æ•°æ®åº“ä¸­çš„æŸä¸ªè¡¨è½¬æ¢ä¸º CSV æ–‡ä»¶å¹¶ä¿å­˜åˆ°æœ¬åœ°ã€‚

æ­¤å¤–ï¼Œæ•´ä¸ª MCP æœåŠ¡å™¨æ˜¯åŸºäº `FastMCP` è¿è¡Œçš„ï¼Œå…è®¸å…¶ä»–ç³»ç»Ÿæˆ–ç”¨æˆ·é€šè¿‡ MCP åè®®è°ƒç”¨è¿™äº›å·¥å…·ã€‚

å…¶ä¸­ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°è§£é‡Šå¦‚ä¸‹

**(1) `sql_inter(sql_query)`ï¼šæŸ¥è¯¢ MySQL æ•°æ®åº“**

**åŠŸèƒ½**

* è¯¥å‡½æ•°**æ¥æ”¶ä¸€æ¡ SQL æŸ¥è¯¢è¯­å¥**ï¼Œå¹¶åœ¨ MySQL æ•°æ®åº“ `school` ä¸­æ‰§è¡ŒæŸ¥è¯¢ã€‚

* é€šè¿‡ `pymysql.connect()` è¿æ¥æœ¬åœ° MySQL æœåŠ¡å™¨ï¼ˆç”¨æˆ·å `root`ï¼Œå¯†ç  `123`ï¼‰ã€‚

* ä½¿ç”¨ `cursor.execute(sql_query)` æ‰§è¡Œ SQL è¯­å¥ï¼Œå¹¶ä½¿ç”¨ `fetchall()` è·å–æ‰€æœ‰æŸ¥è¯¢ç»“æœã€‚

* ç»“æœæœ€ç»ˆ**è½¬æ¢ä¸º JSON æ ¼å¼è¿”å›**ã€‚

**(2) `export_table_to_csv(table_name, output_file)`ï¼šå¯¼å‡ºè¡¨ä¸º CSV**

**åŠŸèƒ½**

* è¯¥å‡½æ•°**å¯¼å‡º MySQL æ•°æ®è¡¨ä¸º CSV æ–‡ä»¶**ã€‚

* è¿æ¥ MySQL æœåŠ¡å™¨å¹¶æ‰§è¡Œ `SELECT * FROM table_name;` æŸ¥è¯¢**è·å–è¡¨æ•°æ®**ã€‚

* **æå–è¡¨å¤´ï¼ˆåˆ—åï¼‰**ï¼Œå¹¶å°†å…¶ä¸æŸ¥è¯¢ç»“æœä¸€èµ·**å†™å…¥ CSV æ–‡ä»¶**ã€‚

* **æ‰“å°å¯¼å‡ºæˆåŠŸæ¶ˆæ¯** æˆ– **é”™è¯¯ä¿¡æ¯**ã€‚

| **åŠŸèƒ½**                      | **ä½œç”¨**                      |
| --------------------------- | --------------------------- |
| **MCP æœåŠ¡å™¨** (`FastMCP`)     | å…è®¸ MCP å®¢æˆ·ç«¯è°ƒç”¨ SQL æŸ¥è¯¢å’Œæ•°æ®å¯¼å‡ºåŠŸèƒ½ã€‚ |
| **`sql_inter()`**           | æ‰§è¡Œ SQL è¯­å¥å¹¶è¿”å› JSON ç»“æœã€‚       |
| **`export_table_to_csv()`** | å¯¼å‡º MySQL æ•°æ®è¡¨ä¸º CSV æ–‡ä»¶ã€‚       |
| **`mcp.run()`**             | å¯åŠ¨ MCP æœåŠ¡å™¨ï¼Œç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚ã€‚         |

### 3. åˆ›å»ºMCPæœåŠ¡å™¨äºŒï¼šPython\_server

![](images/f72b77ba-2425-44a0-ba29-06fdebfba4f5.png)

&#x20;

![](images/080e4783-6280-4b58-b5ff-234ae9141a76.png)

```python
import json
from typing import Any
import csv
import numpy as np
import pandas as pd
import random
from mcp.server.fastmcp import FastMCP

# åˆå§‹åŒ– MCP æœåŠ¡å™¨
mcp = FastMCP("PythonServer")
USER_AGENT = "Pythonserver-app/1.0"

@mcp.tool()
async def python_inter(py_code):
    """
    è¿è¡Œç”¨æˆ·æä¾›çš„ Python ä»£ç ï¼Œå¹¶è¿”å›æ‰§è¡Œç»“æœã€‚
    
    :param py_code: å­—ç¬¦ä¸²å½¢å¼çš„ Python ä»£ç 
    :return: ä»£ç è¿è¡Œçš„æœ€ç»ˆç»“æœ
    """
    g = globals()
    
    try:
        # è‹¥æ˜¯è¡¨è¾¾å¼ï¼Œç›´æ¥è¿è¡Œå¹¶è¿”å›
        result = eval(py_code, g)
        return json.dumps(str(result), ensure_ascii=False)
    
    except Exception:
        global_vars_before = set(g.keys())
        try:
            exec(py_code, g)
        except Exception as e:
            return json.dumps(f"ä»£ç æ‰§è¡Œæ—¶æŠ¥é”™: {e}", ensure_ascii=False)

        global_vars_after = set(g.keys())
        new_vars = global_vars_after - global_vars_before

        if new_vars:
            # åªè¿”å›å¯åºåˆ—åŒ–çš„å˜é‡å€¼
            safe_result = {}
            for var in new_vars:
                try:
                    json.dumps(g[var])  # å°è¯•åºåˆ—åŒ–ï¼Œç¡®ä¿å¯ä»¥è½¬æ¢ä¸º JSON
                    safe_result[var] = g[var]
                except (TypeError, OverflowError):
                    safe_result[var] = str(g[var])  # å¦‚æœä¸èƒ½åºåˆ—åŒ–ï¼Œåˆ™è½¬æ¢ä¸ºå­—ç¬¦ä¸²

            return json.dumps(safe_result, ensure_ascii=False)
        
        else:
            return json.dumps("å·²ç»é¡ºåˆ©æ‰§è¡Œä»£ç ", ensure_ascii=False)

if __name__ == "__main__":
    # ä»¥æ ‡å‡† I/O æ–¹å¼è¿è¡Œ MCP æœåŠ¡å™¨
    mcp.run(transport='stdio')
```

è¿™æ®µä»£ç å®ç°äº†ä¸€ä¸ª **MCP æœåŠ¡å™¨**ï¼Œå®ƒå…è®¸ **è¿œç¨‹æ‰§è¡Œ Python ä»£ç **ï¼Œå¹¶è¿”å›æ‰§è¡Œç»“æœã€‚

**ä»£ç æ‰§è¡Œé€»è¾‘å¦‚ä¸‹**

**(a) `eval()` å¤„ç†å•è¡Œ Python è¡¨è¾¾å¼**

```python
try:
    result = eval(py_code, g)
    return json.dumps(str(result), ensure_ascii=False)
```

* **å¦‚æœ `py_code` æ˜¯ä¸€ä¸ªç®€å•è¡¨è¾¾å¼**ï¼ˆå¦‚ `"1 + 1"` æˆ– `"max([3,5,7])"`ï¼‰ï¼Œåˆ™ç›´æ¥ç”¨ `eval()` è®¡ç®—å¹¶è¿”å›ç»“æœã€‚

* ç¤ºä¾‹

```python
python_inter("3 + 4")
```

* è¿”å›

```json
"7"
```

**(b) `exec()` å¤„ç†å®Œæ•´çš„ Python ä»£ç **

å¦‚æœ `eval()` **æ‰§è¡Œå¤±è´¥**ï¼ˆæ„å‘³ç€è¾“å…¥æ˜¯ä»£ç å—è€Œä¸æ˜¯å•ä¸ªè¡¨è¾¾å¼ï¼‰ï¼Œé‚£ä¹ˆï¼š

```python
global_vars_before = set(g.keys())  # è®°å½•æ‰§è¡Œå‰çš„å…¨å±€å˜é‡
try:
    exec(py_code, g)  # è¿è¡Œ Python ä»£ç 
except Exception as e:
    return json.dumps(f"ä»£ç æ‰§è¡Œæ—¶æŠ¥é”™: {e}", ensure_ascii=False)
```

* **ä½¿ç”¨ `exec()` æ‰§è¡Œå®Œæ•´çš„ Python ä»£ç **ï¼ˆå¦‚å®šä¹‰å˜é‡ã€å¾ªç¯ã€å‡½æ•°ï¼‰ã€‚

* **å¦‚æœ `exec()` å‘ç”Ÿé”™è¯¯ï¼Œåˆ™è¿”å›é”™è¯¯ä¿¡æ¯**ã€‚

**(c) æå–æ–°åˆ›å»ºçš„å˜é‡**

```python
global_vars_after = set(g.keys())  # è®°å½•æ‰§è¡Œåçš„å…¨å±€å˜é‡
new_vars = global_vars_after - global_vars_before  # æ‰¾å‡ºæ–°åˆ›å»ºçš„å˜é‡

if new_vars:
    safe_result = {}
    for var in new_vars:
        try:
            json.dumps(g[var])  # å°è¯•åºåˆ—åŒ–
            safe_result[var] = g[var]
        except (TypeError, OverflowError):
            safe_result[var] = str(g[var])  # ä¸èƒ½åºåˆ—åŒ–çš„å˜é‡è½¬æ¢ä¸ºå­—ç¬¦ä¸²

    return json.dumps(safe_result, ensure_ascii=False)
```

* **æ£€æŸ¥ `exec()` è¿è¡Œåæ–°å¢çš„å˜é‡**ï¼Œåªè¿”å›**å¯åºåˆ—åŒ–**çš„å˜é‡ã€‚

* ç¤ºä¾‹

```python
python_inter("a = 10\nb = 20\nc = a + b")
```

* è¿”å›

```json
{
    "a": 10,
    "b": 20,
    "c": 30
}
```

* **å¦‚æœä»£ç è¿è¡Œåæ²¡æœ‰æ–°å˜é‡ï¼Œåªè¿”å› `å·²é¡ºåˆ©æ‰§è¡Œä»£ç `**ã€‚

ä»£ç æ€»ç»“ï¼š

| **åŠŸèƒ½**                  | **ä½œç”¨**                  |
| ----------------------- | ----------------------- |
| **MCP æœåŠ¡å™¨** (`FastMCP`) | å…è®¸è¿œç¨‹æ‰§è¡Œ Python ä»£ç         |
| **`python_inter()`**    | è¿è¡Œ Python ä»£ç ï¼Œè¿”å› JSON ç»“æœ |
| **æ”¯æŒ `eval()`**         | è®¡ç®—ç®€å• Python è¡¨è¾¾å¼         |
| **æ”¯æŒ `exec()`**         | è¿è¡Œå®Œæ•´ Python ä»£ç           |
| **ä»£ç å®‰å…¨æ£€æŸ¥**              | ä»…è¿”å›å¯åºåˆ—åŒ–å˜é‡               |

### 4.åˆ›å»ºMCPå®¢æˆ·ç«¯Client

æ¥ä¸‹æ¥è€ƒè™‘åˆ›å»ºå®¢æˆ·ç«¯Clientï¼Œæ­¤æ—¶å®¢æˆ·ç«¯éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ç‚¹è¦æ±‚ï¼š

1. åŒæ—¶è¿æ¥å¤šä¸ªæœåŠ¡å™¨ä¸Šçš„è‹¥å¹²ä¸ªå·¥å…·ï¼›

2. éœ€è¦èƒ½å¤ŸåŒæ—¶å®Œæˆä¸²è”æˆ–è€…å¹¶è”æ¨¡å¼ï¼›

3. éœ€è¦èƒ½å¤Ÿæ”¯æŒå¤šè½®å¯¹è¯ã€‚

æ®æ­¤è®¾è®¡æ¶æ„å¦‚ä¸‹æ‰€ç¤ºï¼š

![](images/05bb3636-fa75-4bfc-b136-67b1f52f5a49-1.png)

ä»£ç ä½ç½®ï¼š

![](images/170b18d4-7768-48a8-b2e0-014e5901f215.png)

å®Œæ•´ä»£ç å†…å®¹å¦‚ä¸‹ï¼š

```python
import asyncio
import os
import json
from typing import Optional, Dict
from contextlib import AsyncExitStack

from openai import OpenAI
from dotenv import load_dotenv

from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client

load_dotenv()

class MultiServerMCPClient:
    def __init__(self):
        """ç®¡ç†å¤šä¸ª MCP æœåŠ¡å™¨çš„å®¢æˆ·ç«¯"""
        self.exit_stack = AsyncExitStack()
        self.openai_api_key = os.getenv("OPENAI_API_KEY")  
        self.base_url = os.getenv("BASE_URL")  
        self.model = os.getenv("MODEL")  
        if not self.openai_api_key:
            raise ValueError("âŒ æœªæ‰¾åˆ° OPENAI_API_KEYï¼Œè¯·åœ¨ .env æ–‡ä»¶ä¸­é…ç½®")

        # åˆå§‹åŒ– OpenAI Client
        self.client = OpenAI(api_key=self.openai_api_key, base_url=self.base_url)
        
        # å­˜å‚¨ (server_name -> MCP ClientSession) æ˜ å°„
        self.sessions: Dict[str, ClientSession] = {}
        # å­˜å‚¨å·¥å…·ä¿¡æ¯
        self.tools_by_session: Dict[str, list] = {}  # æ¯ä¸ª session çš„ tools åˆ—è¡¨
        self.all_tools = []  # åˆå¹¶æ‰€æœ‰å·¥å…·çš„åˆ—è¡¨

    async def connect_to_servers(self, servers: dict):
        """
        åŒæ—¶å¯åŠ¨å¤šä¸ªæœåŠ¡å™¨å¹¶è·å–å·¥å…·
        servers: å½¢å¦‚ {"weather": "weather_server.py", "rag": "rag_server.py"}
        """
        for server_name, script_path in servers.items():
            session = await self._start_one_server(script_path)
            self.sessions[server_name] = session
            
            # åˆ—å‡ºæ­¤æœåŠ¡å™¨çš„å·¥å…·
            resp = await session.list_tools()
            self.tools_by_session[server_name] = resp.tools  # ä¿å­˜åˆ° self.tools_by_session

            for tool in resp.tools:
                # OpenAI Function Calling æ ¼å¼ä¿®æ­£
                function_name = f"{server_name}_{tool.name}"
                # print(tool.name)
                self.all_tools.append({
                    "type": "function",
                    "function": {
                        "name": function_name,
                        "description": tool.description,
                        "input_schema": tool.inputSchema
                    }
                })
         
        
        # è½¬åŒ–function callingæ ¼å¼
        self.all_tools = await self.transform_json(self.all_tools)
        # print(self.all_tools)

        print("\nâœ… å·²è¿æ¥åˆ°ä¸‹åˆ—æœåŠ¡å™¨:")
        for name in servers:
            print(f"  - {name}: {servers[name]}")
        print("\næ±‡æ€»çš„å·¥å…·:")
        
        for t in self.all_tools:
            print(f"  - {t['function']['name']}")

    async def transform_json(self, json2_data):
        """
        å°†ç±»ä¼¼ json2 çš„æ ¼å¼è½¬æ¢ä¸ºç±»ä¼¼ json1 çš„æ ¼å¼ï¼Œå¤šä½™å­—æ®µä¼šè¢«ç›´æ¥åˆ é™¤ã€‚
        
        :param json2_data: ä¸€ä¸ªå¯è¢«è§£é‡Šä¸ºåˆ—è¡¨çš„ Python å¯¹è±¡ï¼ˆæˆ–å·²è§£æçš„ JSON æ•°æ®ï¼‰
        :return: è½¬æ¢åçš„æ–°åˆ—è¡¨
        """
        result = []
        
        for item in json2_data:
            # ç¡®ä¿æœ‰ "type" å’Œ "function" ä¸¤ä¸ªå…³é”®å­—æ®µ
            if not isinstance(item, dict) or "type" not in item or "function" not in item:
                continue
        
            old_func = item["function"]
        
            # ç¡®ä¿ function ä¸‹æœ‰æˆ‘ä»¬éœ€è¦çš„å…³é”®å­å­—æ®µ
            if not isinstance(old_func, dict) or "name" not in old_func or "description" not in old_func:
                continue
        
            # å¤„ç†æ–° function å­—æ®µ
            new_func = {
                "name": old_func["name"],
                "description": old_func["description"],
                "parameters": {}
            }
        
            # è¯»å– input_schema å¹¶è½¬æˆ parameters
            if "input_schema" in old_func and isinstance(old_func["input_schema"], dict):
                old_schema = old_func["input_schema"]
                
                # æ–°çš„ parameters ä¿ç•™ type, properties, required è¿™ä¸‰ä¸ªå­—æ®µ
                new_func["parameters"]["type"] = old_schema.get("type", "object")
                new_func["parameters"]["properties"] = old_schema.get("properties", {})
                new_func["parameters"]["required"] = old_schema.get("required", [])
            
            new_item = {
                "type": item["type"],
                "function": new_func
            }
        
            result.append(new_item)
    
        return result            

    async def _start_one_server(self, script_path: str) -> ClientSession:
        """å¯åŠ¨å•ä¸ª MCP æœåŠ¡å™¨å­è¿›ç¨‹ï¼Œå¹¶è¿”å› ClientSession"""
        is_python = script_path.endswith(".py")
        is_js = script_path.endswith(".js")
        if not (is_python or is_js):
            raise ValueError("æœåŠ¡å™¨è„šæœ¬å¿…é¡»æ˜¯ .py æˆ– .js æ–‡ä»¶")

        command = "python" if is_python else "node"
        server_params = StdioServerParameters(
            command=command,
            args=[script_path],
            env=None
        )
        stdio_transport = await self.exit_stack.enter_async_context(stdio_client(server_params))
        read_stream, write_stream = stdio_transport
        session = await self.exit_stack.enter_async_context(ClientSession(read_stream, write_stream))
        await session.initialize()
        return session


    async def chat_base(self, messages: list) -> list:
    
        # messages = [{"role": "user", "content": query}]
        response = self.client.chat.completions.create(
            model=self.model,
            messages=messages,
            tools=self.all_tools
        )
        if response.choices[0].finish_reason == "tool_calls":
            while True:
                messages = await self.create_function_response_messages(messages, response)
                response = self.client.chat.completions.create(
                    model=self.model,
                    messages=messages,
                    tools=self.all_tools
                )
                if response.choices[0].finish_reason != "tool_calls":
                    break
                    
        # return response.choices[0].message.content
        return response
        
    async def create_function_response_messages(self, messages, response):
        function_call_messages = response.choices[0].message.tool_calls
        messages.append(response.choices[0].message.model_dump())
        
        for function_call_message in function_call_messages:
            tool_name = function_call_message.function.name
            tool_args = json.loads(function_call_message.function.arguments)
        
            # è¿è¡Œå¤–éƒ¨å‡½æ•°
            function_response = await self._call_mcp_tool(tool_name, tool_args)

            # æ‹¼æ¥æ¶ˆæ¯é˜Ÿåˆ—
            messages.append(
                {
                    "role": "tool",
                    "content": function_response,
                    "tool_call_id": function_call_message.id,
                }
            )
        return messages  

    async def process_query(self, user_query: str) -> str:
        """
        OpenAI æœ€æ–° Function Calling é€»è¾‘:
         1. å‘é€ç”¨æˆ·æ¶ˆæ¯ + tools ä¿¡æ¯
         2. è‹¥æ¨¡å‹ `finish_reason == "tool_calls"`ï¼Œåˆ™è§£æ toolCalls å¹¶æ‰§è¡Œç›¸åº” MCP å·¥å…·
         3. æŠŠè°ƒç”¨ç»“æœè¿”å›ç»™ OpenAIï¼Œè®©æ¨¡å‹ç”Ÿæˆæœ€ç»ˆå›ç­”
        """
        messages = [{"role": "user", "content": user_query}]

        # ç¬¬ä¸€æ¬¡è¯·æ±‚
        response = self.client.chat.completions.create(
            model=self.model,
            messages=messages,
            tools=self.all_tools
        )
        content = response.choices[0]
        print(content)
        print(self.all_tools)

        # å¦‚æœæ¨¡å‹è°ƒç”¨äº† MCP å·¥å…·
        if content.finish_reason == "tool_calls":
            # è§£æ tool_calls
            tool_call = content.message.tool_calls[0]
            tool_name = tool_call.function.name  # å½¢å¦‚ "weather_query_weather"
            tool_args = json.loads(tool_call.function.arguments)

            print(f"\n[ è°ƒç”¨å·¥å…·: {tool_name}, å‚æ•°: {tool_args} ]\n")

            # æ‰§è¡ŒMCPå·¥å…·
            result = await self._call_mcp_tool(tool_name, tool_args)

            # æŠŠå·¥å…·è°ƒç”¨å†å²å†™è¿› messages
            messages.append(content.message.model_dump())
            messages.append({
                "role": "tool",
                "content": result,
                "tool_call_id": tool_call.id,
            })
            # ç¬¬äºŒæ¬¡è¯·æ±‚ï¼Œè®©æ¨¡å‹æ•´åˆå·¥å…·ç»“æœï¼Œç”Ÿæˆæœ€ç»ˆå›ç­”
            response = self.client.chat.completions.create(
                model=self.model,
                messages=messages
            )
            return response.choices[0].message.content

        # å¦‚æœæ¨¡å‹æ²¡è°ƒç”¨å·¥å…·ï¼Œç›´æ¥è¿”å›å›ç­”
        return content.message.content

    async def _call_mcp_tool(self, tool_full_name: str, tool_args: dict) -> str:
        """
        æ ¹æ® "serverName_toolName" è°ƒç”¨ç›¸åº”çš„æœåŠ¡å™¨å·¥å…·
        """
        parts = tool_full_name.split("_", 1)  # æ‹†åˆ† "weather_query_weather" -> ["weather", "query_weather"]
        if len(parts) != 2:
            return f"æ— æ•ˆçš„å·¥å…·åç§°: {tool_full_name}"

        server_name, tool_name = parts
        session = self.sessions.get(server_name)
        if not session:
            return f"æ‰¾ä¸åˆ°æœåŠ¡å™¨: {server_name}"
        
        # æ‰§è¡Œ MCP å·¥å…·
        resp = await session.call_tool(tool_name, tool_args)
        print(resp)
        return resp.content if resp.content else "å·¥å…·æ‰§è¡Œæ— è¾“å‡º"

    async def chat_loop(self):
        print("\nğŸ¤– å¤šæœåŠ¡å™¨ MCP + æœ€æ–° Function Calling å®¢æˆ·ç«¯å·²å¯åŠ¨ï¼è¾“å…¥ 'quit' é€€å‡ºã€‚")
        messages = []

        while True:
            query = input("\nä½ : ").strip()
            if query.lower() == "quit":
                break
            try:
                messages.append({"role": "user", "content": query})
                messages = messages[-20: ]
                # print(messages)
                response = await self.chat_base(messages)
                messages.append(response.choices[0].message.model_dump())
                result = response.choices[0].message.content
                
                print(f"\nAI: {result}")
            except Exception as e:
                print(f"\nâš ï¸  è°ƒç”¨è¿‡ç¨‹å‡ºé”™: {e}")

    async def cleanup(self):
        # å…³é—­æ‰€æœ‰èµ„æº
        await self.exit_stack.aclose()

async def main():
    # æœåŠ¡å™¨è„šæœ¬
    servers = {
        "write": "write_server.py",
        "weather": "weather_server.py",
        "SQLServer":"SQL_server.py",
        "PythonServer":"Python_server.py"
    }

    client = MultiServerMCPClient()
    try:
        await client.connect_to_servers(servers)
        await client.chat_loop()
    finally:
        await client.cleanup()

if __name__ == "__main__":
    asyncio.run(main())
```

ä»£ç è§£é‡Šå¦‚ä¸‹ï¼š

### 5.miniMateGenåŠŸèƒ½æµ‹è¯•

æ¥ä¸‹æ¥å³å¯å¯åŠ¨MCPå®¢æˆ·ç«¯ï¼š

```bash
source .venv/bin/activate
uv run client.py
```

![](images/f193a1f7-6a02-4051-bd53-64bfa004b5fe.png)

æ­¤æ—¶é¡¹ç›®å†…æ‹·è´äº†weather\_server.pyï¼ˆå¤©æ°”æŸ¥è¯¢å®¢æˆ·ç«¯ï¼‰ï¼Œå› æ­¤å¯ä»¥å…ˆæµ‹è¯•function callingå¹¶è¡Œèƒ½å¦é¡ºåˆ©è¿è¡Œï¼š

![](images/f1606be7-2b0f-4a31-9fec-6bad6121ccf9.png)

&#x20;

![](images/dd081084-c2d0-4d42-a077-b99667234d9b-1.png)

&#x20;ä»¥åŠFunction callingä¸²è”èƒ½å¦è¿è¡Œï¼š&#x20;

![](images/1c880bd3-7601-4cbe-883f-e283e3018341.png)

&#x20;

![](images/0710897f-35cf-4e7e-9393-6ef5357487ad-1.png)

#### 5.1 NL2SQLåŠŸèƒ½æµ‹è¯•

`è¯·å¸®æˆ‘æŸ¥è¯¢æ•°æ®åº“ä¸­æ€»å…±åŒ…å«å‡ å¼ è¡¨ï¼Ÿ`

`è¿™å¼ è¡¨ä¸­æ€»å…±æœ‰å‡ æ¡æ•°æ®ï¼Ÿ`

`è¯·å¸®æˆ‘å°†è¿™å¼ è¡¨å¯¼å‡ºåˆ°æœ¬åœ°`

![](images/9342f54c-5e47-4d18-8011-40f47169617c.png)

&#x20;

![](images/5f5420bb-bab7-4d82-aba4-a3a31eeade12.png)

#### 5.2 NL2PythonåŠŸèƒ½æµ‹è¯•

`ä½ å¥½ï¼Œè¯·å¸®æˆ‘ç¼–å†™å¹¶è¿è¡Œä¸€æ®µPythonä»£ç ï¼Œæ¥åˆ›å»ºä¸€ä¸ª10ä½çš„éšæœºæ•°`

![](images/167bd07a-ec98-46d2-ba2d-c87cabaf1189.png)

#### 5.3 NL2SQL+NL2PythonåŠŸèƒ½è”åŠ¨æµ‹è¯•

`è¯·å¸®æˆ‘è¿è¡ŒPythonä»£ç æ¥è¯»å–æœ¬åœ°students_scores.csvæ–‡ä»¶ï¼Œå¹¶æ‰“å°ç¬¬ä¸€è¡Œæ•°æ®`

![](images/60545d2e-2c59-4036-b0a0-4e129adc602c.png)

`å¥½çš„ï¼Œæ¥ä¸‹æ¥æˆ‘æƒ³è¦æŸ¥çœ‹è¿™å¼ è¡¨çš„å…¨éƒ¨ä¿¡æ¯ï¼Œè¯·å¸®æˆ‘æ‰“å°è¿™å¼ è¡¨`

![](images/1399ae46-6104-4b8a-83ba-a87ea32cb136.png)

`è¯·å¸®æˆ‘è®¡ç®—è¿™å¼ è¡¨ä¸­å…¨éƒ¨å­¦ç”Ÿä¸‰é—¨å­¦ç§‘çš„å¹³å‡åˆ†æ•°`

![](images/f4565a5d-bf1e-4a69-85fc-5083c823408f.png)

***

æ›´å¤šå…³äºå¤§æ¨¡å‹æŠ€æœ¯ä»‹ç»ï¼Œæ¬¢è¿æŠ¥åç”±æˆ‘ä¸»è®²çš„ã€Š2025å¤§æ¨¡å‹Agentæ™ºèƒ½ä½“å¼€å‘å®æˆ˜ã€‹ï¼ˆæ˜¥å­£ç­ï¼‰https://whakv.xetslk.com/s/pxKHGè¿›è¡Œæ›´æ·±åº¦ç³»ç»Ÿçš„å­¦ä¹ å“¦\~

![](images/1270ec0d-9442-47bf-b8e3-4af376f3ba90-3.jpeg)

&#x20;

![](images/637c8563-6abc-468e-a07c-49ca062efa15.png)

&#x20;

![](images/6fa41ea3-4adf-4fa2-9abf-47ec5ae41ec9.png)

**[ã€Š2025å¤§æ¨¡å‹Agentæ™ºèƒ½ä½“å¼€å‘å®æˆ˜ã€‹](https://whakv.xetslk.com/s/3uzKfW)æ˜¥å­£ç­ç­ä¸Šæ–°ç‰¹æƒ è¿›è¡Œæ—¶ï¼Œè¯¦ç»†ä¿¡æ¯æ‰«ç æ·»åŠ åŠ©æ•™ï¼Œå›å¤â€œå¤§æ¨¡å‹â€ï¼Œå³å¯é¢†å–è¯¾ç¨‹å¤§çº²&æŸ¥çœ‹è¯¾ç¨‹è¯¦æƒ…ğŸ‘‡**

![](images/1536b607-9c9c-4010-954b-a7aefab8568f-3.jpeg)

æ­¤å¤–ï¼Œå¦‚æœå¯¹å¤§æ¨¡å‹åº•å±‚åŸç†å’Œæ¨¡å‹è®­ç»ƒæ„Ÿå…´è¶£ï¼Œæ¬¢è¿æŠ¥åç”±æˆ‘å’Œèœèœè€å¸ˆå…±åŒå¼€è®¾çš„ã€Šå¤§æ¨¡å‹åŸç†ä¸è®­ç»ƒå®æˆ˜ã€‹https://whakv.xetslk.com/s/3p66pNå®æˆ˜è¯¾ï¼Œ3æœˆæ–°ç­é¢å¤–æ–°å¢å¤§é‡DeepSeek V3\&R1æ¨¡å‹åŸç†ä¸è®­ç»ƒå®æˆ˜å†…å®¹ï¼Œæ‰«æä¸Šæ–¹äºŒç»´ç å³å¯æŸ¥çœ‹å®Œæ•´è¯¾ç¨‹å¤§çº²å“¦\~

![](images/c4507ac5-c188-47ab-b77a-3deed0318a2c.png)
