# ä»é›¶åˆ°ä¸€MCPå¿«é€Ÿå…¥é—¨å®æˆ˜

* Anthropic MCPå‘å¸ƒé€šå‘Šï¼šhttps://www.anthropic.com/news/model-context-protocol

* MCP GitHubä¸»é¡µï¼šhttps://github.com/modelcontextprotocol

## ä¸€ã€MCPæŠ€æœ¯ä½“ç³»ä»‹ç»

### 1. MCPå…¥é—¨ä»‹ç»

MCPï¼Œå…¨ç§°æ˜¯Model Context Protocolï¼Œæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼Œç”±Claudeæ¯å…¬å¸Anthropicäºå»å¹´11æœˆæ­£å¼æå‡ºã€‚

![](images/084fedfd-46a5-431f-acab-0a57e785bd9d.png)

MCPåˆšå‘å¸ƒçš„æ—¶å€™ä¸æ¸©ä¸ç«ï¼Œç›´åˆ°ä»Šå¹´Agentå¤§çˆ†å‘æ‰è¢«å¹¿æ³›å…³æ³¨ã€‚è€Œåœ¨ä»Šå¹´2æœˆï¼ŒCursoræ­£å¼å®£å¸ƒåŠ å…¥MCPåŠŸèƒ½æ”¯æŒï¼Œä¸€ä¸¾å°†MCPæ¨åˆ°äº†å…¨ä½“å¼€å‘äººå‘˜é¢å‰ã€‚ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼ŒMCPæ˜¯ä¸€ç§æŠ€æœ¯åè®®ï¼Œä¸€ç§æ™ºèƒ½ä½“Agentå¼€å‘è¿‡ç¨‹ä¸­å…±åŒçº¦å®šçš„ä¸€ç§è§„èŒƒã€‚è¿™å°±å¥½æ¯”ç§¦å§‹çš‡çš„â€œ**ä¹¦åŒæ–‡ã€è½¦åŒè½¨**â€ï¼Œåœ¨ç»Ÿä¸€çš„è§„èŒƒä¸‹ï¼Œå¤§å®¶çš„**åä½œæ•ˆç‡å°±èƒ½å¤§å¹…æé«˜**ï¼Œæœ€ç»ˆ**æå‡æ™ºèƒ½ä½“Agentçš„å¼€å‘æ•ˆç‡**ã€‚æˆªæ­¢ç›®å‰ï¼Œå·²ä¸Šåƒç§MCPå·¥å…·è¯ç”Ÿï¼Œåœ¨å¼ºæ‚çš„MCPç”Ÿæ€åŠ æŒä¸‹ï¼Œ äººäººæ‰‹æ“Manusçš„æ—¶ä»£å³å°†åˆ°æ¥ã€‚

![](images/c48d9cc4-14e7-4649-b996-ac20a166ea24.png)

æ€»çš„æ¥è¯´\*\*ï¼Œ**MCP**è§£å†³çš„æœ€å¤§ç—›ç‚¹ï¼Œå°±æ˜¯Agentå¼€å‘ä¸­è°ƒç”¨å¤–éƒ¨å·¥å…·çš„æŠ€æœ¯é—¨æ§›è¿‡é«˜çš„é—®é¢˜ã€‚\*\*

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œèƒ½è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼Œæ˜¯å¤§æ¨¡å‹è¿›åŒ–ä¸ºæ™ºèƒ½ä½“Agentçš„å…³é”®ï¼Œå¦‚æœä¸èƒ½ä½¿ç”¨å¤–éƒ¨å·¥å…·ï¼Œå¤§æ¨¡å‹å°±åªèƒ½æ˜¯ä¸ªç®€å•çš„èŠå¤©æœºå™¨äººï¼Œç”šè‡³è¿æŸ¥è¯¢å¤©æ°”éƒ½åšä¸åˆ°ã€‚ç”±äºåº•å±‚æŠ€æœ¯é™åˆ¶å•Šï¼Œå¤§æ¨¡å‹æœ¬èº«æ˜¯æ— æ³•å’Œå¤–éƒ¨å·¥å…·ç›´æ¥é€šä¿¡çš„ï¼Œå› æ­¤Function callingçš„æ€è·¯ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªå¤–éƒ¨å‡½æ•°ï¼ˆfunctionï¼‰ä½œä¸ºä¸­ä»‹ï¼Œä¸€è¾¹ä¼ é€’å¤§æ¨¡å‹çš„è¯·æ±‚ï¼Œå¦ä¸€è¾¹è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼Œæœ€ç»ˆè®©å¤§æ¨¡å‹èƒ½å¤Ÿé—´æ¥çš„è°ƒç”¨å¤–éƒ¨å·¥å…·ã€‚

![](images/e77dd815-114b-41aa-8a5b-f5edaec566e3.png)

ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬è¦æŸ¥è¯¢å½“å‰å¤©æ°”æ—¶ï¼Œè®©å¤§æ¨¡å‹è°ƒç”¨å¤–éƒ¨å·¥å…·çš„function callingçš„è¿‡ç¨‹å°±å¦‚å›¾æ‰€ç¤ºï¼š

![](images/86ab9813-d114-4b0e-b498-fe18e01ec733.png)

Function callingæ˜¯ä¸ªéå¸¸ä¸é”™çš„æŠ€æœ¯è®¾è®¡ï¼Œè‡ªè¯ç”Ÿä»¥æ¥ï¼Œä¸€ç›´è¢«ä¸šå†…å¥‰ä¸ºåœ­è‡¬ã€‚ä½†å”¯ä¸€çš„é—®é¢˜å°±æ˜¯ï¼Œç¼–å†™è¿™ä¸ªå¤–éƒ¨å‡½æ•°çš„å·¥ä½œé‡å¤ªå¤§äº†ï¼Œä¸€ä¸ªç®€å•çš„å¤–éƒ¨å‡½æ•°å¾€å¾€å°±å¾—ä¸Šç™¾è¡Œä»£ç ï¼Œè€Œä¸”ï¼Œä¸ºäº†è®©å¤§æ¨¡å‹â€œè®¤è¯†â€è¿™äº›å¤–éƒ¨å‡½æ•°ï¼Œæˆ‘ä»¬è¿˜è¦é¢å¤–ä¸ºæ¯ä¸ªå¤–éƒ¨å‡½æ•°ç¼–å†™ä¸€ä¸ªJSON Schemaæ ¼å¼çš„åŠŸèƒ½è¯´æ˜ï¼Œæ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç²¾å¿ƒè®¾è®¡ä¸€ä¸ªæç¤ºè¯æ¨¡ç‰ˆï¼Œæ‰èƒ½æé«˜Function callingå“åº”çš„å‡†ç¡®ç‡ã€‚

è€ŒMCPçš„ç›®æ ‡ï¼Œå°±æ˜¯èƒ½åœ¨Agentå¼€å‘è¿‡ç¨‹ä¸­ï¼Œè®©å¤§æ¨¡å‹æ›´åŠ ä¾¿æ·çš„è°ƒç”¨å¤–éƒ¨å·¥å…·ã€‚ä¸ºæ­¤ï¼ŒMCPæå‡ºäº†ä¸¤ä¸ªæ–¹æ¡ˆï¼Œå…¶ä¸€ï¼Œâ€œ**è½¦åŒè½¨ã€ä¹¦åŒæ–‡**â€ï¼Œç»Ÿä¸€Function callingçš„è¿è¡Œè§„èŒƒã€‚

é¦–å…ˆæ˜¯å…ˆç»Ÿä¸€åç§°ï¼ŒMCPæŠŠå¤§æ¨¡å‹è¿è¡Œç¯å¢ƒç§°ä½œ MCP Clientï¼Œä¹Ÿå°±æ˜¯MCPå®¢æˆ·ç«¯ï¼ŒåŒæ—¶ï¼ŒæŠŠå¤–éƒ¨å‡½æ•°è¿è¡Œç¯å¢ƒç§°ä½œMCP Serverï¼Œä¹Ÿå°±æ˜¯MCPæœåŠ¡å™¨ï¼Œ

![](images/84aa2b14-b18e-4101-89f8-f6a26f367ce2.png)

ç„¶åï¼Œç»Ÿä¸€MCPå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„è¿è¡Œè§„èŒƒï¼Œå¹¶ä¸”è¦æ±‚MCPå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ï¼Œä¹Ÿç»Ÿä¸€æŒ‰ç…§æŸä¸ªæ—¢å®šçš„æç¤ºè¯æ¨¡æ¿è¿›è¡Œé€šä¿¡ã€‚

â€œè½¦åŒè½¨ã€ä¹¦åŒæ–‡â€æœ€å¤§çš„å¥½å¤„å°±åœ¨äºï¼Œå¯ä»¥é¿å…MCPæœåŠ¡å™¨çš„é‡å¤å¼€å‘ï¼Œä¹Ÿå°±æ˜¯é¿å…å¤–éƒ¨å‡½æ•°é‡å¤ç¼–å†™ã€‚ä¾‹å¦‚ï¼ŒåƒæŸ¥è¯¢å¤©æ°”ã€ç½‘é¡µçˆ¬å–ã€æŸ¥è¯¢æœ¬åœ°MySQLæ•°æ®åº“è¿™ç§é€šç”¨çš„éœ€æ±‚ï¼Œå¤§å®¶æœ‰ä¸€ä¸ªäººå¼€å‘äº†ä¸€ä¸ªæœåŠ¡å™¨å°±å¥½ï¼Œå¼€å‘å®Œå¤§å®¶éƒ½èƒ½å¤åˆ¶åˆ°è‡ªå·±çš„é¡¹ç›®é‡Œæ¥ä½¿ç”¨ï¼Œä¸ç”¨æ¯ä¸ªäººæ¯æ¬¡éƒ½å•ç‹¬å†™ä¸€å¥—ã€‚

è¿™å¯æ˜¯ä¿ƒè¿›å…¨çƒAIå¼€å‘è€…å…±åŒåä½œçš„å¥½äº‹å„¿ï¼Œå¾ˆå¿«ï¼ŒGitHubä¸Šå°±å‡ºç°äº†æµ·é‡çš„å·²ç»å¼€å‘å¥½çš„MCP æœåŠ¡å™¨ï¼Œä»SQLæ•°æ®åº“æ£€ç´¢ã€åˆ°ç½‘é¡µæµè§ˆä¿¡æ¯çˆ¬å–ï¼Œä»å‘½ä»¤è¡Œæ“ä½œç”µè„‘ã€åˆ°æ•°æ®åˆ†ææœºå™¨å­¦ä¹ å»ºæ¨¡ï¼Œç­‰ç­‰ç­‰ç­‰ï¼Œä¸ä¸€è€Œè¶³ã€‚

![](images/f97c0b47-287c-4476-bd80-0bff52ecbee6.png)

ç°åœ¨ï¼Œåªè¦ä½ æœ¬åœ°è¿è¡Œçš„å¤§æ¨¡å‹æ”¯æŒMCPåè®®ï¼Œä¹Ÿå°±æ˜¯åªè¦å®‰è£…äº†ç›¸å…³çš„åº“ï¼Œä»…éœ€å‡ è¡Œä»£ç å³å¯æ¥å…¥è¿™äº›æµ·é‡çš„å¤–éƒ¨å·¥å…·ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰Agentå¼€å‘é—¨æ§›ç¬é—´é™ä½äº†å‘¢ã€‚

è¿™ç§â€œè½¦åŒè½¨ã€ä¹¦åŒæ–‡â€çš„è§„èŒƒï¼Œåœ¨æŠ€æœ¯é¢†åŸŸå°±è¢«ç§°ä½œåè®®ï¼Œä¾‹å¦‚httpå°±æ˜¯ç½‘ç»œä¿¡æ¯äº¤æ¢çš„æŠ€æœ¯åè®®ã€‚å„ç±»æŠ€æœ¯åè®®çš„ç›®æ ‡ï¼Œéƒ½æ˜¯å¸Œæœ›**é€šè¿‡æé«˜åä½œæ•ˆç‡æ¥æå‡å¼€å‘æ•ˆç‡**ï¼Œè€ŒMCPï¼ŒModel Context Protocolï¼Œå°±æ˜¯ä¸€ç§æ—¨åœ¨æé«˜å¤§æ¨¡å‹Agentå¼€å‘æ•ˆç‡çš„æŠ€æœ¯åè®®ã€‚

é‚£æ—¢ç„¶æ˜¯åè®®ï¼Œå¿…ç„¶æ˜¯ä½¿ç”¨çš„äººè¶Šå¤šæ‰è¶Šæœ‰ç”¨ã€‚å› æ­¤ï¼Œä¸ºäº†è¿›ä¸€æ™®åŠMCPåè®®ï¼ŒAnthropicè¿˜æä¾›äº†ä¸€æ•´å¥—MCPå®¢æˆ·ç«¯ã€æœåŠ¡å™¨å¼€å‘çš„SDKï¼Œä¹Ÿå°±æ˜¯å¼€å‘å·¥å…·ï¼Œå¹¶ä¸”æ”¯æŒPythonã€TSå’ŒJavaç­‰å¤šç§è¯­è¨€ï¼Œå€ŸåŠ©SDKï¼Œä»…éœ€å‡ è¡Œä»£ç ï¼Œå°±å¯ä»¥å¿«é€Ÿå¼€å‘ä¸€ä¸ªMCPæœåŠ¡å™¨ã€‚

![](images/0581d67b-0684-47c6-9a86-8f0268cd6589.png)

ç„¶åï¼Œä½ å°±å¯ä»¥æŠŠå®ƒæ¥å…¥ä»»æ„ä¸€ä¸ªMCPå®¢æˆ·ç«¯æ¥æ„å»ºæ™ºèƒ½ä½“ï¼Œå¦‚æœæ„¿æ„ï¼Œè¿˜å¯ä»¥æŠŠMCPæœåŠ¡å™¨åˆ†äº«åˆ°ç¤¾åŒºï¼Œç»™æœ‰éœ€æ±‚çš„å¼€å‘è€…ä½¿ç”¨ï¼Œç”šè‡³ä½ è¿˜å¯ä»¥æŠŠä½ çš„MCPæœåŠ¡å™¨æ”¾åˆ°çº¿ä¸Šè¿è¡Œï¼Œè®©ç”¨æˆ·ä»˜è´¹ä½¿ç”¨ã€‚

è€ŒMCPçš„å®¢æˆ·ç«¯ï¼Œä¸ä»…æ”¯æŒClaudeæ¨¡å‹ï¼Œä¹Ÿæ”¯æŒä»»æ„æœ¬åœ°æ¨¡å‹æˆ–è€…åœ¨çº¿å¤§æ¨¡å‹ï¼Œæˆ–è€…æ˜¯ä¸€äº›IDEã€‚ä¾‹å¦‚ï¼Œç°åœ¨Cursoræ­£å¼æ¥å…¥MCPï¼Œä»£è¡¨ç€Cursoræ­£å¼æˆä¸ºMCPå®¢æˆ·ç«¯ï¼Œåœ¨Cursorä¸­ï¼Œæˆ‘ä»¬ä¸ä»…èƒ½å¿«é€Ÿç¼–å†™MCPæœåŠ¡å™¨ï¼ˆå¤–éƒ¨å‡½æ•°ï¼‰ï¼Œæ›´èƒ½å€ŸåŠ©Cursorä¸€é”®è¿æ¥ä¸Šæˆç™¾ä¸Šåƒçš„å¼€æºMCPæœåŠ¡å™¨ï¼Œè®©å¤§æ¨¡å‹å¿«é€Ÿæ¥å…¥æµ·é‡å·¥å…·ï¼Œä»è€Œå¤§å¹…åŠ å¿«Agentå¼€å‘è¿›åº¦ã€‚

![](images/bfdead8a-8b2d-49f1-97d8-2a9f39295c86.png)

### 2. Function callingæŠ€æœ¯å›é¡¾

![](images/c36e1d16-7248-48c5-984e-c910c52edceb.png)

### 3. å¤§æ¨¡å‹Agentå¼€å‘æŠ€æœ¯ä½“ç³»å›é¡¾

* å‚è€ƒå…¬å¼€è¯¾ã€Šé›¶åŸºç¡€Agentæ™ºèƒ½ä½“å¼€å‘åŸºç¡€ç†è®ºè¯¦è§£ï¼ã€‹ï¼šhttps://www.bilibili.com/video/BV1CcBJYtEne/

![](images/4129b919-c0d1-4ce0-88f7-df08ce06c32f.png)

* æ›´å¤šMCPç¤ºæ„å›¾

![](images/bc05ac5d-3de4-4ba6-b29f-be0ff6b1bd76.png)

&#x20;

![](images/84e6332a-21af-42ef-9ba0-2255f0bd5f36.png)

&#x20;

![](images/default.png)

&#x20;

![](images/0361d14d-af12-4925-9c4d-7aa81be18714.png)

## äºŒã€MCPå®¢æˆ·ç«¯Clientå¼€å‘æµç¨‹

### 1. uvå·¥å…·å…¥é—¨ä½¿ç”¨æŒ‡å—

#### 1.1 uvå…¥é—¨ä»‹ç»

&#x20;       MCPå¼€å‘è¦æ±‚å€ŸåŠ©uvè¿›è¡Œè™šæ‹Ÿç¯å¢ƒåˆ›å»ºå’Œä¾èµ–ç®¡ç†ã€‚`uv` æ˜¯ä¸€ä¸ª**Python ä¾èµ–ç®¡ç†å·¥å…·**ï¼Œç±»ä¼¼äº `pip` å’Œ `conda`ï¼Œä½†å®ƒæ›´å¿«ã€æ›´é«˜æ•ˆï¼Œå¹¶ä¸”å¯ä»¥æ›´å¥½åœ°ç®¡ç† Python è™šæ‹Ÿç¯å¢ƒå’Œä¾èµ–é¡¹ã€‚å®ƒçš„æ ¸å¿ƒç›®æ ‡æ˜¯**æ›¿ä»£ `pip`ã€`venv` å’Œ `pip-tools`**ï¼Œæä¾›æ›´å¥½çš„æ€§èƒ½å’Œæ›´ä½çš„ç®¡ç†å¼€é”€ã€‚

**`uv` çš„ç‰¹ç‚¹**ï¼š

1. **é€Ÿåº¦æ›´å¿«**ï¼šç›¸æ¯” `pip`ï¼Œ`uv` é‡‡ç”¨ Rust ç¼–å†™ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚

2. **æ”¯æŒ PEP 582**ï¼šæ— éœ€ `virtualenv`ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `__pypackages__` è¿›è¡Œç®¡ç†ã€‚

3. **å…¼å®¹ `pip`**ï¼šæ”¯æŒ `requirements.txt` å’Œ `pyproject.toml` ä¾èµ–ç®¡ç†ã€‚

4. **æ›¿ä»£ `venv`**ï¼šæä¾› `uv venv` è¿›è¡Œè™šæ‹Ÿç¯å¢ƒç®¡ç†ï¼Œæ¯” `venv` æ›´è½»é‡ã€‚

5. **è·¨å¹³å°**ï¼šæ”¯æŒ Windowsã€macOS å’Œ Linuxã€‚

#### 1.2 uvå®‰è£…æµç¨‹

**æ–¹æ³• 1ï¼šä½¿ç”¨ `pip` å®‰è£…ï¼ˆé€‚ç”¨äºå·²å®‰è£… `pip` çš„ç³»ç»Ÿï¼‰**

```bash
pip install uv
```

**æ–¹æ³• 2ï¼šä½¿ç”¨ `curl` ç›´æ¥å®‰è£…**

å¦‚æœä½ çš„ç³»ç»Ÿæ²¡æœ‰ `pip`ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œï¼š

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

è¿™ä¼šè‡ªåŠ¨ä¸‹è½½ `uv` å¹¶å®‰è£…åˆ° `/usr/local/bin`ã€‚

#### 1.3 uvçš„åŸºæœ¬ç”¨æ³•ä»‹ç»

&#x20;       å®‰è£… `uv` åï¼Œä½ å¯ä»¥åƒ `pip` ä¸€æ ·ä½¿ç”¨å®ƒï¼Œä½†å®ƒçš„è¯­æ³•æ›´ç®€æ´ï¼Œé€Ÿåº¦ä¹Ÿæ›´å¿«ã€‚æ³¨æ„ï¼Œä»¥ä¸‹ä¸ºä½¿ç”¨è¯­æ³•ç¤ºä¾‹ï¼Œä¸ç”¨å®é™…è¿è¡Œã€‚

* **å®‰è£… Python ä¾èµ–**

```bash
uv pip install requests
```

ä¸ `pip install requests` ç±»ä¼¼ï¼Œä½†æ›´å¿«ã€‚

* **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**

```bash
uv venv myenv
```

ç­‰æ•ˆäº `python -m venv myenv`ï¼Œä½†æ›´é«˜æ•ˆã€‚

* **æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ**

```bash
source myenv/bin/activate  # Linux/macOS
myenv\Scripts\activate     # Windows
```

* **å®‰è£… `requirements.txt`**

```bash
uv pip install -r requirements.txt
```

* **ç›´æ¥è¿è¡Œ Python é¡¹ç›®**

å¦‚æœé¡¹ç›®ä¸­åŒ…å« `pyproject.toml`ï¼Œä½ å¯ä»¥ç›´æ¥è¿è¡Œï¼š

```bash
uv run python script.py
```

è¿™ç­‰æ•ˆäºï¼š

```bash
pip install -r requirements.txt
python script.py
```

ä½† `uv` é€Ÿåº¦æ›´å¿«ï¼Œç®¡ç†æ›´é«˜æ•ˆã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•å…ˆæ„å»ºä¸€ä¸ª MCP å®¢æˆ·ç«¯ï¼Œç¡®ä¿åŸºæœ¬é€»è¾‘å¯ç”¨ï¼Œç„¶åå†é€æ­¥æ­å»º MCP æœåŠ¡å™¨è¿›è¡Œè”è°ƒï¼Œè¿™æ ·å¯ä»¥**åˆ†é˜¶æ®µæ’æŸ¥é—®é¢˜**ï¼Œé¿å…ä¸€ä¸Šæ¥å°±æ¶‰åŠå¤ªå¤šå¤æ‚æ€§ã€‚

### 2.MCPæç®€å®¢æˆ·ç«¯æ­å»ºæµç¨‹

#### 2.1 åˆ›å»º MCP å®¢æˆ·ç«¯é¡¹ç›®

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
uv init mcp-client
cd mcp-client
```

![](images/7f5cddc6-0f7e-45e2-a05e-7f92f92e1d42.png)

&#x20;

![](images/f6c675d9-bbe9-4a18-9e3b-8f8e1bb9d999.png)

#### 2.2 åˆ›å»ºMCPå®¢æˆ·ç«¯è™šæ‹Ÿç¯å¢ƒ

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
uv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate
```

![](images/560ceb0c-976f-4b28-9e6f-a6de9b0aa23f.png)

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›¸æ¯”pipï¼Œuvä¼šè‡ªåŠ¨è¯†åˆ«å½“å‰é¡¹ç›®ä¸»ç›®å½•å¹¶åˆ›å»ºè™šæ‹Ÿç¯å¢ƒã€‚

ç„¶åå³å¯é€šè¿‡addæ–¹æ³•åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…ç›¸å…³çš„åº“ã€‚

```bash
# å®‰è£… MCP SDK
uv add mcp
```

![](images/f1cb75f2-e671-425f-b778-f222296927ed.png)

#### 2.3 ç¼–å†™åŸºç¡€ MCP å®¢æˆ·ç«¯

ç„¶ååœ¨å½“å‰é¡¹ç›®ä¸»ç›®å½•ä¸­\*\*åˆ›å»º `client.py` \*\*

![](images/cad3d39d-52d6-40f0-9378-178baf30c0fb.png)

å¹¶å†™å…¥ä»¥ä¸‹ä»£ç 

```python
import asyncio
from mcp import ClientSession
from contextlib import AsyncExitStack

class MCPClient:
    def __init__(self):
        """åˆå§‹åŒ– MCP å®¢æˆ·ç«¯"""
        self.session = None
        self.exit_stack = AsyncExitStack()

    async def connect_to_mock_server(self):
        """æ¨¡æ‹Ÿ MCP æœåŠ¡å™¨çš„è¿æ¥ï¼ˆæš‚ä¸è¿æ¥çœŸå®æœåŠ¡å™¨ï¼‰"""
        print("âœ… MCP å®¢æˆ·ç«¯å·²åˆå§‹åŒ–ï¼Œä½†æœªè¿æ¥åˆ°æœåŠ¡å™¨")

    async def chat_loop(self):
        """è¿è¡Œäº¤äº’å¼èŠå¤©å¾ªç¯"""
        print("\nMCP å®¢æˆ·ç«¯å·²å¯åŠ¨ï¼è¾“å…¥ 'quit' é€€å‡º")

        while True:
            try:
                query = input("\nQuery: ").strip()
                if query.lower() == 'quit':
                    break
                print(f"\nğŸ¤– [Mock Response] ä½ è¯´çš„æ˜¯ï¼š{query}")
            except Exception as e:
                print(f"\nâš ï¸ å‘ç”Ÿé”™è¯¯: {str(e)}")

    async def cleanup(self):
        """æ¸…ç†èµ„æº"""
        await self.exit_stack.aclose()

async def main():
    client = MCPClient()
    try:
        await client.connect_to_mock_server()
        await client.chat_loop()
    finally:
        await client.cleanup()

if __name__ == "__main__":
    asyncio.run(main())
```

![](images/eb933aa9-da29-46bb-b18a-6f5555f94d1d.png)

è¿™æ®µä»£ç èƒ½å¤Ÿåˆå§‹åŒ– MCP å®¢æˆ·ç«¯ï¼ˆä½†ä¸è¿æ¥æœåŠ¡å™¨ï¼‰ï¼Œå¹¶æä¾›ä¸€ä¸ª **äº¤äº’å¼ CLI**ï¼Œå¯ä»¥è¾“å…¥æŸ¥è¯¢ï¼ˆä½†åªè¿”å›æ¨¡æ‹Ÿå›å¤ï¼‰ï¼Œé€šè¿‡**è¾“å…¥ `quit` é€€å‡ºç¨‹åº**ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯æ²¡æœ‰å…³è”ä»»ä½•å¤§æ¨¡å‹ï¼Œå› æ­¤åªä¼šé‡å¤ç”¨æˆ·çš„è¾“å…¥ã€‚

#### 2.4 MCPå®¢æˆ·ç«¯åŸºæœ¬ä»£ç ç»“æ„

ä»¥ä¸‹æ˜¯`client.py` ä»£ç è¯¦è§£ï¼Œ**ä»£ç æ ¸å¿ƒåŠŸèƒ½**ï¼š

* **åˆå§‹åŒ– MCP å®¢æˆ·ç«¯**

* \*æä¾›ä¸€ä¸ªå‘½ä»¤è¡Œäº¤äº’ç•Œé¢

* æ¨¡æ‹Ÿ MCP æœåŠ¡å™¨è¿æ¥

* æ”¯æŒç”¨æˆ·è¾“å…¥æŸ¥è¯¢å¹¶è¿”å›ã€Œæ¨¡æ‹Ÿå›å¤ã€

* **æ”¯æŒå®‰å…¨é€€å‡º**

ä»£ç å…·ä½“è§£é‡Šå¦‚ä¸‹ï¼šé¦–å…ˆæ˜¯**å¯¼å…¥å¿…è¦çš„åº“**

```python
import asyncio  # è®©ä»£ç æ”¯æŒå¼‚æ­¥æ“ä½œ
from mcp import ClientSession  # MCP å®¢æˆ·ç«¯ä¼šè¯ç®¡ç†
from contextlib import AsyncExitStack  # èµ„æºç®¡ç†ï¼ˆç¡®ä¿å®¢æˆ·ç«¯å…³é—­æ—¶é‡Šæ”¾èµ„æºï¼‰
```

ğŸ“Œ **è§£é‡Š**ï¼š

* `asyncio`ï¼šPython å†…ç½®çš„**å¼‚æ­¥ç¼–ç¨‹åº“**ï¼Œè®© MCP å¯ä»¥**éé˜»å¡åœ°**æ‰§è¡Œä»»åŠ¡ï¼ˆæ¯”å¦‚èŠå¤©ã€æŸ¥è¯¢ï¼‰ã€‚

* `mcp.ClientSession`ï¼šç”¨äº**ç®¡ç† MCP å®¢æˆ·ç«¯ä¼šè¯**ï¼ˆä½†ç›®å‰æˆ‘ä»¬å…ˆä¸è¿æ¥ MCP æœåŠ¡å™¨ï¼‰ã€‚

* `AsyncExitStack`ï¼š**è‡ªåŠ¨ç®¡ç†èµ„æº**ï¼Œç¡®ä¿ç¨‹åºé€€å‡ºæ—¶æ­£ç¡®å…³é—­ MCP è¿æ¥ã€‚

ç„¶å**åˆ›å»º `MCPClient` ç±»**

```python
class MCPClient:
    def __init__(self):
        """åˆå§‹åŒ– MCP å®¢æˆ·ç«¯"""
        self.session = None  # å…ˆä¸è¿æ¥ MCP æœåŠ¡å™¨
        self.exit_stack = AsyncExitStack()  # åˆ›å»ºèµ„æºç®¡ç†å™¨
```

ğŸ“Œ **è§£é‡Š**ï¼š

* `self.session = None`ï¼š**æš‚æ—¶ä¸è¿æ¥ MCP æœåŠ¡å™¨**ï¼Œåç»­å¯ä»¥ä¿®æ”¹æ¥çœŸæ­£è¿æ¥ã€‚

* `self.exit_stack = AsyncExitStack()`ï¼š**ç®¡ç† MCP å®¢æˆ·ç«¯çš„èµ„æº**ï¼Œç¡®ä¿ç¨‹åºé€€å‡ºæ—¶å¯ä»¥æ­£ç¡®é‡Šæ”¾èµ„æºã€‚

ç´§æ¥ç€**æ¨¡æ‹Ÿ MCP æœåŠ¡å™¨è¿æ¥**

```python
async def connect_to_mock_server(self):
    """æ¨¡æ‹Ÿ MCP æœåŠ¡å™¨çš„è¿æ¥ï¼ˆæš‚ä¸è¿æ¥çœŸå®æœåŠ¡å™¨ï¼‰"""
    print("âœ… MCP å®¢æˆ·ç«¯å·²åˆå§‹åŒ–ï¼Œä½†æœªè¿æ¥åˆ°æœåŠ¡å™¨")
```

ğŸ“Œ **è§£é‡Š**ï¼š

* è¿™ä¸ªå‡½æ•°**ä¸ä¼šçœŸçš„è¿æ¥ MCP æœåŠ¡å™¨**ï¼Œåªæ˜¯æ‰“å°ä¸€æ¡ä¿¡æ¯ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å·²ç»åˆå§‹åŒ–ã€‚

* `async def`ï¼šå› ä¸ºæˆ‘ä»¬ç”¨çš„æ˜¯ **å¼‚æ­¥ç¼–ç¨‹**ï¼Œæ‰€ä»¥éœ€è¦ç”¨ `async` å…³é”®å­—ã€‚

ç„¶ååˆ›å»º**äº¤äº’å¼èŠå¤©å¾ªç¯**

```python
async def chat_loop(self):
    """è¿è¡Œäº¤äº’å¼èŠå¤©å¾ªç¯"""
    print("\nMCP å®¢æˆ·ç«¯å·²å¯åŠ¨ï¼è¾“å…¥ 'quit' é€€å‡º")

    while True:  # æ— é™å¾ªç¯ï¼Œç›´åˆ°ç”¨æˆ·è¾“å…¥ 'quit'
        try:
            query = input("\nQuery: ").strip()  # è®©ç”¨æˆ·è¾“å…¥é—®é¢˜
            if query.lower() == 'quit':  # å¦‚æœç”¨æˆ·è¾“å…¥ quitï¼Œé€€å‡ºå¾ªç¯
                break
            print(f"\nğŸ¤– [Mock Response] ä½ è¯´çš„æ˜¯ï¼š{query}")  # è¿”å›æ¨¡æ‹Ÿå›å¤
        except Exception as e:  # å‘ç”Ÿé”™è¯¯æ—¶æ•è·å¼‚å¸¸
            print(f"\nâš ï¸ å‘ç”Ÿé”™è¯¯: {str(e)}")
```

ğŸ“Œ **è§£é‡Š**ï¼š

1. `while True`ï¼š**æ— é™å¾ªç¯**ï¼Œè®©ç”¨æˆ·å¯ä»¥ä¸æ–­è¾“å…¥æŸ¥è¯¢ã€‚

2. `query = input("\nQuery: ").strip()`ï¼š**è·å–ç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢**ã€‚

3. `if query.lower() == 'quit'`ï¼š**å¦‚æœç”¨æˆ·è¾“å…¥ `quit`ï¼Œé€€å‡ºå¾ªç¯**ã€‚

4. `print(f"\nğŸ¤– [Mock Response] ä½ è¯´çš„æ˜¯ï¼š{query}")`ï¼š**æ¨¡æ‹Ÿ MCP æœåŠ¡å™¨çš„å“åº”**ï¼Œæš‚æ—¶åªæ˜¯å›æ˜¾ç”¨æˆ·è¾“å…¥çš„å†…å®¹ã€‚

ğŸ”¹ **ç¤ºä¾‹è¿è¡Œ**

```plaintext
MCP å®¢æˆ·ç«¯å·²å¯åŠ¨ï¼è¾“å…¥ 'quit' é€€å‡º

Query: ä½ å¥½
ğŸ¤– [Mock Response] ä½ è¯´çš„æ˜¯ï¼šä½ å¥½

Query: è¿™æ˜¯ä»€ä¹ˆï¼Ÿ
ğŸ¤– [Mock Response] ä½ è¯´çš„æ˜¯ï¼šè¿™æ˜¯ä»€ä¹ˆï¼Ÿ

Query: quit  # é€€å‡ºç¨‹åº
```

æœ€åç™½é‚£äº›**é‡Šæ”¾èµ„æº**ä»£ç 

```python
async def cleanup(self):
    """æ¸…ç†èµ„æº"""
    await self.exit_stack.aclose()  # å…³é—­èµ„æºç®¡ç†å™¨
```

ğŸ“Œ **è§£é‡Š**ï¼š

* `aclose()` ç¡®ä¿ç¨‹åºé€€å‡ºæ—¶**æ­£ç¡®å…³é—­ MCP è¿æ¥**ï¼ˆå°½ç®¡ç›®å‰æ²¡æœ‰çœŸæ­£çš„è¿æ¥ï¼‰ã€‚

å¹¶å®šä¹‰\*\*`main()` ä¸»å‡½æ•°\*\*

```python
async def main():
    client = MCPClient()  # åˆ›å»º MCP å®¢æˆ·ç«¯
    try:
        await client.connect_to_mock_server()  # è¿æ¥ï¼ˆæ¨¡æ‹Ÿï¼‰æœåŠ¡å™¨
        await client.chat_loop()  # è¿›å…¥èŠå¤©å¾ªç¯
    finally:
        await client.cleanup()  # ç¡®ä¿é€€å‡ºæ—¶æ¸…ç†èµ„æº
```

ğŸ“Œ **è§£é‡Š**ï¼š

* `client = MCPClient()`ï¼šåˆ›å»ºä¸€ä¸ª MCP å®¢æˆ·ç«¯å®ä¾‹ã€‚

* `await client.connect_to_mock_server()`ï¼šåˆå§‹åŒ– MCP å®¢æˆ·ç«¯ï¼ˆæš‚ä¸è¿æ¥æœåŠ¡å™¨ï¼‰ã€‚

* `await client.chat_loop()`ï¼šå¯åŠ¨äº¤äº’å¼èŠå¤©ã€‚

* `finally:` ç¡®ä¿ **ä¸ç®¡ç¨‹åºæ˜¯å¦å¼‚å¸¸é€€å‡ºï¼Œéƒ½ä¼šæ­£ç¡®é‡Šæ”¾èµ„æº**ã€‚

ä»¥åŠ**è¿è¡Œä»£ç **

```python
if __name__ == "__main__":
    asyncio.run(main())
```

ğŸ“Œ **è§£é‡Š**ï¼š

* `if __name__ == "__main__":`ï¼šç¡®ä¿ä»£ç **åªèƒ½åœ¨ Python ç›´æ¥è¿è¡Œæ—¶æ‰§è¡Œ**ï¼ˆè€Œä¸æ˜¯ä½œä¸ºåº“å¯¼å…¥æ—¶ï¼‰ã€‚

* `asyncio.run(main())`ï¼š**å¯åŠ¨ `main()`ï¼Œè¿è¡Œ MCP å®¢æˆ·ç«¯**ã€‚

MCPä¸­ä¸€ä¸ªåŸºç¡€çš„å®¢æˆ·ç«¯ä»£ç ç»“æ„**æ€»ç»“å¦‚ä¸‹**ï¼š

| **ä»£ç éƒ¨åˆ†**                       | **ä½œç”¨**       |
| ------------------------------ | ------------ |
| **`MCPClient.__init__()`**     | åˆå§‹åŒ– MCP å®¢æˆ·ç«¯  |
| **`connect_to_mock_server()`** | æ¨¡æ‹Ÿ MCP æœåŠ¡å™¨è¿æ¥ |
| **`chat_loop()`**              | æä¾›äº¤äº’å¼èŠå¤©ç•Œé¢    |
| **`cleanup()`**                | é‡Šæ”¾èµ„æº         |
| **`main()`**                   | å¯åŠ¨å®¢æˆ·ç«¯        |
| **`asyncio.run(main())`**      | è¿è¡Œç¨‹åº         |

#### 2.5 **è¿è¡Œ MCP å®¢æˆ·ç«¯**

ç„¶åå°è¯•è¿è¡Œè¿™ä¸ªæç®€çš„MCPå®¢æˆ·ç«¯ï¼š

```bash
uv run client.py
```

è¿è¡Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š

![](images/81309c4f-a46a-4ea6-847f-1e2e1b990c88.png)

&#x20;

![](images/0361d14d-af12-4925-9c4d-7aa81be18714-1.png)

#### 2.6 Jupyterä¸­ä»£ç è¿è¡Œæ•ˆæœ

æ­¤å¤–ï¼ŒMCPå®¢æˆ·ç«¯ä¹Ÿæ˜¯å¯ä»¥åœ¨Jupyterä¸­è¿è¡Œçš„ï¼Œæ­¤æ—¶è¿è¡Œä»£ç å¦‚ä¸‹ï¼š

```python
!pip install mcp
```

```python
import asyncio
import nest_asyncio
from mcp import ClientSession
from contextlib import AsyncExitStack

# è§£å†³ Jupyter Notebook çš„ asyncio äº‹ä»¶å¾ªç¯å†²çª
nest_asyncio.apply()
```

```python
class MCPClient:
    def __init__(self):
        """åˆå§‹åŒ– MCP å®¢æˆ·ç«¯"""
        self.session = None
        self.exit_stack = AsyncExitStack()

    async def connect_to_mock_server(self):
        """æ¨¡æ‹Ÿ MCP æœåŠ¡å™¨çš„è¿æ¥ï¼ˆæš‚ä¸è¿æ¥çœŸå®æœåŠ¡å™¨ï¼‰"""
        print("âœ… MCP å®¢æˆ·ç«¯å·²åˆå§‹åŒ–ï¼Œä½†æœªè¿æ¥åˆ°æœåŠ¡å™¨")

    async def chat_loop(self):
        """è¿è¡Œäº¤äº’å¼èŠå¤©å¾ªç¯"""
        print("\nğŸ“¢ MCP å®¢æˆ·ç«¯å·²å¯åŠ¨ï¼è¾“å…¥ 'quit' é€€å‡º\n")

        while True:
            try:
                # ç›´æ¥ä½¿ç”¨ input() è·å–ç”¨æˆ·è¾“å…¥
                query = input("ğŸ“ è¯·è¾“å…¥æ‚¨çš„é—®é¢˜: ").strip()
                if query.lower() == 'quit':
                    print("\nğŸ‘‹ é€€å‡ºèŠå¤©...")
                    break

                # æ¨¡æ‹ŸæœåŠ¡å™¨è¿”å›å“åº”
                response = f"ğŸ¤– [Mock Response] ä½ è¯´çš„æ˜¯ï¼š{query}"
                print(response)

            except Exception as e:
                print(f"\nâš ï¸ å‘ç”Ÿé”™è¯¯: {str(e)}")

    async def cleanup(self):
        """æ¸…ç†èµ„æº"""
        await self.exit_stack.aclose()

async def main():
    client = MCPClient()
    try:
        await client.connect_to_mock_server()
        await client.chat_loop()
    finally:
        await client.cleanup()
```

ç„¶åå³å¯è¾“å…¥å¦‚ä¸‹ä»£ç å¼€å¯å¯¹è¯ï¼š

```python
# åœ¨ Jupyter Notebook ä¸­è¿è¡Œ
await main()
```

![](images/ecf0e048-2734-4c5a-8402-27b2d139eec8.png)

### 3. MCPå®¢æˆ·ç«¯æ¥å…¥OpenAIã€DeepSeekåœ¨çº¿æ¨¡å‹æµç¨‹

&#x20;       æ¥ä¸‹æ¥å°è¯•åœ¨å®¢æˆ·ç«¯ä¸­æ¥å…¥OpenAIå’ŒDeepSeekç­‰åœ¨çº¿æ¨¡å‹è¿›è¡Œå¯¹è¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºOpenAIå’ŒDeepSeekè°ƒç”¨æ–¹æ³•å‡ ä¹å®Œå…¨ä¸€æ ·ï¼Œå› æ­¤è¿™å¥—æœåŠ¡å™¨clientä»£ç å¯ä»¥åŒæ—¶é€‚ç”¨äºGPTæ¨¡å‹å’ŒDeepSeekå“¦è¡Œã€‚

#### 3.1 æ–°å¢ä¾èµ–

&#x20;       ä¸ºäº†æ”¯æŒè°ƒç”¨OpenAIæ¨¡å‹ï¼Œä»¥åŠåœ¨ç¯å¢ƒå˜é‡ä¸­è¯»å–API-KEYç­‰ä¿¡æ¯ï¼Œéœ€è¦å…ˆå®‰è£…å¦‚ä¸‹ä¾èµ–ï¼š

```bash
uv add mcp openai python-dotenv
```

![](images/735d2525-88ec-4bf2-b9e1-7de78c3ee719.png)

#### 3.2 åˆ›å»º.envæ–‡ä»¶

&#x20;       æ¥ä¸‹æ¥åˆ›å»º.envæ–‡ä»¶ï¼Œå¹¶å†™å…¥OpenAIçš„API-Keyï¼Œä»¥åŠåå‘ä»£ç†åœ°å€ã€‚å€ŸåŠ©åå‘ä»£ç†ï¼Œå›½å†…å¯ä»¥æ— é—¨æ§›ç›´è¿OpenAIå®˜æ–¹æœåŠ¡å™¨ï¼Œå¹¶è°ƒç”¨å®˜æ–¹APIã€‚

![](images/3cc77334-f846-4371-b66f-9468bcbba96b.png)

å†™å…¥å¦‚ä¸‹å†…å®¹

```bash
BASE_URL="åå‘ä»£ç†åœ°å€"
MODEL=gpt-4o
OPENAI_API_KEY="OpenAI-API-Key"
```

![](images/d47e1638-e976-42a4-92aa-b69ef8eea30f.png)

OpenAIæ³¨å†ŒæŒ‡å—ä¸å›½å†…åå‘ä»£ç†é¢†å–åœ°å€ï¼š

![](images/9ab4e06c-5a22-46ac-88d6-c616008c43f0.png)

&#x20;

![](images/0361d14d-af12-4925-9c4d-7aa81be18714-2.png)

è€Œå¦‚æœæ˜¯ä½¿ç”¨DeepSeekæ¨¡å‹ï¼Œåˆ™éœ€è¦åœ¨.envä¸­å†™å…¥å¦‚ä¸‹å†…å®¹ï¼š

```bash
BASE_URL=https://api.deepseek.com
MODEL=deepseek-chat      
OPENAI_API_KEY="DeepSeek API-Key"
```

#### 3.3 ä¿®æ”¹client.pyä»£ç 

æ¥ä¸‹æ¥ä¿®æ”¹å®¢æˆ·ç«¯ä»£ç ï¼š

```python
import asyncio
import os
from openai import OpenAI
from dotenv import load_dotenv
from contextlib import AsyncExitStack

# åŠ è½½ .env æ–‡ä»¶ï¼Œç¡®ä¿ API Key å—åˆ°ä¿æŠ¤
load_dotenv()

class MCPClient:
    def __init__(self):
        
        """åˆå§‹åŒ– MCP å®¢æˆ·ç«¯"""
        self.exit_stack = AsyncExitStack()
        self.openai_api_key = os.getenv("OPENAI_API_KEY")  # è¯»å– OpenAI API Key
        self.base_url = os.getenv("BASE_URL")  # è¯»å– BASE YRL
        self.model = os.getenv("MODEL")  # è¯»å– model
        
        if not self.openai_api_key:
            raise ValueError("âŒ æœªæ‰¾åˆ° OpenAI API Keyï¼Œè¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® OPENAI_API_KEY")
            
        self.client = OpenAI(api_key=self.openai_api_key, base_url=self.base_url) 
        

    async def process_query(self, query: str) -> str:
        """è°ƒç”¨ OpenAI API å¤„ç†ç”¨æˆ·æŸ¥è¯¢"""
        messages = [{"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·å›ç­”é—®é¢˜ã€‚"},
                    {"role": "user", "content": query}]
        
        try:
            # è°ƒç”¨ OpenAI API
            response = await asyncio.get_event_loop().run_in_executor(
                None,
                lambda: self.client.chat.completions.create(
                    model=self.model,
                    messages=messages
                )
            )
            return response.choices[0].message.content
        except Exception as e:
            return f"âš ï¸ è°ƒç”¨ OpenAI API æ—¶å‡ºé”™: {str(e)}"

    async def chat_loop(self):
        """è¿è¡Œäº¤äº’å¼èŠå¤©å¾ªç¯"""
        print("\nğŸ¤– MCP å®¢æˆ·ç«¯å·²å¯åŠ¨ï¼è¾“å…¥ 'quit' é€€å‡º")

        while True:
            try:
                query = input("\nä½ : ").strip()
                if query.lower() == 'quit':
                    break
                
                response = await self.process_query(query)  # å‘é€ç”¨æˆ·è¾“å…¥åˆ° OpenAI API
                print(f"\nğŸ¤– OpenAI: {response}")

            except Exception as e:
                print(f"\nâš ï¸ å‘ç”Ÿé”™è¯¯: {str(e)}")

    async def cleanup(self):
        """æ¸…ç†èµ„æº"""
        await self.exit_stack.aclose()

async def main():
    client = MCPClient()
    try:
        await client.chat_loop()
    finally:
        await client.cleanup()

if __name__ == "__main__":
    asyncio.run(main())
```

#### 3.4 è¿è¡Œclient.py

ç„¶åå³å¯è¾“å…¥å¦‚ä¸‹å‘½ä»¤å¼€å§‹è¿è¡Œå¯¹è¯å®¢æˆ·ç«¯ï¼š

```bash
uv run client.py
```

è¿è¡Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š

![](images/2d8a662f-fa8b-4fae-8d4c-64fb4f7b2f69.png)

#### 3.5 clint.pyä»£ç è§£é‡Š

**åŠ è½½ OpenAI API Key**

```python
from dotenv import load_dotenv
import os

# åŠ è½½ .env æ–‡ä»¶ï¼Œç¡®ä¿ API Key å—åˆ°ä¿æŠ¤
load_dotenv()

self.openai_api_key = os.getenv("OPENAI_API_KEY")  # è¯»å– API Key
if not self.openai_api_key:
    raise ValueError("âŒ æœªæ‰¾åˆ° OpenAI API Keyï¼Œè¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® OPENAI_API_KEY")
```

ğŸ“Œ **è§£é‡Š**

* **`load_dotenv()`**ï¼šè‡ªåŠ¨åŠ è½½ `.env` æ–‡ä»¶ï¼Œé¿å…åœ¨ä»£ç ä¸­ç›´æ¥æš´éœ² API Keyã€‚

* **`os.getenv("OPENAI_API_KEY")`**ï¼šä»ç¯å¢ƒå˜é‡ä¸­è¯»å– `OPENAI_API_KEY`ã€‚

* **`raise ValueError(...)`**ï¼šå¦‚æœ API Key ä¸ºç©ºï¼Œåˆ™æŠ›å‡ºé”™è¯¯ï¼Œæé†’ç”¨æˆ·**å¿…é¡»é…ç½® API Key**ã€‚

ğŸ“Œ **åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå¦‚æœè¿˜æ²¡æœ‰çš„è¯ï¼‰**

```bash
touch .env
```

ğŸ“Œ **åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ  API Key**

```plaintext
OPENAI_API_KEY=ä½ çš„OpenAI API Key
```

**å‘é€ç”¨æˆ·è¾“å…¥åˆ° OpenAI API**

```python
async def process_query(self, query: str) -> str:
    """è°ƒç”¨ OpenAI API å¤„ç†ç”¨æˆ·æŸ¥è¯¢"""
    messages = [
        {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·å›ç­”é—®é¢˜ã€‚"},
        {"role": "user", "content": query}
    ]

    try:
        # è°ƒç”¨ OpenAI GPT-4 API
        response = await asyncio.get_event_loop().run_in_executor(
            None,
            lambda: openai.ChatCompletion.create(
                model="gpt-4",
                messages=messages,
                max_tokens=1000,
                temperature=0.7
            )
        )
        return response["choices"][0]["message"]["content"].strip()
    except Exception as e:
        return f"âš ï¸ è°ƒç”¨ OpenAI API æ—¶å‡ºé”™: {str(e)}"
```

ğŸ“Œ **è§£é‡Š**

* `messages`ï¼šåˆ›å»ºå¯¹è¯ä¸Šä¸‹æ–‡ï¼Œè®© OpenAI çŸ¥é“å¦‚ä½•å›ç­”é—®é¢˜ï¼š

  * **`system` è§’è‰²**ï¼šè®¾å®š AI è§’è‰²ï¼ˆå¦‚â€œä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹â€ï¼‰ã€‚

  * **`user` è§’è‰²**ï¼šå­˜å‚¨ç”¨æˆ·è¾“å…¥ã€‚

* `openai.ChatCompletion.create(...)`

  * `model="gpt-4"`ï¼šä½¿ç”¨ OpenAI çš„ GPT-4 è¿›è¡Œå¯¹è¯ã€‚

  * `messages=messages`ï¼šæä¾›èŠå¤©è®°å½•ï¼Œè®© AI ç”Ÿæˆå›ç­”ã€‚

  * `max_tokens=1000`ï¼šé™åˆ¶ AI ç”Ÿæˆçš„æœ€å¤§å­—æ•°ã€‚

  * `temperature=0.7`ï¼šæ§åˆ¶ AI å›ç­”çš„éšæœºæ€§ï¼ˆè¶Šé«˜è¶Šéšæœºï¼‰ã€‚

* `run_in_executor(...)`ï¼š

  * **å› ä¸º OpenAI API æ˜¯åŒæ­¥çš„ï¼Œä½†æˆ‘ä»¬ç”¨çš„æ˜¯å¼‚æ­¥ä»£ç **

  * è¿™é‡Œç”¨ **`asyncio.get_event_loop().run_in_executor(...)`** **å°† OpenAI API å˜æˆå¼‚æ­¥ä»»åŠ¡**ï¼Œé˜²æ­¢ç¨‹åºå¡é¡¿ã€‚

**äº¤äº’å¼èŠå¤©**

```python
async def chat_loop(self):
    """è¿è¡Œäº¤äº’å¼èŠå¤©å¾ªç¯"""
    print("\nğŸ¤– MCP å®¢æˆ·ç«¯å·²å¯åŠ¨ï¼è¾“å…¥ 'quit' é€€å‡º")

    while True:
        try:
            query = input("\nä½ : ").strip()
            if query.lower() == 'quit':
                break

            response = await self.process_query(query)  # å‘é€ç”¨æˆ·è¾“å…¥åˆ° OpenAI API
            print(f"\nğŸ¤– OpenAI: {response}")

        except Exception as e:
            print(f"\nâš ï¸ å‘ç”Ÿé”™è¯¯: {str(e)}")
```

ğŸ“Œ **è§£é‡Š**

* **è¾“å…¥æŸ¥è¯¢** `query = input("\nä½ : ").strip()`ï¼Œæ”¯æŒå¤šè½®å¯¹è¯ã€‚

* **è°ƒç”¨ `process_query()`**ï¼Œå°†ç”¨æˆ·è¾“å…¥**å‘é€åˆ° OpenAI API å¹¶è·å–å›å¤**ã€‚

* **æ˜¾ç¤º OpenAI ç”Ÿæˆçš„å›å¤**ï¼š`print(f"\nğŸ¤– OpenAI: {response}")`

* **ç”¨æˆ·è¾“å…¥ `quit` é€€å‡º**ã€‚

### 4. MCPå®¢æˆ·ç«¯æ¥å…¥æœ¬åœ°ollamaã€vLLMæ¨¡å‹æµç¨‹

&#x20;       æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­å°è¯•å°†ollamaã€vLLMç­‰æ¨¡å‹è°ƒåº¦æ¡†æ¶æ¥å…¥MCPçš„clientã€‚ç”±äºollamaå’ŒvLLMå‡æ”¯æŒOpenAI APIé£æ ¼è°ƒç”¨æ–¹æ³•ï¼Œå› æ­¤ä¸Šè¿°client.pyå¹¶ä¸éœ€è¦è¿›è¡Œä»»ä½•ä¿®æ”¹ï¼Œæˆ‘ä»¬åªéœ€è¦å¯åŠ¨å“åº”çš„è°ƒåº¦æ¡†æ¶æœåŠ¡ï¼Œç„¶åä¿®æ”¹.envæ–‡ä»¶å³å¯ã€‚

#### 4.1 MCPå®¢æˆ·ç«¯æ¥å…¥æœ¬åœ°ollama

è¿™é‡Œä»¥QwQ-32Bä¸ºä¾‹ï¼Œå°è¯•å€ŸåŠ©ollamaæ¥å…¥MCPå®¢æˆ·ç«¯ã€‚

* å¯åŠ¨ollama

* é¦–å…ˆéœ€è¦å¯åŠ¨ollama

```bash
ollama start
```

![](images/48f0a13b-4e88-450b-988d-da6d136de440.png)

* æµ‹è¯•æ¨¡å‹èƒ½å¦è°ƒç”¨

```bash
ollama list
ollama run qwq
```

![](images/40e821a7-f41c-48e8-95fb-3ecfca5e13a3.png)

* ä¿®æ”¹é…ç½®æ–‡ä»¶

* ç„¶åä¿®æ”¹`.env`é…ç½®æ–‡ä»¶

```bash
BASE_URL=http://localhost:11434/v1/
MODEL=qwq 
OPENAI_API_KEY=ollama
```

![](images/6b8ffc5b-c7cd-4b67-96d7-eda716670bba.png)

* è¿è¡Œclient

* ç„¶åå³å¯è¿è¡ŒMCP clientå®¢æˆ·ç«¯äº†

```bash
uv run client.py
```

* æ­¤æ—¶æ˜¯æ¨ç†æ¨¡å‹ï¼Œå› æ­¤å‡ºç°æ ‡å¿—ï¼š

![](images/cc7bd9db-d965-422a-98c4-f5cc1f471558.png)

#### 4.2 MCPå®¢æˆ·ç«¯æ¥å…¥vLLM

ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠvLLMæ¥å…¥MCPå®¢æˆ·ç«¯ä¸­ã€‚

* å¯åŠ¨vLLMæœåŠ¡

```bash
cd /root/autodl-tmp
CUDA_VISIBLE_DEVICES=0,1 vllm serve ./QwQ-32B --tensor-parallel-size 2
```

* ä¿®æ”¹é…ç½®æ–‡ä»¶

```bash
BASE_URL=http://localhost:8000/v1
MODEL=./QwQ-32B
OPENAI_API_KEY=EMPTY
```

![](images/af09b748-b30c-40ba-b445-aae8cee9da6f.png)

* è¿è¡Œclient

* ç„¶åå³å¯è¿è¡ŒMCP clientå®¢æˆ·ç«¯äº†

```bash
uv run client.py
```

* æ­¤æ—¶æ˜¯æ¨ç†æ¨¡å‹ï¼Œå› æ­¤å‡ºç°æ ‡å¿—ï¼š

![](images/b9be1657-ab7d-4c9a-be5f-45ead3cfa29c.png)

æ­¤æ—¶vLLMåç«¯å“åº”å¦‚ä¸‹ï¼š

![](images/1248becc-9c43-45f1-ace3-7a8a9eae1268.png)

## ä¸‰ã€MCPå¤©æ°”æŸ¥è¯¢æœåŠ¡å™¨serverä¸ä½¿ç”¨

### 1. MCPæœåŠ¡å™¨æ¦‚å¿µä»‹ç»

&#x20;       æ ¹æ®MCPåè®®å®šä¹‰ï¼ŒServerå¯ä»¥æä¾›ä¸‰ç§ç±»å‹çš„æ ‡å‡†èƒ½åŠ›ï¼Œ**Resourcesã€Toolsã€Prompts**ï¼Œæ¯ä¸ªServerå¯åŒæ—¶æä¾›è€…ä¸‰ç§ç±»å‹èƒ½åŠ›æˆ–å…¶ä¸­ä¸€ç§ã€‚

* \*\*Resourcesï¼š\*\*èµ„æºï¼Œç±»ä¼¼äºæ–‡ä»¶æ•°æ®è¯»å–ï¼Œå¯ä»¥æ˜¯æ–‡ä»¶èµ„æºæˆ–æ˜¯APIå“åº”è¿”å›çš„å†…å®¹ã€‚

* \*\*Toolsï¼š\*\*å·¥å…·ï¼Œç¬¬ä¸‰æ–¹æœåŠ¡ã€åŠŸèƒ½å‡½æ•°ï¼Œé€šè¿‡æ­¤å¯æ§åˆ¶LLMå¯è°ƒç”¨å“ªäº›å‡½æ•°ã€‚

* \*\*Promptsï¼š\*\*æç¤ºè¯ï¼Œä¸ºç”¨æˆ·é¢„å…ˆå®šä¹‰å¥½çš„å®Œæˆç‰¹å®šä»»åŠ¡çš„æ¨¡æ¿ã€‚

### 2. MCPæœåŠ¡å™¨é€šè®¯æœºåˆ¶

&#x20;       Model Context Protocolï¼ˆMCPï¼‰æ˜¯ä¸€ç§ç”± Anthropic å¼€æºçš„åè®®ï¼Œæ—¨åœ¨å°†å¤§å‹è¯­è¨€æ¨¡å‹ç›´æ¥è¿æ¥è‡³æ•°æ®æºï¼Œå®ç°æ— ç¼é›†æˆã€‚æ ¹æ® MCP çš„è§„èŒƒï¼Œå½“å‰æ”¯æŒä¸¤ç§ä¼ è¾“æ–¹å¼ï¼šæ ‡å‡†è¾“å…¥è¾“å‡ºï¼ˆstdioï¼‰å’ŒåŸºäº HTTP çš„æœåŠ¡å™¨æ¨é€äº‹ä»¶ï¼ˆSSEï¼‰ã€‚è€Œè¿‘æœŸï¼Œå¼€å‘è€…åœ¨ MCP çš„ GitHub ä»“åº“ä¸­æäº¤äº†ä¸€é¡¹ææ¡ˆï¼Œå»ºè®®é‡‡ç”¨â€œå¯æµå¼ä¼ è¾“çš„ HTTPâ€æ¥æ›¿ä»£ç°æœ‰çš„ HTTP+SSE æ–¹æ¡ˆã€‚æ­¤ä¸¾æ—¨åœ¨è§£å†³å½“å‰è¿œç¨‹ MCP ä¼ è¾“æ–¹å¼çš„å…³é”®é™åˆ¶ï¼ŒåŒæ—¶ä¿ç•™å…¶ä¼˜åŠ¿ã€‚ HTTP å’Œ SSEï¼ˆæœåŠ¡å™¨æ¨é€äº‹ä»¶ï¼‰åœ¨æ•°æ®ä¼ è¾“æ–¹å¼ä¸Šå­˜åœ¨æ˜æ˜¾åŒºåˆ«ï¼š

* **é€šä¿¡æ–¹å¼**ï¼š

  * **HTTP**ï¼šé‡‡ç”¨è¯·æ±‚-å“åº”æ¨¡å¼ï¼Œå®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›å“åº”ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚

  * **SSE**ï¼šå…è®¸æœåŠ¡å™¨é€šè¿‡å•ä¸ªæŒä¹…çš„ HTTP è¿æ¥ï¼ŒæŒç»­å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ï¼Œå®ç°å®æ—¶æ›´æ–°ã€‚

* **è¿æ¥ç‰¹æ€§**ï¼š

  * **HTTP**ï¼šæ¯æ¬¡è¯·æ±‚é€šå¸¸å»ºç«‹æ–°çš„è¿æ¥ï¼Œè™½ç„¶åœ¨ HTTP/1.1 ä¸­å¼•å…¥äº†æŒä¹…è¿æ¥ï¼Œä½†é»˜è®¤æƒ…å†µä¸‹ä»æ˜¯çŸ­è¿æ¥ã€‚

  * **SSE**ï¼šåŸºäºé•¿è¿æ¥ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´ä¿æŒæŒç»­çš„è¿æ¥ï¼ŒæœåŠ¡å™¨å¯ä»¥åœ¨ä»»æ„æ—¶é—´æ¨é€æ•°æ®ã€‚

* **é€‚ç”¨åœºæ™¯**ï¼š

  * **HTTP**ï¼šé€‚ç”¨äºä¼ ç»Ÿçš„è¯·æ±‚-å“åº”åœºæ™¯ï¼Œå¦‚ç½‘é¡µåŠ è½½ã€è¡¨å•æäº¤ç­‰ã€‚

  * **SSE**ï¼šé€‚ç”¨äºéœ€è¦æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®çš„åœºæ™¯ï¼Œå¦‚å®æ—¶é€šçŸ¥ã€è‚¡ç¥¨è¡Œæƒ…æ›´æ–°ç­‰ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSSE ä»…æ”¯æŒæœåŠ¡å™¨å‘å®¢æˆ·ç«¯çš„å•å‘é€šä¿¡ï¼Œè€Œ WebSocket åˆ™æ”¯æŒåŒå‘é€šä¿¡ã€‚

![](images/28d47804-b3a1-49d9-b459-2315f1bc6074.png)

![](images/949b257d-cd78-4eb2-8ef6-327617f0d39c.png)

å…·ä½“æ¥è¯´ï¼ŒMCPå®šä¹‰äº†Clientä¸Serverè¿›è¡Œé€šè®¯çš„åè®®ä¸æ¶ˆæ¯æ ¼å¼ï¼Œå…¶æ”¯æŒä¸¤ç§ç±»å‹é€šè®¯æœºåˆ¶ï¼šæ ‡å‡†è¾“å…¥è¾“å‡ºé€šè®¯ã€åŸºäºSSEçš„HTTPé€šè®¯ï¼Œåˆ†åˆ«å¯¹åº”ç€æœ¬åœ°ä¸è¿œç¨‹é€šè®¯ã€‚Clientä¸Serveré—´ä½¿ç”¨JSON-RPC 2.0æ ¼å¼è¿›è¡Œæ¶ˆæ¯ä¼ è¾“ã€‚

* æœ¬åœ°é€šè®¯ï¼šä½¿ç”¨äº†stdioä¼ è¾“æ•°æ®ï¼Œå…·ä½“æµç¨‹Clientå¯åŠ¨Serverç¨‹åºä½œä¸ºå­è¿›ç¨‹ï¼Œå…¶æ¶ˆæ¯é€šè®¯æ˜¯é€šè¿‡stdin/stdoutè¿›è¡Œçš„ï¼Œæ¶ˆæ¯æ ¼å¼ä¸ºJSON-RPC 2.0ã€‚

* è¿œç¨‹é€šè®¯ï¼šClientä¸Serverå¯ä»¥éƒ¨ç½²åœ¨ä»»ä½•åœ°æ–¹ï¼ŒClientä½¿ç”¨SSEä¸Serverè¿›è¡Œé€šè®¯ï¼Œæ¶ˆæ¯çš„æ ¼å¼ä¸ºJSON-RPC 2.0ï¼ŒServerå®šä¹‰äº†/seeä¸/messagesæ¥å£ç”¨äºæ¨é€ä¸æ¥æ”¶æ•°æ®ã€‚

è¿™é‡Œæˆ‘ä»¬å°è¯•ä¸€ä¸ªå…¥é—¨çº§çš„ç¤ºä¾‹ï¼Œé‚£å°±æ˜¯åˆ›å»ºä¸€ä¸ªå¤©æ°”æŸ¥è¯¢çš„æœåŠ¡å™¨ã€‚é€šè¿‡ä½¿ç”¨OpenWeather APIï¼Œåˆ›å»ºä¸€ä¸ªèƒ½å¤Ÿå®æ—¶æŸ¥è¯¢å¤©æ°”çš„æœåŠ¡å™¨ï¼ˆserverï¼‰ï¼Œå¹¶ä½¿ç”¨stdioæ–¹å¼è¿›è¡Œé€šä¿¡ã€‚

![](images/0db98524-5b4e-4025-bd27-dd3a52643d97.png)

æµ‹è¯•æŸ¥è¯¢æ•ˆæœ

```bash
curl -s "https://api.openweathermap.org/data/2.5/weather?q=Beijing&appid='YOUR_API_KEY'&units=metric&lang=zh_cn"
```

![](images/f2b4487c-df9d-45df-9e64-351c0a403e2f.png)

æµ‹è¯•æ— è¯¯åï¼Œæ¥ä¸‹æ¥å³å¯è¿›å…¥åˆ°åˆ›å»ºserverçš„ç¯èŠ‚ä¸­ã€‚

### 3. å¤©æ°”æŸ¥è¯¢æœåŠ¡å™¨Serveråˆ›å»ºæµç¨‹

#### 3.1 æœåŠ¡å™¨ä¾èµ–å®‰è£…

ç”±äºæˆ‘ä»¬éœ€è¦ä½¿ç”¨httpè¯·æ±‚æ¥æŸ¥è¯¢å¤©æ°”ï¼Œå› æ­¤éœ€è¦åœ¨å½“å‰è™šæ‹Ÿç¯å¢ƒä¸­æ·»åŠ å¦‚ä¸‹ä¾èµ–

```bash
uv add mcp httpx
```

#### 3.2 æœåŠ¡å™¨ä»£ç ç¼–å†™

æ¥ä¸‹æ¥å°è¯•åˆ›å»ºæœåŠ¡å™¨ä»£ç ï¼Œæ­¤æ—¶MCPåŸºæœ¬æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

![](images/5c8b1cc5-75c9-4687-a9fc-476608ecde14.png)

å¯¹åº”serveræœåŠ¡å™¨ä»£ç å¦‚ä¸‹ï¼š

```python
import json
import httpx
from typing import Any
from mcp.server.fastmcp import FastMCP

# åˆå§‹åŒ– MCP æœåŠ¡å™¨
mcp = FastMCP("WeatherServer")

# OpenWeather API é…ç½®
OPENWEATHER_API_BASE = "https://api.openweathermap.org/data/2.5/weather"
API_KEY = "YOUR_API_KEY"  # è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ OpenWeather API Key
USER_AGENT = "weather-app/1.0"

async def fetch_weather(city: str) -> dict[str, Any] | None:
    """
    ä» OpenWeather API è·å–å¤©æ°”ä¿¡æ¯ã€‚
    :param city: åŸå¸‚åç§°ï¼ˆéœ€ä½¿ç”¨è‹±æ–‡ï¼Œå¦‚ Beijingï¼‰
    :return: å¤©æ°”æ•°æ®å­—å…¸ï¼›è‹¥å‡ºé”™è¿”å›åŒ…å« error ä¿¡æ¯çš„å­—å…¸
    """
    params = {
        "q": city,
        "appid": API_KEY,
        "units": "metric",
        "lang": "zh_cn"
    }
    headers = {"User-Agent": USER_AGENT}

    async with httpx.AsyncClient() as client:
        try:
            response = await client.get(OPENWEATHER_API_BASE, params=params, headers=headers, timeout=30.0)
            response.raise_for_status()
            return response.json()  # è¿”å›å­—å…¸ç±»å‹
        except httpx.HTTPStatusError as e:
            return {"error": f"HTTP é”™è¯¯: {e.response.status_code}"}
        except Exception as e:
            return {"error": f"è¯·æ±‚å¤±è´¥: {str(e)}"}

def format_weather(data: dict[str, Any] | str) -> str:
    """
    å°†å¤©æ°”æ•°æ®æ ¼å¼åŒ–ä¸ºæ˜“è¯»æ–‡æœ¬ã€‚
    :param data: å¤©æ°”æ•°æ®ï¼ˆå¯ä»¥æ˜¯å­—å…¸æˆ– JSON å­—ç¬¦ä¸²ï¼‰
    :return: æ ¼å¼åŒ–åçš„å¤©æ°”ä¿¡æ¯å­—ç¬¦ä¸²
    """
    # å¦‚æœä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™å…ˆè½¬æ¢ä¸ºå­—å…¸
    if isinstance(data, str):
        try:
            data = json.loads(data)
        except Exception as e:
            return f"æ— æ³•è§£æå¤©æ°”æ•°æ®: {e}"

    # å¦‚æœæ•°æ®ä¸­åŒ…å«é”™è¯¯ä¿¡æ¯ï¼Œç›´æ¥è¿”å›é”™è¯¯æç¤º
    if "error" in data:
        return f"âš ï¸ {data['error']}"

    # æå–æ•°æ®æ—¶åšå®¹é”™å¤„ç†
    city = data.get("name", "æœªçŸ¥")
    country = data.get("sys", {}).get("country", "æœªçŸ¥")
    temp = data.get("main", {}).get("temp", "N/A")
    humidity = data.get("main", {}).get("humidity", "N/A")
    wind_speed = data.get("wind", {}).get("speed", "N/A")
    # weather å¯èƒ½ä¸ºç©ºåˆ—è¡¨ï¼Œå› æ­¤ç”¨ [0] å‰å…ˆæä¾›é»˜è®¤å­—å…¸
    weather_list = data.get("weather", [{}])
    description = weather_list[0].get("description", "æœªçŸ¥")

    return (
        f"ğŸŒ {city}, {country}\n"
        f"ğŸŒ¡ æ¸©åº¦: {temp}Â°C\n"
        f"ğŸ’§ æ¹¿åº¦: {humidity}%\n"
        f"ğŸŒ¬ é£é€Ÿ: {wind_speed} m/s\n"
        f"ğŸŒ¤ å¤©æ°”: {description}\n"
    )

@mcp.tool()
async def query_weather(city: str) -> str:
    """
    è¾“å…¥æŒ‡å®šåŸå¸‚çš„è‹±æ–‡åç§°ï¼Œè¿”å›ä»Šæ—¥å¤©æ°”æŸ¥è¯¢ç»“æœã€‚
    :param city: åŸå¸‚åç§°ï¼ˆéœ€ä½¿ç”¨è‹±æ–‡ï¼‰
    :return: æ ¼å¼åŒ–åçš„å¤©æ°”ä¿¡æ¯
    """
    data = await fetch_weather(city)
    return format_weather(data)

if __name__ == "__main__":
    # ä»¥æ ‡å‡† I/O æ–¹å¼è¿è¡Œ MCP æœåŠ¡å™¨
    mcp.run(transport='stdio')
```

![](images/13ca7c2e-c832-4ee6-a456-31dfec720eda.png)

ä»£ç è§£é‡Šå¦‚ä¸‹ï¼š

**Part 1. å¼‚æ­¥è·å–å¤©æ°”æ•°æ®**

* å‡½æ•° `fetch_weather(city: str)`

  * ä½¿ç”¨ `httpx.AsyncClient()` å‘é€å¼‚æ­¥ GET è¯·æ±‚åˆ° OpenWeather APIã€‚

  * å¦‚æœè¯·æ±‚æˆåŠŸï¼Œåˆ™è°ƒç”¨ `response.json()` è¿”å›ä¸€ä¸ªå­—å…¸ã€‚

  * å‡ºç°å¼‚å¸¸æ—¶ï¼Œè¿”å›åŒ…å«é”™è¯¯ä¿¡æ¯çš„å­—å…¸ã€‚

**Part 2. æ ¼å¼åŒ–å¤©æ°”æ•°æ®**

* å‡½æ•° `format_weather(data: dict | str)`

  * é¦–å…ˆæ£€æŸ¥ä¼ å…¥çš„æ•°æ®æ˜¯å¦ä¸ºå­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä½¿ç”¨ `json.loads` å°†å…¶è½¬æ¢ä¸ºå­—å…¸ã€‚

  * æ£€æŸ¥æ•°æ®ä¸­æ˜¯å¦åŒ…å« `"error"` å­—æ®µï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥è¿”å›é”™è¯¯æç¤ºã€‚

  * ä½¿ç”¨ `.get()` æ–¹æ³•æå– `name`ã€`sys.country`ã€`main.temp`ã€`main.humidity`ã€`wind.speed` å’Œ `weather[0].description` ç­‰æ•°æ®ï¼Œå¹¶ä¸ºå¯èƒ½ç¼ºå¤±çš„å­—æ®µæä¾›é»˜è®¤å€¼ã€‚

  * å°†æå–çš„ä¿¡æ¯æ‹¼æ¥æˆä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œæ–¹ä¾¿é˜…è¯»ã€‚

**Part 3. MCP å·¥å…· `query_weather(city: str)`**

* å‡½æ•° `query_weather`

  * é€šè¿‡ `@mcp.tool()` è£…é¥°å™¨æ³¨å†Œä¸º MCP æœåŠ¡å™¨çš„å·¥å…·ï¼Œä½¿å…¶èƒ½å¤Ÿè¢«å®¢æˆ·ç«¯è°ƒç”¨ã€‚

  * è°ƒç”¨ `fetch_weather(city)` è·å–å¤©æ°”æ•°æ®ï¼Œç„¶åç”¨ `format_weather(data)` å°†æ•°æ®æ ¼å¼åŒ–ä¸ºæ˜“è¯»æ–‡æœ¬ï¼Œæœ€åè¿”å›è¯¥å­—ç¬¦ä¸²ã€‚

**Part 4. è¿è¡ŒæœåŠ¡å™¨**

* `if __name__ == "__main__":` å—

  * è°ƒç”¨ `mcp.run(transport='stdio')` å¯åŠ¨ MCP æœåŠ¡å™¨ï¼Œé‡‡ç”¨æ ‡å‡† I/O é€šä¿¡æ–¹å¼ï¼Œç­‰å¾…å®¢æˆ·ç«¯è°ƒç”¨ã€‚

æ­¤å¤–ï¼Œä¸Šè¿°ä»£ç æœ‰ä¸¤ä¸ªæ³¨æ„äº‹é¡¹ï¼Œ

1. query\_weatherå‡½æ•°çš„å‡½æ•°è¯´æ˜è‡³å…³é‡è¦ï¼Œç›¸å½“äºæ˜¯æ­¤åå®¢æˆ·ç«¯å¯¹å‡½æ•°è¿›è¡Œè¯†åˆ«çš„åŸºæœ¬ä¾æ®ï¼Œå› æ­¤éœ€è¦è°¨æ…ç¼–å†™ï¼›

2. **å½“æŒ‡å®š `transport='stdio'` è¿è¡Œ MCP æœåŠ¡å™¨æ—¶ï¼Œå®¢æˆ·ç«¯å¿…é¡»åœ¨å¯åŠ¨æ—¶åŒæ—¶å¯åŠ¨å½“å‰è¿™ä¸ªè„šæœ¬ï¼Œå¦åˆ™æ— æ³•é¡ºåˆ©é€šä¿¡**ã€‚è¿™æ˜¯å› ä¸º **`stdio` æ¨¡å¼æ˜¯ä¸€ç§æœ¬åœ°è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼ŒInter-Process Communicationï¼‰æ–¹å¼**ï¼Œå®ƒéœ€è¦æœåŠ¡å™¨ä½œä¸º**å­è¿›ç¨‹**è¿è¡Œï¼Œå¹¶é€šè¿‡æ ‡å‡†è¾“å…¥è¾“å‡ºï¼ˆ`stdin`/`stdout`ï¼‰è¿›è¡Œæ•°æ®äº¤æ¢ã€‚

å› æ­¤ï¼Œå½“æˆ‘ä»¬ç¼–å†™å®ŒæœåŠ¡å™¨åï¼Œå¹¶ä¸èƒ½ç›´æ¥è°ƒç”¨è¿™ä¸ªæœåŠ¡å™¨ï¼Œè€Œæ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„èƒ½å¤Ÿè¿›è¡Œstdioçš„å®¢æˆ·ç«¯ï¼Œæ‰èƒ½é¡ºåˆ©è¿›è¡Œé€šä¿¡ã€‚

### 4. å¤©æ°”æŸ¥è¯¢å®¢æˆ·ç«¯clientåˆ›å»ºæµç¨‹

#### 4.1 ä»£ç ç¼–å†™

```python
import asyncio
import os
import json
from typing import Optional
from contextlib import AsyncExitStack

from openai import OpenAI  
from dotenv import load_dotenv

from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client

# åŠ è½½ .env æ–‡ä»¶ï¼Œç¡®ä¿ API Key å—åˆ°ä¿æŠ¤
load_dotenv()

class MCPClient:
    def __init__(self):
        """åˆå§‹åŒ– MCP å®¢æˆ·ç«¯"""
        self.exit_stack = AsyncExitStack()
        self.openai_api_key = os.getenv("OPENAI_API_KEY")  # è¯»å– OpenAI API Key
        self.base_url = os.getenv("BASE_URL")  # è¯»å– BASE YRL
        self.model = os.getenv("MODEL")  # è¯»å– model
        if not self.openai_api_key:
            raise ValueError("âŒ æœªæ‰¾åˆ° OpenAI API Keyï¼Œè¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® OPENAI_API_KEY")
        self.client = OpenAI(api_key=self.openai_api_key, base_url=self.base_url) # åˆ›å»ºOpenAI client
        self.session: Optional[ClientSession] = None
        self.exit_stack = AsyncExitStack()        

    async def connect_to_server(self, server_script_path: str):
        """è¿æ¥åˆ° MCP æœåŠ¡å™¨å¹¶åˆ—å‡ºå¯ç”¨å·¥å…·"""
        is_python = server_script_path.endswith('.py')
        is_js = server_script_path.endswith('.js')
        if not (is_python or is_js):
            raise ValueError("æœåŠ¡å™¨è„šæœ¬å¿…é¡»æ˜¯ .py æˆ– .js æ–‡ä»¶")

        command = "python" if is_python else "node"
        server_params = StdioServerParameters(
            command=command,
            args=[server_script_path],
            env=None
        )

        # å¯åŠ¨ MCP æœåŠ¡å™¨å¹¶å»ºç«‹é€šä¿¡
        stdio_transport = await self.exit_stack.enter_async_context(stdio_client(server_params))
        self.stdio, self.write = stdio_transport
        self.session = await self.exit_stack.enter_async_context(ClientSession(self.stdio, self.write))

        await self.session.initialize()

        # åˆ—å‡º MCP æœåŠ¡å™¨ä¸Šçš„å·¥å…·
        response = await self.session.list_tools()
        tools = response.tools
        print("\nå·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œæ”¯æŒä»¥ä¸‹å·¥å…·:", [tool.name for tool in tools])     
        
    async def process_query(self, query: str) -> str:
        """
        ä½¿ç”¨å¤§æ¨¡å‹å¤„ç†æŸ¥è¯¢å¹¶è°ƒç”¨å¯ç”¨çš„ MCP å·¥å…· (Function Calling)
        """
        messages = [{"role": "user", "content": query}]
        
        response = await self.session.list_tools()
        
        available_tools = [{
            "type": "function",
            "function": {
                "name": tool.name,
                "description": tool.description,
                "input_schema": tool.inputSchema
            }
        } for tool in response.tools]
        # print(available_tools)
        
        response = self.client.chat.completions.create(
            model=self.model,            
            messages=messages,
            tools=available_tools     
        )
        
        # å¤„ç†è¿”å›çš„å†…å®¹
        content = response.choices[0]
        if content.finish_reason == "tool_calls":
            # å¦‚ä½•æ˜¯éœ€è¦ä½¿ç”¨å·¥å…·ï¼Œå°±è§£æå·¥å…·
            tool_call = content.message.tool_calls[0]
            tool_name = tool_call.function.name
            tool_args = json.loads(tool_call.function.arguments)
            
            # æ‰§è¡Œå·¥å…·
            result = await self.session.call_tool(tool_name, tool_args)
            print(f"\n\n[Calling tool {tool_name} with args {tool_args}]\n\n")
            
            # å°†æ¨¡å‹è¿”å›çš„è°ƒç”¨å“ªä¸ªå·¥å…·æ•°æ®å’Œå·¥å…·æ‰§è¡Œå®Œæˆåçš„æ•°æ®éƒ½å­˜å…¥messagesä¸­
            messages.append(content.message.model_dump())
            messages.append({
                "role": "tool",
                "content": result.content[0].text,
                "tool_call_id": tool_call.id,
            })
            
            # å°†ä¸Šé¢çš„ç»“æœå†è¿”å›ç»™å¤§æ¨¡å‹ç”¨äºç”Ÿäº§æœ€ç»ˆçš„ç»“æœ
            response = self.client.chat.completions.create(
                model=self.model,
                messages=messages,
            )
            return response.choices[0].message.content
            
        return content.message.content
    
    async def chat_loop(self):
        """è¿è¡Œäº¤äº’å¼èŠå¤©å¾ªç¯"""
        print("\nğŸ¤– MCP å®¢æˆ·ç«¯å·²å¯åŠ¨ï¼è¾“å…¥ 'quit' é€€å‡º")

        while True:
            try:
                query = input("\nä½ : ").strip()
                if query.lower() == 'quit':
                    break
                
                response = await self.process_query(query)  # å‘é€ç”¨æˆ·è¾“å…¥åˆ° OpenAI API
                print(f"\nğŸ¤– OpenAI: {response}")

            except Exception as e:
                print(f"\nâš ï¸ å‘ç”Ÿé”™è¯¯: {str(e)}")

    async def cleanup(self):
        """æ¸…ç†èµ„æº"""
        await self.exit_stack.aclose()

async def main():
    if len(sys.argv) < 2:
        print("Usage: python client.py <path_to_server_script>")
        sys.exit(1)

    client = MCPClient()
    try:
        await client.connect_to_server(sys.argv[1])
        await client.chat_loop()
    finally:
        await client.cleanup()

if __name__ == "__main__":
    import sys
    asyncio.run(main())
```

![](images/c3a760c9-eae5-437c-b8fa-3687ac570dfe.png)

#### 4.2 æµ‹è¯•è¿è¡Œ

```bash
# ç¡®è®¤è¿›å…¥åˆ°é¡¹ç›®ç›®å½•
cd /root/autodl-tmp/MCP/mcp-client

# ç¡®è®¤æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate
```

![](images/d75029d6-affa-4dcf-9bbc-33cb618ff996.png)

```bash
uv run client.py server.py
```

ç›´æ¥æé—®`è¯·é—®åŒ—äº¬ä»Šå¤©å¤©æ°”å¦‚ä½•ï¼Ÿ`è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

![](images/dd6aa782-ba46-4c1f-821a-8c9bd83b0b40.png)

QwQ-32Bæ¨ç†ç±»æ¨¡å‹é—®ç­”æ•ˆæœå¦‚ä¸‹ï¼š

![](images/d106a95e-e360-4089-975d-0409fe1510f6.png)

#### 4.3 ä»£ç è§£é‡Š

clientä»£ç æ•´ä¸ªMCPæœåŠ¡çš„æ ¸å¿ƒï¼Œä»¥ä¸‹æ˜¯è¿™æ®µä»£ç çš„è¯¦ç»†è§£é‡Šã€‚

**å¯¼å…¥åŸºæœ¬ç±»**

```python
import asyncio
import os
import json
from typing import Optional
from contextlib import AsyncExitStack

from openai import OpenAI  
from dotenv import load_dotenv

from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client
```

1. å¯¼å…¥å¿…è¦åº“

   * `asyncio`ï¼šæ”¯æŒå¼‚æ­¥ç¼–ç¨‹

   * `os` / `json`ï¼šè¯»å–ç¯å¢ƒå˜é‡ã€è§£æ JSON

   * `typing.Optional`ï¼šç±»å‹æç¤º

   * `contextlib.AsyncExitStack`ï¼šç”¨äºå®‰å…¨ç®¡ç†å¼‚æ­¥èµ„æºï¼ˆå¦‚ MCP è¿æ¥ï¼‰

   * `openai.OpenAI`ï¼šä½ çš„è‡ªå®šä¹‰ OpenAI Client ç±»

   * `dotenv.load_dotenv`ï¼šä» `.env` æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡ï¼ˆå¦‚ API Keyï¼‰

   * **MCP ç›¸å…³**ï¼š`mcp.ClientSession`, `mcp.client.stdio`, `StdioServerParameters`

```python
load_dotenv()
```

* ä» `.env` æ–‡ä»¶ä¸­åŠ è½½ç¯å¢ƒå˜é‡,

```plaintext
OPENAI_API_KEY=sk-xxxxxx
BASE_URL=...
MODEL=...
```

\*\* `MCPClient` ç±»åˆ›å»ºè¿‡ç¨‹\*\*

```python
class MCPClient:
    def __init__(self):
        """åˆå§‹åŒ– MCP å®¢æˆ·ç«¯"""
        self.exit_stack = AsyncExitStack()
        self.openai_api_key = os.getenv("OPENAI_API_KEY")  # è¯»å– OpenAI API Key
        self.base_url = os.getenv("BASE_URL")  # è¯»å– BASE YRL
        self.model = os.getenv("MODEL")  # è¯»å– model
        if not self.openai_api_key:
            raise ValueError("âŒ æœªæ‰¾åˆ° OpenAI API Keyï¼Œè¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® OPENAI_API_KEY")
        self.client = OpenAI(api_key=self.openai_api_key, base_url=self.base_url) # åˆ›å»ºOpenAI client
        self.session: Optional[ClientSession] = None
        self.exit_stack = AsyncExitStack()        
```

1. **`self.exit_stack = AsyncExitStack()`**

   * ç”¨äº **ç»Ÿä¸€ç®¡ç†å¼‚æ­¥ä¸Šä¸‹æ–‡**ï¼ˆå¦‚ MCP è¿æ¥ï¼‰çš„ç”Ÿå‘½å‘¨æœŸã€‚

   * å¯ä»¥åœ¨é€€å‡ºï¼ˆ`cleanup`ï¼‰æ—¶è‡ªåŠ¨å…³é—­ã€‚

2. **è¯»å–ç¯å¢ƒå˜é‡**

   * `openai_api_key`ï¼šOpenAI API Key

   * `base_url`ï¼šæ¨¡å‹è¯·æ±‚çš„ Base URLï¼ˆå¦‚ä½ è‡ªå»ºçš„åä»£åœ°å€ï¼‰

   * `model`ï¼šOpenAI æ¨¡å‹åç§°

3. **åˆå§‹åŒ– `OpenAI` å®¢æˆ·ç«¯**

   * `OpenAI(api_key=self.openai_api_key, base_url=self.base_url)`

   * ä½ è‡ªå®šä¹‰çš„ OpenAI å®¢æˆ·ç«¯ï¼Œç”¨æ¥ä¸ OpenAI Chat Completion API é€šä¿¡ã€‚

4. **`self.session`**

   * ç”¨äºä¿å­˜ **MCP çš„å®¢æˆ·ç«¯ä¼šè¯**ï¼Œé»˜è®¤æ˜¯ `None`ï¼Œç¨åé€šè¿‡ `connect_to_server` è¿›è¡Œè¿æ¥ã€‚

5. **å†æ¬¡å£°æ˜ `self.exit_stack = AsyncExitStack()`**

   * è¿™é‡Œä¸¤æ¬¡èµ‹å€¼å…¶å®æœ‰ç‚¹å†—ä½™ï¼ˆå‰é¢å·²èµ‹å€¼è¿‡ä¸€æ¬¡ï¼‰ã€‚ä¸è¿‡å¹¶ä¸å½±å“åŠŸèƒ½ï¼Œç­‰åŒäºè¦†ç›–æ‰å‰é¢çš„å¯¹è±¡ã€‚å¯èƒ½æ˜¯æ‰‹è¯¯æˆ–è°ƒè¯•æ—¶å¤šå†™äº†ä¸€æ¬¡ã€‚

**`connect_to_server(self, server_script_path: str)`**

```python
async def connect_to_server(self, server_script_path: str):
    ...
```

* **è´Ÿè´£å¯åŠ¨å¹¶è¿æ¥åˆ° MCP æœåŠ¡å™¨**ï¼Œå¹¶åˆ—å‡ºå¯ç”¨å·¥å…·ã€‚

```python
is_python = server_script_path.endswith('.py')
is_js = server_script_path.endswith('.js')
if not (is_python or is_js):
    raise ValueError("æœåŠ¡å™¨è„šæœ¬å¿…é¡»æ˜¯ .py æˆ– .js æ–‡ä»¶")

command = "python" if is_python else "node"
```

* åˆ¤æ–­æœåŠ¡å™¨è„šæœ¬æ˜¯ **Python** è¿˜æ˜¯ **Node.js**ï¼Œé€‰æ‹©å¯¹åº”çš„è¿è¡Œå‘½ä»¤ã€‚

```python
server_params = StdioServerParameters(
    command=command,
    args=[server_script_path],
    env=None
)
```

* `StdioServerParameters`ï¼šå‘Šè¯‰ MCP å®¢æˆ·ç«¯å¦‚ä½•å¯åŠ¨æœåŠ¡å™¨ã€‚

  * `command=command`ï¼šå¦‚ `"python"`

  * `args=[server_script_path]`ï¼šå¦‚ `["weather_server.py"]`

```python
stdio_transport = await self.exit_stack.enter_async_context(stdio_client(server_params))
self.stdio, self.write = stdio_transport
self.session = await self.exit_stack.enter_async_context(ClientSession(self.stdio, self.write))

await self.session.initialize()
```

1. **`stdio_client(server_params)`**ï¼šå¯åŠ¨æœåŠ¡å™¨è¿›ç¨‹ï¼Œå¹¶å»ºç«‹ **æ ‡å‡† I/O** é€šä¿¡ç®¡é“ã€‚

2. **`self.stdio, self.write = stdio_transport`**ï¼šæ‹¿åˆ°è¯»å†™æµã€‚

3. **`ClientSession(...)`**ï¼šåˆ›å»º MCP å®¢æˆ·ç«¯ä¼šè¯ï¼Œä¸æœåŠ¡å™¨äº¤äº’ã€‚

4. **`await self.session.initialize()`**ï¼šå‘é€åˆå§‹åŒ–æ¶ˆæ¯ç»™æœåŠ¡å™¨ï¼Œç­‰å¾…æœåŠ¡å™¨å°±ç»ªã€‚

```python
# åˆ—å‡º MCP æœåŠ¡å™¨ä¸Šçš„å·¥å…·
response = await self.session.list_tools()
tools = response.tools
print("\nå·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œæ”¯æŒä»¥ä¸‹å·¥å…·:", [tool.name for tool in tools])
```

* **`list_tools()`**ï¼šå‘ MCP æœåŠ¡å™¨è¯·æ±‚æ‰€æœ‰å·²æ³¨å†Œçš„å·¥å…·ï¼ˆç”¨ `@mcp.tool()` æ ‡è®°ï¼‰ã€‚

* **æ‰“å°å·¥å…·åˆ—è¡¨**ï¼Œä¾‹å¦‚ `["get_forecast", "query_db", ...]`ã€‚

**`process_query(self, query: str) -> str`**

```python
async def process_query(self, query: str) -> str:
    """
    ä½¿ç”¨å¤§æ¨¡å‹å¤„ç†æŸ¥è¯¢å¹¶è°ƒç”¨å¯ç”¨çš„ MCP å·¥å…· (Function Calling)
    """
    messages = [{"role": "user", "content": query}]
```

* æ”¶åˆ°ç”¨æˆ·è¾“å…¥åï¼Œå…ˆæŠŠå®ƒç»„è£…è¿›ä¸€ä¸ª **`messages` åˆ—è¡¨**ï¼Œç›®å‰åªåŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼ˆ`{"role": "user", "content": query}`ï¼‰ã€‚

```python
response = await self.session.list_tools()
available_tools = [{
    "type": "function",
    "function": {
        "name": tool.name,
        "description": tool.description,
        "input_schema": tool.inputSchema
    }
} for tool in response.tools]
print(available_tools)
```

* è·å–æœåŠ¡å™¨ä¸Šçš„å·¥å…·ï¼Œå†è½¬æ¢æˆ **`available_tools`** çš„æ ¼å¼ã€‚

* è¿™é‡Œä½ è‡ªå®šä¹‰äº†ä¸€ä¸ªç»“æ„ï¼šæ¯ä¸ªå·¥å…·å¯¹åº”ä¸€ä¸ª `{"type": "function", "function": {...}}` çš„å­—å…¸ã€‚

* æ–¹ä¾¿åé¢å‘ç»™ OpenAIï¼Œå‘Šè¯‰å®ƒï¼š**å¯ä»¥è°ƒç”¨è¿™äº›å·¥å…·**ã€‚

```python
response = self.client.chat.completions.create(
    model=self.model,            
    messages=messages,
    tools=available_tools     
)
```

* ä½¿ç”¨ `OpenAI` å®¢æˆ·ç«¯çš„

```plaintext
chat.completions.create
```

* æ–¹æ³•å‘é€è¯·æ±‚ï¼š

  * `model=self.model`ï¼šæ¯”å¦‚ `"gpt-4o"` æˆ– `"deepseek-chat"`

  * `messages=messages`ï¼šèŠå¤©ä¸Šä¸‹æ–‡

  * `tools=available_tools`ï¼šè®©æ¨¡å‹çŸ¥é“æœ‰å“ªäº›å¯è°ƒç”¨çš„ã€Œå‡½æ•°ã€ã€‚è¿™æ˜¯ä½ è‡ªå®šä¹‰çš„\*\*â€œFunction Callingâ€\*\*åè®®ï¼ˆéå®˜æ–¹ JSON schemaï¼‰ã€‚

```python
content = response.choices[0]
if content.finish_reason == "tool_calls":
    # å¦‚æœæ¨¡å‹æƒ³è°ƒç”¨å·¥å…·
    tool_call = content.message.tool_calls[0]
    tool_name = tool_call.function.name
    tool_args = json.loads(tool_call.function.arguments)
    
    # æ‰§è¡Œå·¥å…·
    result = await self.session.call_tool(tool_name, tool_args)
    print(f"\n\n[Calling tool {tool_name} with args {tool_args}]\n\n")
    
    # å°†æ¨¡å‹è¿”å›çš„è°ƒç”¨å“ªä¸ªå·¥å…·æ•°æ®å’Œå·¥å…·æ‰§è¡Œå®Œæˆåçš„æ•°æ®éƒ½å­˜å…¥messagesä¸­
    messages.append(content.message.model_dump())
    messages.append({
        "role": "tool",
        "content": result.content[0].text,
        "tool_call_id": tool_call.id,
    })
    
    # å°†ä¸Šé¢çš„ç»“æœå†è¿”å›ç»™å¤§æ¨¡å‹ç”¨äºç”Ÿäº§æœ€ç»ˆçš„ç»“æœ
    response = self.client.chat.completions.create(
        model=self.model,
        messages=messages,
    )
    return response.choices[0].message.content
    
return content.message.content
```

1. `if content.finish_reason == "tool_calls":`

   * å¦‚æœæ¨¡å‹çš„è¾“å‡ºè¡¨ç¤ºã€Œæƒ³è°ƒç”¨å·¥å…·ã€ï¼Œå®ƒä¼šåœ¨ `content.message.tool_calls` åˆ—è¡¨ä¸­å£°æ˜è¦ç”¨å“ªä¸ªå‡½æ•°ã€å‚æ•°æ˜¯ä»€ä¹ˆã€‚

   * è¿™æ˜¯ä½ è‡ªå®šä¹‰çš„ä¸€ç§**å‡½æ•°è°ƒç”¨æœºåˆ¶**ï¼Œå’Œå®˜æ–¹ `function_call` æ ¼å¼ç•¥æœ‰ä¸åŒï¼Œä½†é€»è¾‘ç›¸ä¼¼ã€‚

2. **å–å‡ºå·¥å…·å `tool_name` å’Œå‚æ•° `tool_args`**ï¼Œå†è°ƒç”¨ `self.session.call_tool(tool_name, tool_args)` æ‰§è¡Œ MCP å·¥å…·ã€‚

3. **æŠŠå·¥å…·è°ƒç”¨ç»“æœä»¥ã€Œrole=toolã€çš„å½¢å¼å†™å…¥ `messages`**ã€‚è¿™æ ·ç›¸å½“äºæŠŠâ€œå‡½æ•°è°ƒç”¨ç»“æœâ€å†å–‚ç»™æ¨¡å‹ã€‚

4. **å†æ¬¡è°ƒç”¨ OpenAI**ï¼Œè®©æ¨¡å‹é˜…è¯»åˆ°è¿™ä¸ªæ–°ä¸Šä¸‹æ–‡ï¼Œäº§å‡ºæœ€ç»ˆå›ç­”ã€‚

5. **å¦‚æœæ²¡æœ‰è¦è°ƒç”¨å·¥å…·**ï¼Œç›´æ¥è¿”å› `content.message.content`ï¼ˆæ¨¡å‹çš„æ–‡æœ¬å›ç­”ï¼‰ã€‚

**`chat_loop(self)`**

```python
async def chat_loop(self):
    """è¿è¡Œäº¤äº’å¼èŠå¤©å¾ªç¯"""
    print("\nğŸ¤– MCP å®¢æˆ·ç«¯å·²å¯åŠ¨ï¼è¾“å…¥ 'quit' é€€å‡º")

    while True:
        try:
            query = input("\nä½ : ").strip()
            if query.lower() == 'quit':
                break
            
            response = await self.process_query(query)  # å‘é€ç”¨æˆ·è¾“å…¥åˆ° OpenAI API
            print(f"\nğŸ¤– OpenAI: {response}")

        except Exception as e:
            print(f"\nâš ï¸ å‘ç”Ÿé”™è¯¯: {str(e)}")
```

**ä½œç”¨**ï¼š

* æä¾›ä¸€ä¸ªç®€å•çš„ **å‘½ä»¤è¡Œç•Œé¢**ï¼Œåå¤è®©ç”¨æˆ·è¾“å…¥é—®é¢˜ã€‚

* æ¯ä¸ªé—®é¢˜äº¤ç»™ `process_query`ï¼ŒæŠŠç»“æœæ‰“å°å‡ºæ¥ã€‚

* è¾“å…¥ `'quit'` é€€å‡ºå¾ªç¯ã€‚

**`cleanup(self)` ä¸ `main()`**

```python
async def cleanup(self):
    """æ¸…ç†èµ„æº"""
    await self.exit_stack.aclose()
```

* **`self.exit_stack.aclose()`**ï¼šå¼‚æ­¥åœ°å…³é—­æ‰€æœ‰åœ¨ `exit_stack` ä¸­æ³¨å†Œçš„èµ„æºï¼ˆåŒ…æ‹¬ MCP ä¼šè¯ï¼‰ã€‚

```python
async def main():
    if len(sys.argv) < 2:
        print("Usage: python client.py <path_to_server_script>")
        sys.exit(1)

    client = MCPClient()
    try:
        await client.connect_to_server(sys.argv[1])
        await client.chat_loop()
    finally:
        await client.cleanup()

if __name__ == "__main__":
    import sys
    asyncio.run(main())
```

1. **è¯»å–å‘½ä»¤è¡Œå‚æ•°**ï¼Œè·å–æœåŠ¡å™¨è„šæœ¬è·¯å¾„ï¼ˆå¦‚ `weather_server.py`ï¼‰ã€‚

2. **åˆ›å»º `MCPClient` å®ä¾‹**ã€‚

3. **è°ƒç”¨ `connect_to_server`**ï¼Œå¯åŠ¨å¹¶è¿æ¥æœåŠ¡å™¨ã€‚

4. **è¿›å…¥ `chat_loop`** è®©ç”¨æˆ·è¾“å…¥å¤šè½®å¯¹è¯ã€‚

5. **é€€å‡ºæ—¶**è°ƒç”¨ `client.cleanup()` é‡Šæ”¾èµ„æºã€‚

ä»£ç æ€»ç»“å¦‚ä¸‹ï¼š

1. **MCPClient çš„ä¸»è¦èŒè´£**ï¼š

   * **å¯åŠ¨ MCP æœåŠ¡å™¨**ï¼ˆé€šè¿‡ `StdioServerParameters`ï¼‰

   * **å»ºç«‹ MCP ä¼šè¯**ï¼Œåˆ—å‡ºå¯ç”¨å·¥å…·

   * **å¤„ç†ç”¨æˆ·è¾“å…¥**ï¼Œå°†å…¶å‘é€ç»™ OpenAI æ¨¡å‹

   * **å¦‚æœæ¨¡å‹æƒ³è°ƒç”¨ MCP å·¥å…·ï¼ˆFunction Callingï¼‰**ï¼Œå°±æ‰§è¡Œ `call_tool`

   * **å°†ç»“æœé‡æ–°å‘ç»™æ¨¡å‹**ï¼Œå¹¶è¿”å›æœ€ç»ˆå›ç­”

2. **Function Calling é€»è¾‘**ï¼ˆä½ çš„è‡ªå®šä¹‰ç‰ˆï¼‰ï¼š

   * **`tools=available_tools`**ï¼šåœ¨ `completions.create` æ—¶å‘Šè¯‰æ¨¡å‹æœ‰å“ªäº›å·¥å…·å¯ç”¨ã€‚

   * **æ¨¡å‹è¿”å› `finish_reason=="tool_calls"`** â†’ è¯´æ˜å®ƒæƒ³ç”¨å·¥å…·ã€‚

   * **è§£æ `tool_calls[0]`**ï¼Œæ‰§è¡Œ MCP å·¥å…· â†’ å†æ¬¡å‘ç»™æ¨¡å‹ â†’ è¿”å›æœ€ç»ˆç­”æ¡ˆã€‚

3. **ä¸ºä»€ä¹ˆè¦ä¸¤æ¬¡è¯·æ±‚ï¼Ÿ**

   * ç¬¬ä¸€æ¬¡ï¼šæ¨¡å‹æ ¹æ®ä½ çš„æŒ‡ä»¤ï¼Œå†³å®šè¦ä¸è¦ç”¨å·¥å…·

   * å¦‚æœéœ€è¦ç”¨å·¥å…· â†’ è¿”å›å·¥å…·åç§°å’Œå‚æ•° â†’ æ‰§è¡Œå·¥å…· â†’ æŠŠç»“æœä½œä¸ºæ–°çš„ä¸Šä¸‹æ–‡å‘ç»™æ¨¡å‹

   * ç¬¬äºŒæ¬¡ï¼šæ¨¡å‹åŸºäºå·¥å…·ç»“æœç»™å‡ºæœ€ç»ˆå›ç­”

4. **å¦‚ä½•è¿è¡Œ**ï¼š

```bash
python client.py weather_server.py
```

* è¿™ä¼šè‡ªåŠ¨å¯åŠ¨ `weather_server.py`ï¼ˆMCP æœåŠ¡å™¨ï¼‰å¹¶è¿›è¡Œ stdio é€šè®¯ã€‚

1. **å¯èƒ½éœ€è¦çš„æ”¹è¿›**ï¼š

   * **å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡**ï¼šæŠŠæ‰€æœ‰æ¶ˆæ¯éƒ½å­˜è¿› `messages`ï¼Œè®©æ¨¡å‹èƒ½è®°ä½ä»¥å‰çš„å¯¹è¯ã€‚

   * **é”™è¯¯å¤„ç†**ï¼šå½“å·¥å…·è°ƒç”¨å¤±è´¥æ—¶ï¼Œç»™ç”¨æˆ·æç¤ºã€‚

### 5.MCP InspectoråŠŸèƒ½ä»‹ç»

&#x20;       åœ¨å®é™…å¼€å‘MCPæœåŠ¡å™¨çš„è¿‡ç¨‹ä¸­ï¼ŒAnthropicæä¾›äº†ä¸€ä¸ªéå¸¸ä¾¿æ·çš„debugå·¥å…·ï¼šInspectorã€‚å€ŸåŠ©Inspectorï¼Œæˆ‘ä»¬èƒ½å¤Ÿéå¸¸å¿«æ·çš„è°ƒç”¨å„ç±»serverï¼Œå¹¶æµ‹è¯•å…¶åŠŸèƒ½ã€‚Inspectorå…·ä½“åŠŸèƒ½å®ç°æµç¨‹å¦‚ä¸‹ã€‚

* å®‰è£…nodejs

```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo bash -
sudo apt install -y nodejs
```

![](images/d5788860-3308-499c-baef-84bdb6986fd1.png)

&#x20;

![](images/5d1edab1-f880-41cc-9b39-4cad85df9e13.png)

```bash
npx -v
```

![](images/06e050ae-2d93-434e-b059-45a63d6d9759.png)

* è¿è¡ŒInspector

```bash
npx -y @modelcontextprotocol/inspector uv run server.py
```

![](images/81a8d3a0-899c-4232-9c80-0900ec69fa49.png)

ç„¶åå³å¯åœ¨æœ¬åœ°æµè§ˆå™¨æŸ¥çœ‹å½“å‰å·¥å…·è¿è¡Œæƒ…å†µï¼šhttp://127.0.0.1:5173/#resources

![](images/d8d753f3-7898-4986-846b-5268f3a3c0a8.png)

![](images/0361d14d-af12-4925-9c4d-7aa81be18714-3.png)

æ­¤æ—¶æµè§ˆå™¨å†…å®¹å¦‚ä¸‹ï¼š

![](images/0f55aeac-7aab-4cdd-9593-2294d6a092c4.png)

ç„¶åå³å¯æŸ¥çœ‹å½“å‰æœåŠ¡å™¨è¿è¡ŒçŠ¶å†µï¼š

![](images/2c9954d0-01c1-4c09-bfb6-3e553b1ef522.png)

## å››ã€MCPæ›´å¤šè¿›é˜¶ä½¿ç”¨

åŸºäºæˆ‘ä»¬å½“å‰ä»‹ç»çš„MCPå¼€å‘å…¥é—¨ï¼ŒMCPè¿˜æœ‰è¯¸å¤šå¾…æ¢ç´¢çš„è¿›é˜¶åŠŸèƒ½ã€‚

### 1. MCPæœåŠ¡å™¨Serverè¿›é˜¶åŠŸèƒ½

* åŸºäºSSEä¼ è¾“çš„MCPæœåŠ¡å™¨åŠŸèƒ½å®ç°

* &#x20;       é™¤äº†stdioè¿æ¥æ¨¡å¼å¤–ï¼ŒMCPè¿˜æä¾›äº†å¯ä»¥æœåŠ¡å™¨ã€å®¢æˆ·ç«¯å¼‚åœ°è¿è¡Œçš„SSEä¼ è¾“æ¨¡å¼ï¼Œä»¥é€‚ç”¨äºæ›´åŠ é€šç”¨çš„å¼€å‘æƒ…å†µã€‚è‹¥è¦å®ç°SSEçš„MCPæœåŠ¡å™¨é€šä¿¡ï¼Œéœ€è¦åŒæ—¶ä¿®æ”¹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä»£ç ã€‚

* Resourcesã€Promptç±»åŠŸèƒ½MCPæœåŠ¡å™¨

* &#x20;       é™¤äº†ToolsåŠŸèƒ½çš„æœåŠ¡å™¨å¤–ï¼ŒMCPè¿˜æ”¯æŒResourcesç±»æœåŠ¡å™¨å’ŒPromptç±»æœåŠ¡å™¨ï¼Œå…¶ä¸­ResourcesæœåŠ¡å™¨ä¸»è¦è´Ÿè´£æä¾›æ›´å¤šçš„èµ„æºæ¥å£ï¼Œå¦‚è°ƒç”¨æœ¬åœ°æ–‡ä»¶ã€æ•°æ®ç­‰ï¼Œè€ŒPromptç±»æœåŠ¡å™¨åˆ™æ˜¯ç”¨äºè®¾ç½®Agentå¼€å‘è¿‡ç¨‹ä¸­å„ç¯èŠ‚çš„æç¤ºè¯æ¨¡æ¿ã€‚

* æ›´å¤šé€šç”¨å…¬å¼€&åœ¨çº¿æœåŠ¡å™¨è°ƒç”¨æŒ‡å—

* &#x20;       MCPæ ‡å‡†é€šä¿¡åè®®å¸¦æ¥çš„æœ€å¤§ä»·å€¼ä¹‹ä¸€ï¼Œå°±æ˜¯è®©å¹¿å¤§Agentå¼€å‘è€…èƒ½å¤ŸåŸºäºæ­¤è¿›è¡Œåä½œã€‚åœ¨MCPæ¨å‡ºåçš„è‹¥å¹²æ—¶é—´ï¼Œå·²ç»è¯ç”Ÿäº†æ•°ä»¥åƒè®¡çš„MCPæœåŠ¡å™¨ï¼Œå…è®¸ç”¨æˆ·ç›´æ¥ä¸‹è½½å¹¶è¿›è¡Œè°ƒç”¨ã€‚å‡ ä¸ªæœ‰åçš„MCPæœåŠ¡å™¨åˆé›†(å¯¼èˆªç«™)åœ°å€ï¼š

  * MCPå®˜æ–¹æœåŠ¡å™¨åˆé›†ï¼šhttps://github.com/modelcontextprotocol/servers

  ![](images/0991111e-7a44-4b56-a386-fd4600042479.png)

  * MCP Githubçƒ­é—¨å¯¼èˆªï¼šhttps://github.com/punkpeye/awesome-mcp-servers

  ![](images/37c42c0e-6954-4eae-9c6f-80e0845a268a.png)

  * MCPé›†åˆï¼šhttps://github.com/ahujasid/blender-mcp

  ![](images/869c283d-0e99-44e8-91c7-8f7ce3fea669.png)

  * MCPå¯¼èˆªï¼šhttps://mcp.so/

  ![](images/be82ff90-cf6a-4f46-bd98-4dfe191de521.png)

### 2. MCPå®¢æˆ·ç«¯Clientè¿›é˜¶åŠŸèƒ½

æ­¤å¤–ï¼Œé™¤äº†èƒ½åœ¨å‘½ä»¤è¡Œä¸­åˆ›å»ºMCPå®¢æˆ·ç«¯å¤–ï¼Œè¿˜æ”¯æŒå„ç±»å®¢æˆ·ç«¯çš„è°ƒç”¨ï¼šhttps://modelcontextprotocol.io/clients

![](images/925ad09e-0540-4e77-91af-084a9ae64c3c.png)

å…¶ä¸­å€ŸåŠ©å¯¹è¯ç±»å®¢æˆ·ç«¯ï¼Œå¦‚Claude Destopï¼Œæˆ‘ä»¬èƒ½å¤Ÿè½»æ˜“çš„å°†å„ç±»æœåŠ¡å™¨è¿›è¡Œé›†æˆï¼Œä»è€Œæ‹“å±•Claude Destopçš„æ€§èƒ½ï¼š

![](images/b7c89bd8-8452-4a83-b95f-e22cf21a1d13.png)



è€Œåœ¨ä¸€äº›IDEå®¢æˆ·ç«¯é‡Œï¼Œå¦‚clineæˆ–è€…Cursorï¼Œæˆ‘ä»¬èƒ½å¤Ÿç›´æ¥è°ƒç”¨æœåŠ¡å™¨è¿›è¡Œå¼€å‘ï¼š



æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›ä¸ºMCPé‡èº«å®šåˆ¶çš„Agentå¼€å‘æ¡†æ¶ï¼Œé€šè¿‡é›†æˆMCPæ¥æé«˜Agentå¼€å‘è¿›åº¦ï¼š

https://github.com/lastmile-ai/mcp-agent

![](images/23a26dd8-8b2d-4212-979f-0e6663ac43c1.png)



***

æ›´å¤šå…³äºå¤§æ¨¡å‹æŠ€æœ¯ä»‹ç»ï¼Œæ¬¢è¿æŠ¥åç”±æˆ‘ä¸»è®²çš„ã€Š2025å¤§æ¨¡å‹Agentæ™ºèƒ½ä½“å¼€å‘å®æˆ˜ã€‹ï¼ˆ2æœˆDeepSeekå¼ºåŒ–ç­ï¼‰https://whakv.xetslk.com/s/pxKHGè¿›è¡Œæ›´æ·±åº¦ç³»ç»Ÿçš„å­¦ä¹ å“¦\~

![](images/d56384e6-36a2-4020-8763-1eeecad45fae.jpeg)

&#x20;

![](images/2c39763c-c138-4a3a-8106-5c1aa0d496c3.png)

&#x20;

![](images/e3745388-b49b-4ae0-a066-d2d92ef7dd0b.png)

**[ã€Š2025å¤§æ¨¡å‹Agentæ™ºèƒ½ä½“å¼€å‘å®æˆ˜ã€‹](https://whakv.xetslk.com/s/3uzKfW)æ˜¥å­£ç­ç­ä¸Šæ–°ç‰¹æƒ è¿›è¡Œæ—¶ï¼Œè¯¦ç»†ä¿¡æ¯æ‰«ç æ·»åŠ åŠ©æ•™ï¼Œå›å¤â€œå¤§æ¨¡å‹â€ï¼Œå³å¯é¢†å–è¯¾ç¨‹å¤§çº²&æŸ¥çœ‹è¯¾ç¨‹è¯¦æƒ…ğŸ‘‡**

![](images/0051e07e-8769-488e-9ce3-500cdde71bac.jpeg)

æ­¤å¤–ï¼Œå¦‚æœå¯¹å¤§æ¨¡å‹åº•å±‚åŸç†å’Œæ¨¡å‹è®­ç»ƒæ„Ÿå…´è¶£ï¼Œæ¬¢è¿æŠ¥åç”±æˆ‘å’Œèœèœè€å¸ˆå…±åŒå¼€è®¾çš„ã€Šå¤§æ¨¡å‹åŸç†ä¸è®­ç»ƒå®æˆ˜ã€‹https://whakv.xetslk.com/s/3p66pNå®æˆ˜è¯¾ï¼Œ3æœˆæ–°ç­é¢å¤–æ–°å¢å¤§é‡DeepSeek V3\&R1æ¨¡å‹åŸç†ä¸è®­ç»ƒå®æˆ˜å†…å®¹ï¼Œæ‰«æä¸Šæ–¹äºŒç»´ç å³å¯æŸ¥çœ‹å®Œæ•´è¯¾ç¨‹å¤§çº²å“¦\~

![](images/1d94aa1d-fefb-4795-993d-dacd7b657a70.png)
