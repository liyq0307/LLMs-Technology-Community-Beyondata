# è¯¾ç¨‹è¯´æ˜ï¼š

* ä½“éªŒè¯¾å†…å®¹èŠ‚é€‰è‡ª[ã€Š2025å¤§æ¨¡å‹Agentæ™ºèƒ½ä½“å¼€å‘å®æˆ˜ã€‹](https://whakv.xetslk.com/s/1tKbjV)å®Œæ•´ç‰ˆä»˜è´¹è¯¾ç¨‹

â€ƒâ€ƒä½“éªŒè¯¾æ—¶é—´æœ‰é™ï¼Œè‹¥æƒ³æ·±åº¦å­¦ä¹ å¤§æ¨¡å‹æŠ€æœ¯ï¼Œæ¬¢è¿å¤§å®¶æŠ¥åç”±æˆ‘ä¸»è®²çš„[ã€Š2025å¤§æ¨¡å‹Agentæ™ºèƒ½ä½“å¼€å‘å®æˆ˜ã€‹](https://whakv.xetslk.com/s/1tKbjV)ï¼š

![](images/image.png)

![](images/image-1.png)

å…¬å¼€è¯¾å…¨å¥—å­¦ä¹ èµ„æ–™ï¼Œå·²ä¸Šä¼ è‡³ç½‘ç›˜ï¼ˆhttps://pan.baidu.com/s/1t989LHh0By-MQP9eCUSFTw?pwd=gbd9ï¼‰

**éœ€è¦æ›´ç³»ç»Ÿæ·±å…¥å­¦ä¹ å¤§æ¨¡å‹å¯æ‰«ç â¬†ï¸æ·»åŠ åŠ©æ•™å’¨è¯¢å–”ï½**

***

## ä¸€ã€DeepSeek R1ä½æˆæœ¬æœ¬åœ°éƒ¨ç½²æ–¹æ¡ˆä»‹ç»

### 1. KTransformerä¸UnslothåŠ¨æ€é‡åŒ–æ–¹æ¡ˆä»‹ç»

&#x20;       æˆªè‡³ç›®å‰ï¼ŒDeepSeek R1æ¨¡å‹æœ¬åœ°éƒ¨ç½²æœ€å…·æ€§ä»·æ¯”çš„æ–¹æ¡ˆå°±æ˜¯æ¸…åå¤§å­¦å›¢é˜Ÿæå‡ºçš„KTransformeræ–¹æ¡ˆå’ŒUnslothåŠ¨æ€é‡åŒ–æ–¹æ¡ˆï¼Œä¸¤å¥—æ–¹æ¡ˆéƒ½æ˜¯å€ŸåŠ©CPU+GPUæ··åˆæ¨ç†ï¼Œæ¥é™ä½GPUè´­ä¹°çš„ç¡¬ä»¶æˆæœ¬ï¼Œå¹¶ä¸”åº•å±‚CPUæ¨ç†å®ç°ä¹Ÿéƒ½æ˜¯åŸºäºllama.cppã€‚

* ktransformersï¼šhttps://github.com/kvcache-ai/ktransformers

![](images/6261f1b1-44a5-4ed2-b684-bc9b26dd3706.png)

* Unslothï¼šhttps://github.com/unslothai/unsloth

![](images/21a94699-bf04-484c-b985-c27ffd7142de.png)

* llama.cppï¼šhttps://github.com/ggml-org/llama.cpp

![](images/aab75390-ad38-4e48-b0b5-6db60261e277.png)

æ‰€ä¸åŒçš„æ˜¯ï¼ŒKTransformeré‡‡ç”¨äº†ä¸€ç§å…¨æ–°çš„è®¡ç®—æµç¨‹ï¼Œä½¿å¾—MLA/KV-Cacheå¯ä»¥åœ¨GPUä¸Šè¿è¡Œï¼Œè€Œå…¶ä»–æ¨¡å‹å‚æ•°åˆ™åœ¨CPUä¸Šå®Œæˆè®¡ç®—ï¼Œä»è€Œå¤§å¹…åŠ å¿«CPUçš„è®¡ç®—é€Ÿåº¦ã€‚

![](images/40ef3501-734a-433a-b962-54dc16ee1be3.png)

è¿™ç§è®¡ç®—æµç¨‹èƒ½å¤Ÿå¤§å¹…åŠ å¿«DeepSeek MoEæ¶æ„ç®—æ³•çš„è®¡ç®—é€Ÿåº¦ï¼Œæ ¹æ®å®˜æ–¹ç»™å‡ºçš„æ•°æ®ï¼Œæœ€é«˜èƒ½å¾—åˆ°14tokens/sï¼Œæ˜¯llama.cppæ¨ç†é€Ÿåº¦çš„ä¸¤å€ã€‚

![](images/cd4df4ed-2766-477e-8ea5-498b2eaf2a45.png)

ä½†è¿™å¥—æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜ï¼Œåˆ™ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªï¼š

* å…¶ä¸€æ˜¯æ¨¡å‹å¹¶å‘è¾ƒå¼±ï¼Œç”±äºé‡‡ç”¨äº†éå¸¸ç‰¹æ®Šçš„è®¡ç®—ç»“æ„ï¼Œå¯¼è‡´æ— æ³•é€šè¿‡å¢åŠ GPUæ•°é‡æ¥å¢åŠ å¹¶å‘ï¼›

* å…¶äºŒæ˜¯éœ€è¦è¾ƒå¤§å†…å­˜æ‰èƒ½è¿è¡Œï¼Œå®˜æ–¹ç»™å‡ºçš„ä¸åŒæ¨¡å‹æ¨ç†æ‰€éœ€å†…å­˜å ç”¨å¦‚ä¸‹ï¼š

![](images/465ec9bf-5693-48c6-a0fc-a52e3062365d.png)

Unslothæå‡ºçš„åŠ¨æ€é‡åŒ–æ–¹æ¡ˆä¼šæ›´åŠ ç»¼åˆä¸€äº›ï¼Œæ‰€è°“åŠ¨æ€é‡åŒ–çš„æŠ€æœ¯ï¼ŒæŒ‡çš„æ˜¯å¯ä»¥å›´ç»•æ¨¡å‹çš„ä¸åŒå±‚ï¼Œè¿›è¡Œä¸åŒç¨‹åº¦çš„é‡åŒ–ï¼Œå…³é”®å±‚å‘¢ï¼Œå°±é‡åŒ–çš„å°‘ä¸€äº›ï¼Œéå…³é”®å±‚é‡åŒ–çš„å¤šä¸€äº›ï¼Œæœ€ç»ˆå¾—åˆ°äº†ä¸€ç»„æ¯”Q2é‡åŒ–ç¨‹åº¦æ›´æ·±çš„æ¨¡å‹ç»„ï¼Œåˆ†åˆ«æ˜¯1.58-bitã€1.73-bitå’Œ2.22-bitæ¨¡å‹ç»„ã€‚å°½ç®¡é‡åŒ–ç¨‹åº¦å¾ˆæ·±ï¼Œä½†å®é™…æ€§èƒ½å…¶å®å¹¶ä¸å¼±ã€‚æ ¹æ®æµ‹è¯•ç»“æœï¼Œ1.58-bitåŠ¨æ€é‡åŒ–å‡ ä¹èƒ½è¾¾åˆ°90%ä»¥ä¸ŠQ4\_K\_Mæ€§èƒ½ï¼Œè¿œæ¯”Q2\_K\_Mæ€§èƒ½å¼ºå¾—å¤šã€‚

![](images/40ea183d-6a2a-44d6-a251-2de23dfba34c.png)

&#x20;

![](images/440ec968-4d85-4ed4-8bb8-c83c09232f36.png)

æ­¤å¤–ï¼ŒUnslothæä¾›äº†ä¸€å¥—å¯ä»¥æŠŠæ¨¡å‹æƒé‡åˆ†åˆ«åŠ è½½åˆ°CPUå’ŒGPUä¸Šçš„æ–¹æ³•ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±å®é™…ç¡¬ä»¶æƒ…å†µï¼Œé€‰æ‹©åŠ è½½è‹¥å¹²å±‚æ¨¡å‹æƒé‡åˆ°GPUä¸Šï¼Œç„¶åå‰©ä¸‹çš„æ¨¡å‹æƒé‡åŠ è½½åˆ°CPUå†…å­˜ä¸Šè¿›è¡Œè®¡ç®—ã€‚

![](images/0d771401-9c70-4ced-ae23-edda619edc8e.png)

åœ¨å®é™…éƒ¨ç½²çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ç¡¬ä»¶æƒ…å†µï¼Œæœ‰é€‰æ‹©çš„å°†ä¸€éƒ¨åˆ†æ¨¡å‹çš„å±‚æ”¾åˆ°GPUä¸Šè¿è¡Œï¼Œå…¶ä»–å±‚æ”¾åœ¨CPUä¸Šè¿è¡Œï¼Œä»è€Œé™ä½GPUè´Ÿè½½ã€‚æœ€ä½æ˜¾å­˜+å†…å­˜>=200Gï¼Œå³å¯è¿è¡Œ1.58bitæ¨¡å‹ã€‚

![](images/3bab2f9a-e25a-4147-bd05-48f0ce8b6f4e.png)

å•å¡4090ï¼ˆ24Gï¼‰æ—¶å¯åŠ è½½7å±‚æƒé‡åœ¨GPUä¸Šè¿è¡Œï¼Œ40å¹¶å‘è¾¾åˆ°3.5tokens/sï¼ŒåŒå¡A100æœåŠ¡å™¨èƒ½åŠ è½½å…¨éƒ¨0åˆ°61å±‚æ¨¡å‹æƒé‡åˆ°GPUä¸Šï¼Œååé‡è¾¾åˆ°140tokens/sï¼Œ100å¹¶å‘æ—¶å•äººèƒ½è¾¾åˆ°14 tokens/sï¼š

![](images/638b5428-345a-4799-b237-d92854988fb6.png)

ç®€è€Œè¨€ä¹‹ï¼ŒUnslothæ–¹æ¡ˆä¼˜åŠ¿å¦‚ä¸‹ï¼š

* å’Œllama.cppæ·±åº¦èåˆï¼Œç›´æ¥é€šè¿‡å‚æ•°è®¾ç½®å³å¯è‡ªç”±è°ƒåº¦CPUå’ŒGPUè®¡ç®—èµ„æºï¼Œçµæ´»é«˜æ•ˆï¼Œä¸”èƒ½å¤Ÿç›´æ¥å’Œollamaã€vLLMã€Open-WebUIç­‰æ¡†æ¶å…¼å®¹ã€‚

* æ·±åº¦æŒ–æ˜GPUæ€§èƒ½ï¼Œå¹¶å‘é‡æœ‰ä¿éšœã€‚

è¿™ä¸¤å¥—æ–¹æ¡ˆæ­¤å‰æ›¾å•ç‹¬å¼€è®¾å…¬å¼€è¯¾è®²è§£è¿‡ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥æˆ³æ­¤è§‚çœ‹ï¼š

* **ç‹¬å®¶KTransformersæŠ€æœ¯å®æˆ˜**ï¼šhttps://www.bilibili.com/video/BV1kyAke9EBA/

![](images/26e32a87-dbf3-408f-81c0-a7dbda4859a4.png)

* **ç‹¬å®¶UnslothåŠ¨æ€é‡åŒ–éƒ¨ç½²æ»¡è¡€DeepSeek**ï¼šhttps://www.bilibili.com/video/BV1oePLezEZD/

![](images/a6212fce-5122-4116-a82a-94280a2dbe5d.png)

### 2. æœ€é«˜æ€§ä»·æ¯”æ–¹æ¡ˆï¼šKTransformers+Unslothç»“åˆéƒ¨ç½²æ–¹æ¡ˆ

&#x20;       è€Œè‡ªä»è¿™ä¸¤å¥—æ–¹æ¡ˆè¯ç”Ÿä»¥æ¥ï¼Œå°±æœ‰å¾ˆå¤šå°ä¼™ä¼´ç•…æƒ³ï¼Œèƒ½ä¸èƒ½å°†è¿™ä¸¤ä¸ªæ–¹æ¡ˆç»“åˆèµ·æ¥éƒ¨ç½²å‘¢ï¼Ÿ**ä¸€æ–¹é¢ï¼Œå€ŸåŠ©Unsloth 1.58bitåŠ¨æ€æ¨¡å‹çš„é«˜æ€§èƒ½ç‰¹æ€§ï¼Œä¸€æ–¹é¢å€ŸåŠ©KTransformersçš„é«˜æ€§èƒ½è®¡ç®—ç‰¹æ€§ï¼Œå°±èƒ½è¿›ä¸€æ­¥å‹ç¼©ç¡¬ä»¶æˆæœ¬ã€è·å¾—æ›´å¥½çš„è®¡ç®—æ€§èƒ½ï¼ŒåŒæ—¶ç”±äº1.58bitåŠ¨æ€é‡åŒ–æ¨¡å‹æœ¬èº«å ç”¨å­˜å‚¨ç©ºé—´æ›´å°‘ï¼Œæ¨ç†å¹¶å‘æ•°é‡ä¹Ÿèƒ½æœ‰æ‰€æå‡ã€‚**

&#x20;       è¿™ç¡®å®æ˜¯éå¸¸ä¸é”™çš„æ€è·¯ï¼Œå¹¶ä¸”ç”±äºåŠ¨æ€é‡åŒ–æœ¬èº«å¹¶æ²¡æœ‰æ”¹å˜æ¨¡å‹ç»“æ„ï¼Œå› æ­¤ç†è®ºä¸Šä¹Ÿæ˜¯å¯è¡Œçš„ã€‚ä½†å¾ˆé—æ†¾ï¼Œæˆªè‡³ç›®å‰ï¼ŒKTransformersçš„ä¸‰ä¸ªç‰ˆæœ¬ï¼ŒV0.2ã€V0.21å’ŒV0.3æš‚æ—¶éƒ½ä¸æ”¯æŒUnslothåŠ¨æ€é‡åŒ–æ¨¡å‹çš„æ¨ç†ã€‚ç°åœ¨å®˜æ–¹ç¨³å®šç‰ˆåœ¨è¿è¡ŒUnslothåŠ¨æ€é‡åŒ–æ¨¡å‹æ—¶ä¼šå‡ºç°å¦‚ä¸‹æŠ¥é”™ï¼š

![](images/cd3ba3a1-3515-4da2-8590-a8b28e60914d.png)

å› æ­¤ï¼Œæˆ‘ä»¬å›¢é˜Ÿåœ¨æ·±å…¥ç ”ç©¶KTransformersæºç åï¼Œå¯¹V0.2ç‰ˆæœ¬çš„éƒ¨åˆ†ä»£ç è¿›è¡Œäº†ä¿®æ”¹ï¼Œå¹¶æœ€ç»ˆé€‚é…1.58bit UnslothåŠ¨æ€é‡åŒ–æ¨¡å‹ï¼Œ**ä½¿å¾—æœ€ä½å¯ä»¥åœ¨60Gå†…å­˜ã€14Gæ˜¾å­˜ä¸‹é¡ºåˆ©è¿è¡Œ**ï¼Œè‡³å¼º3ä»£CPU+DDR4+è™šæ‹ŸGPUè¿è¡Œæ—¶æ•ˆæœå¦‚ä¸‹ï¼š

![](images/9ec4c2bf-8a02-4fa3-8658-a98288c5f488.png)

å®é™…å†…å­˜ä½¿ç”¨çº¦60Gï¼š

![](images/b2f8fa97-f645-423b-af59-bfc31ad728dd.png)

æ˜¾å­˜ä½¿ç”¨çº¦10Gï¼š

![](images/2f9e2828-8b3c-447f-9128-f4ddf4e5d715.png)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›¸åŒ1.58bitæ¨¡å‹ï¼Œè‹¥ä½¿ç”¨Unsloth+llama.cppè¿è¡Œæ–¹æ¡ˆï¼Œåˆ™éœ€è¦è‡³å°‘4å¡4090ï¼ˆåˆ†é…35å±‚åœ¨GPUä¸Šè®¡ç®—ï¼‰æ‰èƒ½è¾¾åˆ°ç›¸åŒçš„æ•ˆæœã€‚

![](images/0ea2f135-b851-4686-a97d-e7c7c161bf74.png)

å¹¶ä¸”åœ¨ç¡¬ä»¶é…ç½®è¾¾æ ‡çš„æƒ…å†µä¸‹ï¼Œå¦‚è‡³å¼º4ä»£ä»¥ä¸Š+DDR5ï¼Œåˆ™èƒ½è¾¾åˆ°12 tokens/sï¼Œä¸”åœ¨5ä¸ªå·¦å³å¹¶å‘æ—¶ï¼Œèƒ½è¾¾åˆ°6-8 tokens/sã€‚æœ¬èŠ‚å…¬å¼€è¯¾ï¼Œæˆ‘ä»¬å°±æ¥è¯¦ç»†ä»‹ç»ä¸‹å¦‚ä½•å®ç°KTransformers+Unslothè”åˆéƒ¨ç½²ã€‚

![](images/638b5428-345a-4799-b237-d92854988fb6-1.png)

![](images/b50b1d6b-47c6-4fb2-8d6c-3a77a422424b.png)

![](images/e46e6be8-8242-42c0-a47d-7e13efbc9bd6.png)

* è¯¾ä»¶é¢†å–ï¼š

&#x20;       æˆªè‡³è§†é¢‘ä¸Šçº¿æ—¶ï¼ŒKT+Unslothç»“åˆæ–¹æ¡ˆæ‰€éœ€Ktransformerså°šæœªæ­£å¼å‘å¸ƒï¼Œå› æ­¤éœ€è¦ä¸‹å›¾æ‰«ç é¢†å–é¡¹ç›®æºç æ‰èƒ½éƒ¨ç½²ï¼š

![](images/a5b11d65-e436-4a77-a387-0a8305c57324.png)

&#x20;

![](images/10624bbe-c17c-43fe-a483-239ec22c8eb7.png)

ç½‘ç›˜ä¸­åŒæ—¶åŒ…å«æœ¬èŠ‚å…¬å¼€è¯¾å…¨éƒ¨èµ„æ–™ï¼š

![](images/a28d85de-5db0-44cb-8772-39312e860291.png)

### 3.KTransformersæœ¬åœ°éƒ¨ç½²ç¡¬ä»¶é…ç½®è¯´æ˜

&#x20;       è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼ŒKTransformersé¡¹ç›®æœ¬èº«è¿è¡Œæ•ˆæœæå¤§ç¨‹åº¦ä¾èµ–CPUå’Œå†…å­˜å‹å·ï¼Œä¸€èˆ¬æ¥è¯´è‡³å¼º4ä»£æˆ–ç¬¬å››ä»£éœ„é¾™+DDR5æ‰èƒ½ä¿è¯14tokens/sã€‚æ›´å¤šDeepSeek R1æœ¬åœ°éƒ¨ç½²æŒ‡å—è¯¦è§å¦‚ä¸‹å…¬å¼€è¯¾ã€‚

* å…¨ç½‘æœ€å…¨ä½æˆæœ¬éƒ¨ç½²æ–¹æ¡ˆ+ç¡¬ä»¶é‡‡è´­é¿å‘æŒ‡å—ï¼ï¼šhttps://www.bilibili.com/video/BV1K7ACewEfM/

![](images/5ceb6830-3d64-4a57-aeba-0bc6c026f276.png)

* &#x20;

![](images/708c7d0a-ef02-4df0-a2d4-b7d6cf1ac287.png)

* æœ¬èŠ‚å…¬å¼€è¯¾é…ç½®ï¼š

* PyTorch 2.5.1ï¼ŒPython 3.12(ubuntu22.04)ï¼ŒCuda 12.4

* æ“ä½œç³»ç»Ÿï¼šUbuntu 22.04

* **GPU**ï¼švGPU-32GB(32GB) \* 1å‡é™é…ç½®

* **CPU**ï¼š16 vCPU Intel(R) Xeon(R) Platinum 8352V CPU @ 2.10GHz

* **å†…å­˜**ï¼š90GB DDR4

* è‹¥æ— ç›¸å…³è½¯ä»¶ç¯å¢ƒï¼Œä¹Ÿå¯ä»¥è€ƒè™‘åœ¨AutoDLä¸Šç§Ÿèµæ˜¾å¡å¹¶é…ç½®UbuntuæœåŠ¡å™¨æ¥å®Œæˆæ“ä½œã€‚æœ€å°åŒ–å®ç°å¾®è°ƒæ•ˆæœï¼Œä»…éœ€å•å¡ç§Ÿèµæœ€ä¾¿å®œçš„vGPUè¿è¡Œä¸¤å°æ—¶å³å¯å¾—åˆ°ç»“æœï¼Œä»…éœ€ä¸åˆ°5å…ƒå³å¯å®Œæˆå®æ“ï¼š

![](images/65e70673-2e71-4bfd-ba98-bed67e441f39.png)

* AutoDLç›¸å…³æ“ä½œè¯¦è§å…¬å¼€è¯¾ï¼šã€ŠAutoDLå¿«é€Ÿå…¥é—¨ä¸GPUç§Ÿèµä½¿ç”¨æŒ‡å—ã€‹|https://www.bilibili.com/video/BV1bxB7YYEST/

* KTransformeré¡¹ç›®éƒ¨ç½²ç¡¬ä»¶é…ç½®æ–¹é¢éœ€è¦æ³¨æ„å¦‚ä¸‹äº‹é¡¹ï¼š

  * GPUå¯¹å®é™…è¿è¡Œæ•ˆç‡æå‡ä¸å¤§ï¼Œå•å¡3090ã€å•å¡4090ã€æˆ–è€…æ˜¯å¤šå¡GPUæœåŠ¡å™¨éƒ½æ²¡æœ‰å¤ªå¤§å½±å“ï¼Œåªéœ€è¦ç•™è¶³14Gä»¥ä¸Šæ˜¾å­˜å³å¯ï¼›

  * è‹¥æ˜¯å¤šå¡æœåŠ¡å™¨ï¼Œåˆ™å¯ä»¥è¿›ä¸€æ­¥å°è¯•æ‰‹åŠ¨ç¼–å†™æ¨¡å‹æƒé‡å¸è½½è§„åˆ™ï¼Œä½¿ç”¨æ›´å¤šçš„GPUè¿›è¡Œæ¨ç†ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦å‡å°‘å†…å­˜éœ€æ±‚ï¼Œä½†å¯¹äºå®é™…è¿è¡Œæ•ˆç‡æå‡ä¸å¤§ã€‚æœ€çœé’±çš„æ–¹æ¡ˆä»ç„¶æ˜¯å•å¡GPU+å¤§å†…å­˜é…ç½®ï¼›

  * KTransformerç›®å‰å¼€æ”¾äº†V2.0ã€V2.1å’ŒV3.0ä¸‰ä¸ªç‰ˆæœ¬ï¼ˆV3.0ç›®å‰åªæœ‰é¢„è§ˆç‰ˆï¼Œåªæ”¯æŒäºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½å’Œå®‰è£…ï¼‰ï¼Œå…¶ä¸­V2.0å’ŒV2.1æ”¯æŒå„ç±»CPUï¼Œä½†ä»V3.0å¼€å§‹ï¼Œåªæ”¯æŒAMX CPUï¼Œä¹Ÿå°±æ˜¯æœ€æ–°å‡ ä»£çš„Intel CPUã€‚è¿™å‡ ä¸ªç‰ˆæœ¬å®é™…éƒ¨ç½²æµç¨‹å’Œè°ƒç”¨æŒ‡ä»¤æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œå…¬å¼€è¯¾ä»¥é€‚é…æ€§æœ€å¹¿æ³›çš„V2.0ç‰ˆæœ¬è¿›è¡Œæ¼”ç¤ºï¼Œè‹¥å½“å‰CPUæ”¯æŒAMXï¼Œåˆ™å¯ä»¥è€ƒè™‘ä½¿ç”¨V3.0è¿›è¡Œå®éªŒï¼Œæ¨ç†é€Ÿåº¦ä¼šå¤§å¹…åŠ å¿«ã€‚

  * CPU AMXï¼ˆAdvanced Matrix Extensionsï¼‰æ˜¯Intelåœ¨å…¶Sapphire Rapidsç³»åˆ—å¤„ç†å™¨ä¸­æ¨å‡ºçš„ä¸€ç§æ–°å‹ç¡¬ä»¶åŠ é€ŸæŒ‡ä»¤é›†ï¼Œæ—¨åœ¨æå‡çŸ©é˜µè¿ç®—çš„æ€§èƒ½ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹æ·±åº¦å­¦ä¹ å’Œäººå·¥æ™ºèƒ½åº”ç”¨ã€‚

* æœåŠ¡å™¨ç‰©ç†æœºæˆæœ¬ï¼ˆæ¯”è¯¾ç¨‹æ¼”ç¤ºæ€§èƒ½é™ä½30%å·¦å³ï¼‰

* KTransformers+Unslothæ–¹æ¡ˆæé™é…ç½®ä¸‹ï¼Œæœ€ä½ä»…éœ€4500å·¦å³ï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š

| ç¡¬ä»¶       | è¯¦ç»†å‹å·                                     | ä»·æ ¼            |
| -------- | ---------------------------------------- | ------------- |
| **ä¸»æ¿**   | åå— X99-TF+ E5 æ¿ U å¥—è£…ï¼ˆ2696V3ï¼‰+ A700 é£æ‰‡    | 800å…ƒ          |
| **CPU**  | è‹±ç‰¹å°”è‡³å¼º E5-2696V3ï¼ˆ18 æ ¸ 36 çº¿ç¨‹ï¼‰              | **ï¼ˆåŒ…å«åœ¨ä¸»æ¿å¥—è£…ï¼‰** |
| **å†…å­˜**   | ä¸‰æ˜ŸäºŒæ‰‹æœåŠ¡å™¨æ‹†æœºå†…å­˜ DDR4 ECC 64GB                | **270**       |
| **å›ºæ€ç¡¬ç›˜** | å…‰å¨ï¼ˆGlowayï¼‰M.2 1TB PCIe 4.0 è¯»å–é€Ÿåº¦ 7000MB/s | 400 å…ƒ         |
| **ç”µæº**   | é•¿åŸ 1000DA é‡‘ç‰Œå·¨é¾™ 1000W ç”µç«ç‰ˆ                 | 600 å…ƒ         |
| **æœºç®±**   | çˆ±å›½è€… é»‘æ›¼å·´ F2 é»‘è‰² E-ATX æœºç®±                   | 180 å…ƒ         |
| **æ˜¾å¡**   | **NVIDIA RTX 2080 Ti 22GB**              | **2500 å…ƒ**    |
| **åˆè®¡**   | **4750 å…ƒ**                               |               |

* å®é™…æ€§èƒ½

  * æ¨ç†æ€§èƒ½ï¼šçº¦åœ¨3-5tokens/sï¼›

  * å¹¶å‘æ€§èƒ½ï¼šåœ¨5ä¸ªç”¨æˆ·ï¼Œå¹³å‡æ¯éš”1ç§’å‘é€ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå¤„ç†äº†50-100è¯·æ±‚æ—¶ï¼Œå“åº”é€Ÿåº¦çº¦ä¸º2ä¸ªtoken/sã€‚

  ![](images/2cc97ced-d553-4345-8442-94c95164a41b.png)

![](images/708c7d0a-ef02-4df0-a2d4-b7d6cf1ac287-1.png)

### 4. å‚è€ƒèµ„æ–™ä¸è¯¾ä»¶é¢†å–

å…¬å¼€è¯¾å…¨å¥—ä»£ç è¯¾ä»¶ã€ä»¥åŠé¡¹ç›®æºç å’Œè‡ªå®šä¹‰çš„è„šæœ¬ï¼Œéƒ½å·²ä¸Šä¼ è‡³â€èµ‹èŒƒå¤§æ¨¡å‹æŠ€æœ¯ç¤¾åŒºâ€œï¼Œä¸‹å›¾æ‰«ç å³å¯é¢†å–ï¼š

![](images/a5b11d65-e436-4a77-a387-0a8305c57324-1.png)

\[toc]

## äºŒã€KTransformerså…¥é—¨ä»‹ç»ä¸åŸºç¡€ç¯å¢ƒæ­å»º

### 1.KTransformersé¡¹ç›®å…¥é—¨ä»‹ç»

#### 1.1 é¡¹ç›®å®šä½

KTransformersï¼ˆå‘éŸ³ä¸ºâ€œQuick Transformersâ€ï¼‰æ—¨åœ¨é€šè¿‡å…ˆè¿›çš„å†…æ ¸ä¼˜åŒ–å’Œè®¡ç®—åˆ†å¸ƒ/å¹¶è¡ŒåŒ–ç­–ç•¥æ¥å¢å¼ºä½ ä½¿ç”¨Transformersçš„ä½“éªŒã€‚

KTransformers æ˜¯ä¸€ä¸ªçµæ´»ã€ä»¥ Python ä¸ºä¸­å¿ƒçš„æ¡†æ¶ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯å¯æ‰©å±•æ€§ã€‚ç”¨æˆ·ä»…éœ€ä¸€è¡Œä»£ç ï¼Œå³å¯å®ç°ä¼˜åŒ–æ¨¡å—çš„é›†æˆï¼Œå¹¶äº«å—åˆ°ä»¥ä¸‹ç‰¹æ€§ï¼š

* **ä¸ Transformers å…¼å®¹çš„æ¥å£**

* **ç¬¦åˆ OpenAI å’Œ Ollama è§„èŒƒçš„ RESTful API**

* **ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ ChatGPT é£æ ¼ Web UI**ï¼ˆæœ€æ–°ç‰ˆå·²å¼ƒç”¨ï¼‰

é¡¹ç›®å®šä½å°† KTransformers æ‰“é€ æˆä¸€ä¸ªçµæ´»çš„å¹³å°ï¼Œä¾›ç”¨æˆ·æ¢ç´¢å’Œå®éªŒåˆ›æ–°çš„å¤§æ¨¡å‹æ¨ç†ä¼˜åŒ–æŠ€æœ¯ã€‚å› æ­¤ï¼Œé¡¹ç›®æ”¯æŒç¼–å†™è‡ªå®šä¹‰è„šæœ¬æ¥å®ç°æ¨¡å‹æƒé‡çš„çµæ´»å¸è½½ã€‚

#### 1.2 é¡¹ç›®å‚è€ƒèµ„æ–™

* GitHubä¸»é¡µï¼šhttps://github.com/kvcache-ai/ktransformers

* é¡¹ç›®ä½¿ç”¨æŒ‡å—ï¼šhttps://kvcache-ai.github.io/ktransformers/index.html

#### 1.3 KTransformersæ”¯æŒçš„æ¨¡å‹åŠè¿è¡Œæ–¹å¼

* **KTæ”¯æŒçš„æ¨¡å‹ç±»å‹ï¼š**

![](images/8c025a81-4757-4e55-86a8-d8ab4f286d41.png)

* **KTæ”¯æŒçš„é‡åŒ–å½¢å¼**

![](images/8f04b6a4-5cf7-4b9f-aa8d-a44802a3e0ea.png)

æ³¨ï¼šå€ŸåŠ©æœ¬èŠ‚å…¬å¼€è¯¾æä¾›çš„ä¿®æ”¹åçš„KTæºç ï¼Œå¯ä»¥è¿è¡ŒUnsloth 1.58bité‡åŒ–æ¨¡å‹

![](images/40ea183d-6a2a-44d6-a251-2de23dfba34c-1.png)

* **ä¸åŒæ¨¡å‹æ‰€éœ€è¿è¡Œæ¡ä»¶**

![](images/465ec9bf-5693-48c6-a0fc-a52e3062365d-1.png)

æ³¨ï¼šæœ¬èŠ‚å…¬å¼€è¯¾è¿è¡Œçš„1.58bitåŠ¨æ€é‡åŒ–æ¨¡å‹ï¼Œä»…éœ€60Gå†…å­˜+14Gæ˜¾å­˜å³å¯ï¼Œå¹¶èƒ½è¾¾åˆ°95%çš„Q4\_K\_Mæ¨¡å‹æ€§èƒ½ã€‚

#### 1.4 KTransformerséƒ¨ç½²æ–¹æ³•

&#x20;       KTransformersæ”¯æŒåœ¨Windowsã€Linuxç­‰æ“ä½œç³»ç»Ÿä¸‹ï¼Œä½¿ç”¨æºç éƒ¨ç½²æˆ–è€…dockerå·¥å…·è¿›è¡Œéƒ¨ç½²ã€‚è€ƒè™‘åˆ°æ›´ä¸ºä¸€èˆ¬çš„ä¼ä¸šçº§åº”ç”¨åœºæ™¯ï¼Œæœ¬æ¬¡å®éªŒé‡‡ç”¨Linuxç³»ç»Ÿä½œä¸ºåŸºç¡€ç¯å¢ƒè¿›è¡Œæ¼”ç¤ºï¼Œå¹¶é‡‡ç”¨æºç éƒ¨ç½²çš„æ–¹æ³•è¿›è¡Œéƒ¨ç½²ã€‚

### 2.DeepSeek R1æ¨¡å‹æƒé‡ä¸é…ç½®æ–‡ä»¶ä¸‹è½½

&#x20;       æœ¬æ¬¡å®éªŒä½¿ç”¨å®˜æ–¹æ¨èçš„DeepSeek R1 UD-IQ1\_Sï¼Œç›´æ¥ä½¿ç”¨Unslothå‹åˆ¶çš„æ¨¡å‹å³å¯ï¼Œæ¨¡å‹ä¸‹è½½åœ°å€ï¼š

* é­”æ­ç¤¾åŒºä¸‹è½½åœ°å€ï¼šhttps://www.modelscope.cn/models/unsloth/DeepSeek-R1-GGUF

![](images/60646118-80f3-4d13-b02f-2c52c71b94ad.png)

* &#x20;

![](images/02804e67-6a91-434f-83d9-acaa67de76db.png)

* &#x20;

![](images/a0a3ee75-1777-4280-8157-d4f13aaa158f.png)

* HuggingFaceä¸‹è½½åœ°å€ï¼šhttps://huggingface.co/unsloth/DeepSeek-R1-GGUF

![](images/71f42929-79a8-4144-84e5-f1ef05c56271.png)

![](images/171c577a-a425-460b-95de-eb47381c1cd1.png)

&#x20;

![](images/181010eb-1d91-4de8-8944-c73a3704f640.png)

æ¨¡å‹æƒé‡è¾ƒå¤§ï¼Œæ€»å…±çº¦130Gå·¦å³ã€‚è‹¥ä½¿ç”¨HuggingFaceè¿›è¡Œä¸‹è½½ï¼Œåˆ™éœ€è¦ä¸€äº›ç½‘ç»œå·¥å…·ã€‚

è¿™é‡Œæ¨èä½¿ç”¨é­”æ­ç¤¾åŒºè¿›è¡Œä¸‹è½½ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

* ã€å¯é€‰ã€‘å€ŸåŠ©screenæŒä¹…åŒ–ä¼šè¯

* ç”±äºå®é™…ä¸‹è½½æ—¶é—´å¯èƒ½æŒç»­2ä¸ªå°æ—¶ï¼Œå› æ­¤æœ€å¥½ä½¿ç”¨screenå¼€å¯æŒä¹…åŒ–ä¼šè¯ï¼Œé¿å…å› ä¸ºå…³é—­ä¼šè¯å¯¼è‡´ä¸‹è½½ä¸­æ–­ã€‚

```bash
screen -S kt
```

* åˆ›å»ºä¸€ä¸ªåä¸ºktçš„ä¼šè¯ã€‚ä¹‹åå“ªæ€•å…³é—­äº†å½“å‰ä¼šè¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤

```bash
screen -r kt
```

* è‹¥æœªå®‰è£…screenï¼Œå¯ä»¥ä½¿ç”¨`sudo apt install screen`å‘½ä»¤è¿›è¡Œå®‰è£…ã€‚

* ä½¿ç”¨é­”æ­ç¤¾åŒºè¿›è¡Œä¸‹è½½

* ä½¿ç”¨modelscopeè¿›è¡Œæƒé‡ä¸‹è½½ï¼Œéœ€è¦å…ˆå®‰è£…é­”æ­ç¤¾åŒº

```bash
pip install modelscope
```

* ç„¶åè¾“å…¥å¦‚ä¸‹å‘½ä»¤è¿›è¡Œä¸‹è½½

```bash
mkdir ./DeepSeek-R1-GGUF
```

```bash
modelscope download --model unsloth/DeepSeek-R1-GGUF  --include '**UD-IQ1_S**'  --local_dir /root/autodl-tmp/DeepSeek-R1-GGUF
```

![](images/72753e96-61ea-4788-926e-0ab6b09314e6.png)

* ç›¸å…³æ–‡ä»¶å¯ä»¥åœ¨è¯¾ä»¶ç½‘ç›˜ä¸­é¢†å–ï¼š

![](images/47cec661-31f3-47a1-8a96-b9e5f0bc6488.png)

* &#x20;

![](images/fd5083cf-54e5-4851-b9f6-a0e3f65e8ded.jpeg)

* ä¸‹è½½DeepSeek R1åŸç‰ˆæ¨¡å‹çš„é…ç½®æ–‡ä»¶

* æ­¤å¤–ï¼Œæ ¹æ®KTransformerçš„é¡¹ç›®è¦æ±‚ï¼Œè¿˜éœ€è¦ä¸‹è½½DeepSeek R1åŸç‰ˆæ¨¡å‹çš„é™¤äº†æ¨¡å‹æƒé‡æ–‡ä»¶å¤–çš„å…¶ä»–é…ç½®æ–‡ä»¶ï¼Œæ–¹ä¾¿è¿›è¡Œçµæ´»çš„ä¸“å®¶åŠ è½½ã€‚å› æ­¤æˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨modelscopeä¸‹è½½DeepSeek R1æ¨¡å‹é™¤äº†æ¨¡å‹æƒé‡ï¼ˆ.safetensorï¼‰å¤–çš„å…¶ä»–å…¨éƒ¨æ–‡ä»¶ï¼Œå¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼è¿›è¡Œä¸‹è½½

```bash
mkdir ./DeepSeek-R1
```

```bash
modelscope download --model deepseek-ai/DeepSeek-R1  --exclude '*.safetensors'  --local_dir /root/autodl-tmp/DeepSeek-R1
```

![](images/082446e6-1638-43fe-a253-39194eef062c.png)

* ä¸‹è½½åå®Œæ•´æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š

![](images/adc8b74e-2194-4a03-96ba-3e724755bfb1.png)

* ç›¸å…³æ–‡ä»¶ä¹Ÿå¯ä»¥åœ¨è¯¾ç¨‹è¯¾ä»¶ä¸­é¢†å–ï¼š

![](images/15a85b2a-fb58-4f4d-a05b-7de9f97dbdc7.png)

* &#x20;

![](images/fd5083cf-54e5-4851-b9f6-a0e3f65e8ded-3.jpeg)

* æˆæœæ±‡æ€»

* è¿™é‡Œæœ€ç»ˆæˆ‘ä»¬æ˜¯ä¸‹è½½äº†DeepSeek UD-IQ1\_Sæ¨¡å‹æƒé‡å’ŒDeepSeek R1çš„æ¨¡å‹é…ç½®æ–‡ä»¶ï¼Œå¹¶åˆ†åˆ«ä¿å­˜åœ¨ä¸¤ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼š

  * DeepSeek R1 UD-IQ1\_Sæ¨¡å‹æƒé‡åœ°å€ï¼š/root/autodl-tmp/DeepSeek-R1-GGUF/DeepSeek-R1-UD-IQ1\_S

  ![](images/8092f08d-fd34-42af-98b5-73baf44cafa9.png)

  * DeepSeek R1çš„æ¨¡å‹é…ç½®æ–‡ä»¶åœ°å€ï¼š/root/autodl-tmp/DeepSeek-R1

  ![](images/eeaf548f-f211-4c07-aa8b-5eea10fe6230.png)

## ä¸‰ã€KTransformer+UnslothåŠ¨æ€é‡åŒ–æ¨¡å‹éƒ¨ç½²ä¸è°ƒç”¨æµç¨‹

&#x20;       åœ¨å‡†å¤‡å¥½äº†DeepSeek R1 Q4\_K\_Mçš„æ¨¡å‹æƒé‡å’ŒDeepSeek R1æ¨¡å‹é…ç½®æ–‡ä»¶ä¹‹åï¼Œæ¥ä¸‹æ¥å¼€å§‹ç€æ‰‹éƒ¨ç½²KTransformerã€‚è¯¥é¡¹ç›®éƒ¨ç½²æµç¨‹éå¸¸å¤æ‚ï¼Œè¯·åŠ¡å¿…æ¯ä¸€æ­¥éƒ½é¡ºåˆ©å®Œæˆåï¼Œå†æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚åœ¨æ­£å¼å¼€å§‹å®‰è£…å‰ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦äº‹å…ˆå£°æ˜ï¼š

* å…³äºç‰ˆæœ¬ï¼šç›®å‰KTå¼€æ”¾äº†V2.0ã€V2.1å’ŒV3.0é¢„è§ˆç‰ˆã€‚è¯¾ç¨‹ä»¥ç›®å‰å…¼å®¹æ€§æœ€å¼ºçš„V2.0è¿›è¡Œæ¼”ç¤ºï¼Œå¹¶ä»‹ç»V3.0éƒ¨ç½²æ–¹æ³•ã€‚è‹¥CPUæ»¡è¶³è¦æ±‚ï¼ˆæœ‰AMXåŠŸèƒ½ï¼‰ï¼Œåˆ™å¯è¿è¡ŒV3.0ã€‚

* V3.0ç‰ˆæœ¬éœ€æ±‚ï¼šV3.0å¯¹è½¯ç¡¬ä»¶ç¯å¢ƒè¦æ±‚è¾ƒé«˜ï¼Œé™¤äº†è¦æ±‚CPUæ”¯æŒAMXåŠŸèƒ½å¤–ï¼Œè¿˜è¦æ±‚Python 3.11ä»¥ä¸ŠåŠCUDA12.6ã€‚

* \*\*æ³¨æ„ï¼\*\*æˆªæ­¢è§†é¢‘ä¸Šçº¿æ—¶ï¼ŒKTransformerså®˜æ–¹åº“å¹¶æœªæ”¯æŒ1.58bitåŠ¨æ€é‡åŒ–æ¨¡å‹ï¼Œå› æ­¤åªèƒ½é€šè¿‡ä¸‹è½½ä¿®æ”¹åçš„æºç è¿›è¡Œè¿è¡Œï¼š

![](images/0bb370aa-33b9-4a90-8e7e-d67ae911c81b-1.png)

&#x20;

![](images/fd5083cf-54e5-4851-b9f6-a0e3f65e8ded-2.jpeg)

### 1. å®‰è£…åŸºç¡€ä¾èµ–

* åˆ›å»ºè™šæ‹Ÿç¯å¢ƒã€å¯é€‰ã€‘

```bash
conda create --name kt python=3.11
conda init
source ~/.bashrc
conda activate kt
```

ç„¶åéœ€è¦å®‰è£…**gcc**ã€**g++** å’Œ **cmake**ç­‰åŸºç¡€åº“ï¼š

```bash
sudo apt-get update
sudo apt-get install gcc g++ cmake ninja-build
```

ç„¶åç»§ç»­å®‰è£… **PyTorch**ã€**packaging**ã€**ninja**ï¼š

```bash
pip install torch packaging ninja cpufeature numpy
```

æ¥ä¸‹æ¥éœ€è¦ç»§ç»­å®‰è£…`flash-attn`ï¼š

```bash
pip install flash-attn
```

ä»¥åŠéœ€è¦æ‰‹åŠ¨å®‰è£…`libstdc`ï¼š

```bash
sudo apt-get install --only-upgrade libstdc++6
```

```bash
conda install -c conda-forge libstdcxx-ng
```

ç„¶åéœ€è¦å®‰è£…24.11.0ç‰ˆconda-libmamba-solverï¼š

```bash
conda install conda-libmamba-solver=24.11.0
```

### 2. å®‰è£…KTransformers

åœ¨ç½‘ç›˜ä¸­ä¸‹è½½KTå‹ç¼©åŒ…ï¼š

![](images/0bb370aa-33b9-4a90-8e7e-d67ae911c81b.png)

&#x20;

![](images/fd5083cf-54e5-4851-b9f6-a0e3f65e8ded-1.jpeg)

ä¸Šä¼ è‡³æœåŠ¡å™¨æŒ‡å®šè·¯å¾„`/root/autodl-tmp`ï¼Œ

![](images/d60c63d1-de1c-4bf6-9183-f9c47d91ae5b.png)

ç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œè§£å‹ç¼©ï¼š

```bash
tar -xzvf ktransformers_offline.tar.gz
cd ktransformers
```

![](images/522adc3c-6d1f-45b6-8c14-3f93980ee21a.png)

è¯¥å‹ç¼©åŒ…å·²åŒ…å«ç›¸å…³ä¾èµ–ç¬¬ä¸‰æ–¹é¡¹ç›®ï¼Œå¦‚llama.cppç­‰ã€‚

![](images/d3b4412f-1ff0-484d-bcd7-b61072ac69d8.png)

æ¥ä¸‹è¦éœ€è¦ç¡®è®¤å½“å‰CPUçš„ç±»å‹ï¼Œå¦‚æœæ˜¯åŒæ§½ç‰ˆæœ¬64æ ¸CPUï¼Œåˆ™éœ€è¦ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è®¾ç½®NUMA=1ï¼š

```bash
export USE_NUMA=1
```

ä¾‹å¦‚ï¼Œå‡è®¾å½“å‰çš„æœåŠ¡å™¨CPUä¸ºï¼š64 vCPU Intel(R) Xeon(R) Gold 6430

![](images/393a5618-989f-4bc0-a1d5-797751664a08.png)

ä»£è¡¨çš„å°±æ˜¯64æ ¸åŒæ§½CPUï¼Œè¿™ç§CPUå¾€å¾€å‡ºç°åœ¨æœåŠ¡å™¨ä½¿ç”¨åœºæ™¯ä¸­ã€‚

å› æ­¤è¿™é‡Œéœ€è¦å…ˆè¾“å…¥`export USE_NUMA=1`ï¼Œç„¶åå†æ‰§è¡Œåç»­å‘½ä»¤ã€‚è€Œè¿™é‡Œå¦‚æœä¸æ˜¯64æ ¸åŒæ§½CPUï¼Œåˆ™æ— éœ€æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ã€‚è€Œè‹¥æ˜¯64æ ¸åŒæ§½CPUï¼Œä½†æœªæ‰§è¡Œ`export USE_NUMA=1`å°±æ‰§è¡Œäº†åç»­å‘½ä»¤ï¼Œåˆ™éœ€è¦å†æ¬¡è¾“å…¥`export USE_NUMA=1`ï¼Œç„¶åå†æ¬¡è¿è¡Œåé¢çš„å‘½ä»¤ã€‚

è€Œå¦‚æœæ˜¯å•æ§½CPUï¼Œå¦‚ï¼š

![](images/54b3f021-1bd4-4b13-bdd7-c0747830babc.png)

åˆ™ä¸ç”¨è®¾ç½®`USE_NUMA=1`ã€‚

ç¡®è®¤åå³å¯è¿›è¡Œç¼–è¯‘å’Œå®‰è£…ï¼š

```bash
sh ./install.sh
```

![](images/f8b20de5-c797-4a6b-9bb3-ce7ae3ab3508.png)

éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´æ‰èƒ½ç¼–è¯‘å®Œæˆï¼š

![](images/963faae4-9c76-43aa-b2d8-d1a5b107273a.png)

![](images/8b1a7e78-1c08-4b23-9411-a05949e48631.png)

![](images/e594ddbe-72a9-4508-8782-9c0ddf7c81d3.png)

ä¸€åˆ‡å®‰è£…å®Œæˆåï¼Œå³å¯è¾“å…¥å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰å®‰è£…æƒ…å†µ

```bash
pip show ktransformers
```

![](images/59d18d39-93e5-4628-a65a-942ad5605854.png)

### 3.è¿è¡ŒKTransformer

&#x20;       éƒ¨ç½²å®Œæˆåï¼Œå³å¯å°è¯•è°ƒç”¨KTransformerè¿›è¡Œå¯¹è¯ã€‚è¿™é‡Œå¯ä»¥é‡‡ç”¨å®˜æ–¹æä¾›çš„æœ€ç®€å•çš„å¯¹è¯è„šæœ¬`local_chat.py`è¿›è¡Œå¯¹è¯ï¼š

![](images/b7234537-462f-464b-a6b1-cf146f25fb9d.png)

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š

```bash
python ./ktransformers/local_chat.py --model_path /root/autodl-tmp/DeepSeek-R1 --gguf_path /root/autodl-tmp/DeepSeek-R1-GGUF/DeepSeek-R1-UD-IQ1_S --max_new_tokens 2048 --force_think true
```

![](images/20127779-5d58-4cbb-b671-90eaa8fa2443.png)

å‚æ•°è§£é‡Šå¦‚ä¸‹ï¼š

* `<ä½ çš„æ¨¡å‹è·¯å¾„>` å¯ä»¥æ˜¯æœ¬åœ°è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯æ¥è‡ª Hugging Face çš„åœ¨çº¿è·¯å¾„ï¼ˆå¦‚ `deepseek-ai/DeepSeek-V3`ï¼‰ã€‚å¦‚æœåœ¨çº¿å‡ºç°è¿æ¥é—®é¢˜ï¼Œå°è¯•ä½¿ç”¨é•œåƒç«™ç‚¹ï¼ˆå¦‚ `hf-mirror.com`ï¼‰ã€‚

* `<ä½ çš„GGUFè·¯å¾„>` ä¹Ÿå¯ä»¥æ˜¯åœ¨çº¿è·¯å¾„ï¼Œä½†ç”±äºæ–‡ä»¶è¾ƒå¤§ï¼Œå»ºè®®ä¸‹è½½å¹¶é‡åŒ–æ¨¡å‹ä»¥æ»¡è¶³éœ€æ±‚ï¼ˆæ³¨æ„ï¼Œè¿™æ˜¯ç›®å½•è·¯å¾„ï¼‰ã€‚

* `--max_new_tokens 2048` æ˜¯æœ€å¤§è¾“å‡ºtokené•¿åº¦ã€‚å¦‚æœå‘ç°ç­”æ¡ˆè¢«æˆªæ–­ï¼Œå¯ä»¥å¢åŠ è¯¥å€¼ä»¥è·å¾—æ›´é•¿çš„ç­”æ¡ˆï¼ˆä½†è¯·æ³¨æ„ï¼Œå¢å¤§ä¼šå¯¼è‡´OOMé—®é¢˜ï¼Œå¹¶ä¸”å¯èƒ½å‡æ…¢ç”Ÿæˆé€Ÿåº¦ï¼‰ã€‚

* `--force_think true`ã€‚æ‰“å°R1æ¨¡å‹çš„æ€è€ƒè¿‡ç¨‹ã€‚

### 4.å®é™…è¿è¡Œæ•ˆæœå±•ç¤º

å®é™…å†…å­˜ä½¿ç”¨ï¼š

![](images/b2f8fa97-f645-423b-af59-bfc31ad728dd-1.png)

* å¯åŠ¨è¿‡ç¨‹

* éœ€è¦å®Œæ•´åŠ è½½61å±‚æ¨¡å‹æƒé‡

![](images/d3e5cd55-27f8-49c3-bce9-83f15a9855f3.png)

* å¼€å¯å¯¹è¯

* ç¨ç­‰ç‰‡åˆ»å³å¯å¼€å¯å‘½ä»¤è¡Œå¯¹è¯ï¼š

![](images/d98946b4-08c0-4817-8b4a-e4c62ffa7b90.png)

* å“åº”é€Ÿåº¦

![](images/19ae4949-544e-4816-b3f3-bff19c96b15a.png)

* **æç¤ºé˜¶æ®µï¼ˆprompt evalï¼‰**ï¼šæ¨¡å‹å¤„ç†äº† 12 ä¸ª tokenï¼Œè€—æ—¶ 1.4 ç§’ï¼Œå¤„ç†é€Ÿç‡ä¸º 8 ä¸ª token æ¯ç§’ã€‚

* **è¯„ä¼°é˜¶æ®µï¼ˆeval evalï¼‰**ï¼šæ¨¡å‹å¤„ç†äº† 277 ä¸ª tokenï¼Œè€—æ—¶ 54 ç§’ï¼Œå¤„ç†é€Ÿç‡ä¸º 5 ä¸ª token æ¯ç§’ã€‚

* ç”±äºAutoDLæ˜¯è™šæ‹ŸåŒ–ç¯å¢ƒè¿›è¡Œçš„è¿è¡Œï¼Œæ€§èƒ½æ–¹é¢ä¼šå—å½±å“ã€‚

* æ˜¾å­˜å ç”¨

* ä»…å ç”¨ä¸åˆ°14Gæ˜¾å­˜ã€‚

![](images/2f9e2828-8b3c-447f-9128-f4ddf4e5d715-1.png)

* å®é™…å†…å­˜ä½¿ç”¨çº¦60Gï¼š

![](images/b2f8fa97-f645-423b-af59-bfc31ad728dd-2.png)

## å››ã€åˆ›å»ºAPIä¸æ¥å…¥Open-WebUI

### 1.å¼€å¯APIæœåŠ¡

ç›®å‰å®‰è£…åŒ…å·²ä¿®å¤server APIçš„è‹¥å¹²Bugï¼Œå·²ç»å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚åœ¨ç½‘ç›˜ä¸­ä¸‹è½½KTå‹ç¼©åŒ…ï¼š

![](images/0bb370aa-33b9-4a90-8e7e-d67ae911c81b-2.png)

&#x20;

![](images/fd5083cf-54e5-4851-b9f6-a0e3f65e8ded-4.jpeg)

ç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯åˆ›å»ºAPIæœåŠ¡ï¼Œå…¶ä¸­ç«¯å£å·å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè‡ªè¡Œè®¾ç½®ï¼š

```bash
ktransformers --model_path /root/autodl-tmp/DeepSeek-R1 --gguf_path /root/autodl-tmp/DeepSeek-R1-GGUF/DeepSeek-R1-UD-IQ1_S  --port 10002
```

ç¨ç­‰ç‰‡åˆ»ç­‰å¾…å¯åŠ¨å®Œæˆå³å¯ï¼š

![](images/d5186311-3fc2-4239-b357-db780c3f8502.png)

&#x20;

![](images/1e67ece8-5254-434e-9d4c-3310d96fecf9.png)

### 2. APIè°ƒç”¨æµç¨‹

* å‘½ä»¤è¡Œè°ƒç”¨

å¯åŠ¨å®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æµ‹è¯•èƒ½å¦é¡ºåˆ©è¿æ¥ï¼š

```bash
curl -X POST \
  'http://localhost:10002/v1/chat/completions' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
    "messages": [
      {
        "content": "ä½ å¥½å‘€ã€‚",
        "role": "user"
      }
    ],
    "model": "DeepSeek-R1",
    "stream": false
  }'
```

æ­¤æ—¶åç«¯å“åº”ç»“æœå¦‚ä¸‹ï¼š

![](images/b2f90d97-72cb-4441-b16a-ca3e7a39829e.png)

å‰ç«¯è¿”å›ç»“æœå¦‚ä¸‹ï¼š

![](images/e150760d-ee9f-42eb-afee-59cd967ada5f.png)

* Jupyterä¸­ä½¿ç”¨OpenAIé£æ ¼è°ƒç”¨

* éœ€è¦æå‰å®‰è£…openaiåº“ï¼š

```bash
pip install openai
```

![](images/e1d51297-bbe8-4e26-9c18-a19c3ac1bf7c.png)

&#x20;       ç„¶ååœ¨Jupyterä¸­æµ‹è¯•ä½¿ç”¨ï¼š

```python
from openai import OpenAI

ds_api_key = "none"

# å®ä¾‹åŒ–å®¢æˆ·ç«¯
client = OpenAI(api_key=ds_api_key, 
                base_url="http://localhost:10002/v1")

# è°ƒç”¨ deepseek æ¨¡å‹
response = client.chat.completions.create(
    model="Deepseek-R1",
    messages=[
        {"role": "user", "content": "ä½ å¥½ï¼Œå¥½ä¹…ä¸è§!è¯·ä»‹ç»ä¸‹ä½ è‡ªå·±ã€‚"}
    ]
)

response
```

![](images/cba95da0-1d3d-4f61-9a28-c920b798616b.png)

æ­¤æ—¶åç«¯å“åº”å¦‚ä¸‹ï¼š

![](images/6907ca6f-8778-40ba-8bf8-4602e5d9ddc7.png)

ç„¶åå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼æå–å‡ºæ€è€ƒé“¾å†…å®¹ï¼š

```python
import re

# åŸå§‹æ–‡æœ¬
text = response.choices[0].message.content

# ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–<think>å’Œ</think>ä¹‹é—´çš„å†…å®¹
think_content = re.search(r'<think>(.*?)</think>', text, re.DOTALL)

# æå–åˆ°çš„å†…å®¹
think_content_text = think_content.group(1) if think_content else None
think_content_text
```

![](images/69e107d9-3e92-4945-8990-2018e1cc9cee.png)

&#x20;

![](images/2295d75f-ce61-480d-99b5-d72d969c6767.png)

### 3. å°†APIæ¥å…¥Open-WebUI

* æœ¬åœ°éƒ¨ç½²Open-WebUI

é¦–å…ˆéœ€è¦å®‰è£…Open-WebUIï¼Œå®˜ç½‘åœ°å€å¦‚ä¸‹ï¼šhttps://github.com/open-webui/open-webuiã€‚

![](images/15910a4b-d72f-4dbc-bad4-c18aa0515ba8.png)

æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨pipå‘½ä»¤å¿«é€Ÿå®Œæˆå®‰è£…ï¼š

```bash
pip install open-webui
```

![](images/81bbd822-ddf9-4f6e-9039-64910efb0c24.png)

* å¼€å¯Open-WebUIæœåŠ¡

ç„¶åéœ€è¦è®¾ç½®ç¦»çº¿ç¯å¢ƒï¼Œé¿å…Open-WebUIå¯åŠ¨æ—¶è‡ªåŠ¨è¿›è¡Œæ¨¡å‹ä¸‹è½½ï¼š

```bash
export HF_HUB_OFFLINE=1
```

ç„¶åå¯åŠ¨Open-WebUI

```bash
open-webui serve
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå¯åŠ¨çš„æ—¶å€™ä»ç„¶æŠ¥é”™æ˜¾ç¤ºæ— æ³•ä¸‹è½½æ¨¡å‹ï¼Œæ˜¯Open-WebUIè¯•å›¾ä»huggingfaceä¸Šä¸‹è½½embeddingæ¨¡å‹ï¼Œä¹‹åæˆ‘ä»¬ä¼šæ‰‹åŠ¨å°†å…¶åˆ‡æ¢ä¸ºæœ¬åœ°è¿è¡Œçš„Embeddingæ¨¡å‹ã€‚

![](images/36021977-57e2-4973-9983-36dce8414ebc.png)

ç„¶ååœ¨æœ¬åœ°æµè§ˆå™¨è¾“å…¥åœ°å€:8080ç«¯å£å³å¯è®¿é—®ï¼š

![](images/0483bbb9-3689-41d3-88f9-a533dfba919d.png)

ç„¶åé¦–æ¬¡ä½¿ç”¨å‰ï¼Œéœ€è¦åˆ›å»ºç®¡ç†å‘˜è´¦å·ï¼š

![](images/4976fae9-bf6e-4d1b-8586-d09dad195a23.png)

ç„¶åç‚¹å‡»ç™»å½•å³å¯ã€‚ç¨ç­‰ç‰‡åˆ»ï¼Œå³å¯è¿›å…¥åˆ°å¦‚ä¸‹é¡µé¢ï¼š

![](images/401a3bdc-26dc-4ddd-ac2d-bf6e71d2c629.png)

* è¿æ¥æœ¬åœ°æ¨¡å‹API

æ­¤æ—¶åå°æ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•æ¨¡å‹ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºå’Œæœ¬åœ°çš„APIè¿æ¥ï¼Œæ‰èƒ½é¡ºåˆ©è°ƒç”¨æœ¬åœ°æ¨¡å‹ã€‚è¿™é‡Œç‚¹å‡»å·¦ä¸‹è§’è®¾ç½®â€”>å‡½æ•°â€”>åŠ å·ï¼š

![](images/49999311-de7b-4dd8-bcfb-af7f003f8832.png)

å†™å…¥å¦‚ä¸‹è„šæœ¬ä»£ç ï¼š

![](images/3ce3b3aa-7300-405a-9bba-569ccb6a5d18.png)

```python
import json
import httpx
import re
from typing import AsyncGenerator, Callable, Awaitable
from pydantic import BaseModel, Field
import asyncio
import traceback


class Pipe:
    class Valves(BaseModel):
        DEEPSEEK_API_BASE_URL: str = Field(
            default="https://api.deepseek.com/v1",
            description="DeepSeek APIçš„åŸºç¡€è¯·æ±‚åœ°å€",
        )
        DEEPSEEK_API_KEY: str = Field(
            default="", description="ç”¨äºèº«ä»½éªŒè¯çš„DeepSeek APIå¯†é’¥ï¼Œå¯ä»æ§åˆ¶å°è·å–"
        )
        DEEPSEEK_API_MODEL: str = Field(
            default="deepseek-reasoner",
            description="APIè¯·æ±‚çš„æ¨¡å‹åç§°ï¼Œé»˜è®¤ä¸º deepseek-reasonerï¼Œå¤šæ¨¡å‹åå¯ä½¿ç”¨`,`åˆ†éš”",
        )

    def __init__(self):
        self.valves = self.Valves()
        self.data_prefix = "data:"
        self.emitter = None

    def pipes(self):
        models = self.valves.DEEPSEEK_API_MODEL.split(",")
        return [
            {
                "id": model.strip(),
                "name": model.strip(),
            }
            for model in models
        ]

    async def pipe(
        self, body: dict, __event_emitter__: Callable[[dict], Awaitable[None]] = None
    ) -> AsyncGenerator[str, None]:
        """ä¸»å¤„ç†ç®¡é“ï¼ˆå·²ç§»é™¤ç¼“å†²ï¼‰"""
        thinking_state = {"thinking": -1}  # ç”¨äºå­˜å‚¨thinkingçŠ¶æ€
        self.emitter = __event_emitter__
        # ç”¨äºå­˜å‚¨è”ç½‘æ¨¡å¼ä¸‹è¿”å›çš„å‚è€ƒèµ„æ–™åˆ—è¡¨
        stored_references = []

        # è”ç½‘æœç´¢ä¾›åº”å•† 0-æ—  1-ç«å±±å¼•æ“ 2-PPLXå¼•æ“ 3-ç¡…åŸºæµåŠ¨
        search_providers = 0
        waiting_for_reference = False

        # ç”¨äºå¤„ç†ç¡…åŸºçš„ [citation:1] çš„æ ˆ
        citation_stack_reference = [
            "[",
            "c",
            "i",
            "t",
            "a",
            "t",
            "i",
            "o",
            "n",
            ":",
            "",
            "]",
        ]
        citation_stack = []
        # ä¸´æ—¶ä¿å­˜çš„æœªå¤„ç†çš„å­—ç¬¦ä¸²
        unprocessed_content = ""

        # éªŒè¯é…ç½®
        if not self.valves.DEEPSEEK_API_KEY:
            yield json.dumps({"error": "æœªé…ç½®APIå¯†é’¥"}, ensure_ascii=False)
            return
        # å‡†å¤‡è¯·æ±‚å‚æ•°
        headers = {
            "Authorization": f"Bearer {self.valves.DEEPSEEK_API_KEY}",
            "Content-Type": "application/json",
        }
        try:
            # æ¨¡å‹IDæå–
            model_id = body["model"].split(".", 1)[-1]
            payload = {**body, "model": model_id}
            # å¤„ç†æ¶ˆæ¯ä»¥é˜²æ­¢è¿ç»­çš„ç›¸åŒè§’è‰²
            messages = payload["messages"]
            i = 0
            while i < len(messages) - 1:
                if messages[i]["role"] == messages[i + 1]["role"]:
                    # æ’å…¥å…·æœ‰æ›¿ä»£è§’è‰²çš„å ä½ç¬¦æ¶ˆæ¯
                    alternate_role = (
                        "assistant" if messages[i]["role"] == "user" else "user"
                    )
                    messages.insert(
                        i + 1,
                        {"role": alternate_role, "content": "[Unfinished thinking]"},
                    )
                i += 1

            # å‘èµ·APIè¯·æ±‚
            async with httpx.AsyncClient(http2=True) as client:
                async with client.stream(
                    "POST",
                    f"{self.valves.DEEPSEEK_API_BASE_URL}/chat/completions",
                    json=payload,
                    headers=headers,
                    timeout=300,
                ) as response:

                    # é”™è¯¯å¤„ç†
                    if response.status_code != 200:
                        error = await response.aread()
                        yield self._format_error(response.status_code, error)
                        return

                    # æµå¼å¤„ç†å“åº”
                    async for line in response.aiter_lines():
                        if not line.startswith(self.data_prefix):
                            continue

                        # æˆªå– JSON å­—ç¬¦ä¸²
                        json_str = line[len(self.data_prefix) :].strip()

                        # å»é™¤é¦–å°¾ç©ºæ ¼åæ£€æŸ¥æ˜¯å¦ä¸ºç»“æŸæ ‡è®°
                        if json_str == "[DONE]":
                            return
                        try:
                            data = json.loads(json_str)
                        except json.JSONDecodeError as e:
                            error_detail = f"è§£æå¤±è´¥ - å†…å®¹ï¼š{json_str}ï¼ŒåŸå› ï¼š{e}"
                            yield self._format_error("JSONDecodeError", error_detail)
                            return

                        if search_providers == 0:
                            # æ£€æŸ¥ delta ä¸­çš„æœç´¢ç»“æœ
                            choices = data.get("choices")
                            if not choices or len(choices) == 0:
                                continue  # è·³è¿‡æ²¡æœ‰ choices çš„æ•°æ®å—
                            delta = choices[0].get("delta", {})
                            if delta.get("type") == "search_result":
                                search_results = delta.get("search_results", [])
                                if search_results:
                                    ref_count = len(search_results)
                                    yield '<details type="search">\n'
                                    yield f"<summary>å·²æœç´¢ {ref_count} ä¸ªç½‘ç«™</summary>\n"
                                    for idx, result in enumerate(search_results, 1):
                                        yield f'> {idx}. [{result["title"]}]({result["url"]})\n'
                                    yield "</details>\n"
                                    search_providers = 3
                                    stored_references = search_results
                                    continue

                            # å¤„ç†å‚è€ƒèµ„æ–™
                            stored_references = data.get("references", []) + data.get(
                                "citations", []
                            )
                            if stored_references:
                                ref_count = len(stored_references)
                                yield '<details type="search">\n'
                                yield f"<summary>å·²æœç´¢ {ref_count} ä¸ªç½‘ç«™</summary>\n"
                            # å¦‚æœdataä¸­æœ‰referencesï¼Œåˆ™è¯´æ˜æ˜¯ç«å±±å¼•æ“çš„è¿”å›ç»“æœ
                            if data.get("references"):
                                for idx, reference in enumerate(stored_references, 1):
                                    yield f'> {idx}. [{reference["title"]}]({reference["url"]})\n'
                                yield "</details>\n"
                                search_providers = 1
                            # å¦‚æœdataä¸­æœ‰citationsï¼Œåˆ™è¯´æ˜æ˜¯PPLXå¼•æ“çš„è¿”å›ç»“æœ
                            elif data.get("citations"):
                                for idx, reference in enumerate(stored_references, 1):
                                    yield f"> {idx}. {reference}\n"
                                yield "</details>\n"
                                search_providers = 2

                        # æ–¹æ¡ˆ A: æ£€æŸ¥ choices æ˜¯å¦å­˜åœ¨ä¸”éç©º
                        choices = data.get("choices")
                        if not choices or len(choices) == 0:
                            continue  # è·³è¿‡æ²¡æœ‰ choices çš„æ•°æ®å—
                        choice = choices[0]

                        # ç»“æŸæ¡ä»¶åˆ¤æ–­
                        if choice.get("finish_reason"):
                            return

                        # çŠ¶æ€æœºå¤„ç†
                        state_output = await self._update_thinking_state(
                            choice.get("delta", {}), thinking_state
                        )
                        if state_output:
                            yield state_output
                            if state_output == "<think>":
                                yield "\n"

                        # å¤„ç†å¹¶ç«‹å³å‘é€å†…å®¹
                        content = self._process_content(choice["delta"])
                        if content:
                            # å¤„ç†æ€è€ƒçŠ¶æ€æ ‡è®°
                            if content.startswith("<think>"):
                                content = re.sub(r"^<think>", "", content)
                                yield "<think>"
                                await asyncio.sleep(0.1)
                                yield "\n"
                            elif content.startswith("</think>"):
                                content = re.sub(r"^</think>", "", content)
                                yield "</think>"
                                await asyncio.sleep(0.1)
                                yield "\n"

                            # å¤„ç†å‚è€ƒèµ„æ–™
                            if search_providers == 1:
                                # ç«å±±å¼•æ“çš„å‚è€ƒèµ„æ–™å¤„ç†
                                # å¦‚æœæ–‡æœ¬ä¸­åŒ…å«"æ‘˜è¦"ï¼Œè®¾ç½®ç­‰å¾…æ ‡å¿—
                                if "æ‘˜è¦" in content:
                                    waiting_for_reference = True
                                    yield content
                                    continue

                                # å¦‚æœæ­£åœ¨ç­‰å¾…å‚è€ƒèµ„æ–™çš„æ•°å­—
                                if waiting_for_reference:
                                    # å¦‚æœå†…å®¹ä»…åŒ…å«æ•°å­—æˆ–"ã€"
                                    if re.match(r"^(\d+|ã€)$", content.strip()):
                                        numbers = re.findall(r"\d+", content)
                                        if numbers:
                                            num = numbers[0]
                                            ref_index = int(num) - 1
                                            if 0 <= ref_index < len(stored_references):
                                                ref_url = stored_references[ref_index][
                                                    "url"
                                                ]
                                            else:
                                                ref_url = ""
                                            content = f"[[{num}]]({ref_url})"
                                        # ä¿æŒç­‰å¾…çŠ¶æ€ç»§ç»­å¤„ç†åç»­æ•°å­—
                                    # å¦‚æœé‡åˆ°éæ•°å­—ä¸”é"ã€"çš„å†…å®¹ä¸”ä¸å«"æ‘˜è¦"ï¼Œåœæ­¢ç­‰å¾…
                                    elif not "æ‘˜è¦" in content:
                                        waiting_for_reference = False
                            elif search_providers == 2:
                                # PPLXå¼•æ“çš„å‚è€ƒèµ„æ–™å¤„ç†
                                def replace_ref(m):
                                    idx = int(m.group(1)) - 1
                                    if 0 <= idx < len(stored_references):
                                        return f"[[{m.group(1)}]]({stored_references[idx]})"
                                    return f"[[{m.group(1)}]]()"

                                content = re.sub(r"\[(\d+)\]", replace_ref, content)
                            elif search_providers == 3:
                                skip_outer = False

                                if len(unprocessed_content) > 0:
                                    content = unprocessed_content + content
                                    unprocessed_content = ""

                                for i in range(len(content)):
                                    # æ£€æŸ¥ content[i] æ˜¯å¦å¯è®¿é—®
                                    if i >= len(content):
                                        break
                                    # æ£€æŸ¥ citation_stack_reference[len(citation_stack)] æ˜¯å¦å¯è®¿é—®
                                    if len(citation_stack) >= len(
                                        citation_stack_reference
                                    ):
                                        break
                                    if (
                                        content[i]
                                        == citation_stack_reference[len(citation_stack)]
                                    ):
                                        citation_stack.append(content[i])
                                        # å¦‚æœ citation_stack çš„ä½æ•°ç­‰äº citation_stack_reference çš„ä½æ•°ï¼Œåˆ™ä¿®æ”¹ä¸º URL æ ¼å¼è¿”å›
                                        if len(citation_stack) == len(
                                            citation_stack_reference
                                        ):
                                            # æ£€æŸ¥ citation_stack[10] æ˜¯å¦å¯è®¿é—®
                                            if len(citation_stack) > 10:
                                                ref_index = int(citation_stack[10]) - 1
                                                # æ£€æŸ¥ stored_references[ref_index] æ˜¯å¦å¯è®¿é—®
                                                if (
                                                    0
                                                    <= ref_index
                                                    < len(stored_references)
                                                ):
                                                    ref_url = stored_references[
                                                        ref_index
                                                    ]["url"]
                                                else:
                                                    ref_url = ""

                                                # å°†contentä¸­å‰©ä½™çš„éƒ¨åˆ†ä¿å­˜åˆ°unprocessed_contentä¸­
                                                unprocessed_content = "".join(
                                                    content[i + 1 :]
                                                )

                                                content = f"[[{citation_stack[10]}]]({ref_url})"
                                                citation_stack = []
                                                skip_outer = False
                                                break
                                        else:
                                            skip_outer = True
                                    elif (
                                        citation_stack_reference[len(citation_stack)]
                                        == ""
                                    ):
                                        # åˆ¤æ–­æ˜¯å¦ä¸ºæ•°å­—
                                        if content[i].isdigit():
                                            citation_stack.append(content[i])
                                            skip_outer = True
                                        else:
                                            # å°† citation_stack ä¸­å…¨éƒ¨å…ƒç´ æ‹¼æ¥æˆå­—ç¬¦ä¸²
                                            content = "".join(citation_stack) + content
                                            citation_stack = []
                                    elif (
                                        citation_stack_reference[len(citation_stack)]
                                        == "]"
                                    ):
                                        # åˆ¤æ–­å‰ä¸€ä½æ˜¯å¦ä¸ºæ•°å­—
                                        if citation_stack[-1].isdigit():
                                            citation_stack[-1] += content[i]
                                            skip_outer = True
                                        else:
                                            content = "".join(citation_stack) + content
                                            citation_stack = []
                                    else:
                                        if len(citation_stack) > 0:
                                            # å°† citation_stack ä¸­å…¨éƒ¨å…ƒç´ æ‹¼æ¥æˆå­—ç¬¦ä¸²
                                            content = "".join(citation_stack) + content
                                            citation_stack = []

                                if skip_outer:
                                    continue

                            yield content
        except Exception as e:
            yield self._format_exception(e)

    async def _update_thinking_state(self, delta: dict, thinking_state: dict) -> str:
        """æ›´æ–°æ€è€ƒçŠ¶æ€æœºï¼ˆç®€åŒ–ç‰ˆï¼‰"""
        state_output = ""
        if thinking_state["thinking"] == -1 and delta.get("reasoning_content"):
            thinking_state["thinking"] = 0
            state_output = "<think>"
        elif (
            thinking_state["thinking"] == 0
            and not delta.get("reasoning_content")
            and delta.get("content")
        ):
            thinking_state["thinking"] = 1
            state_output = "\n</think>\n\n"
        return state_output

    def _process_content(self, delta: dict) -> str:
        """ç›´æ¥è¿”å›å¤„ç†åçš„å†…å®¹"""
        return delta.get("reasoning_content", "") or delta.get("content", "")

    def _emit_status(self, description: str, done: bool = False) -> Awaitable[None]:
        """å‘é€çŠ¶æ€æ›´æ–°"""
        if self.emitter:
            return self.emitter(
                {
                    "type": "status",
                    "data": {
                        "description": description,
                        "done": done,
                    },
                }
            )
        return None

    def _format_error(self, status_code: int, error: bytes) -> str:
        if isinstance(error, str):
            error_str = error
        else:
            error_str = error.decode(errors="ignore")
        try:
            err_msg = json.loads(error_str).get("message", error_str)[:200]
        except Exception:
            err_msg = error_str[:200]
        return json.dumps(
            {"error": f"HTTP {status_code}: {err_msg}"}, ensure_ascii=False
        )

    def _format_exception(self, e: Exception) -> str:
        tb_lines = traceback.format_exception(type(e), e, e.__traceback__)
        detailed_error = "".join(tb_lines)
        return json.dumps({"error": detailed_error}, ensure_ascii=False)
```

ç„¶åç‚¹å‡»å¼€å¯ï¼Œå¹¶ç‚¹å‡»é½¿è½®è¿›è¡Œè®¾ç½®ï¼š

![](images/6fde61a3-370f-4ee7-91b5-7c77edaa1c44.png)

è®¾ç½®æœ¬åœ°ç«¯å£ã€API Keyå’Œæ¨¡å‹åç§°ï¼š

![](images/ea51a795-192d-45f5-a38b-6bd38d83100b.png)

* å¼€å¯å¯¹è¯

ç‚¹å‡»ä¿å­˜ï¼Œå›åˆ°å¯¹è¯é¡µé¢ï¼Œåˆ™èƒ½çœ‹åˆ°æœ¬åœ°è¿è¡Œçš„DeepSeek-R1æ¨¡å‹ï¼š

![](images/978a546e-5335-4a29-8b64-f0afe0a51ed2.png)

ç„¶åå³å¯å¼€å¯å¯¹è¯ï¼š

![](images/156922ee-386d-44fc-bde1-58a23efd73b5.png)

&#x20;

![](images/5b046af4-b8c7-4ece-9407-46d7b584f258.png)

æ›´å¤šå…³äºOpen-WebUIä½¿ç”¨æ–¹æ³•ï¼Œå¦‚è”ç½‘ã€è¿æ¥æœ¬åœ°çŸ¥è¯†åº“ã€è¿æ¥å¤–éƒ¨å·¥å…·ï¼ˆMySQLæ•°æ®åº“ï¼‰ã€ä»£ç è§£é‡Šå™¨ã€å¤šæ¨¡å‹ç®¡ç†ã€ç”¨æˆ·ç®¡ç†ç­‰ï¼Œè¯¦è§å…¬å¼€è¯¾ã€ŠDeepSeek R1ç»ˆæéƒ¨ç½²æŒ‡å—ã€‹ï¼šhttps://www.bilibili.com/video/BV1qU9AYLEe3/

![](images/9ea70952-6e59-4241-a950-2646854deacc.png)

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†Ktransformers+Unslothæ–¹æ¡ˆè”åˆéƒ¨ç½²çš„å…¨æµç¨‹ã€‚

***

æ›´å¤šå…³äºå¤§æ¨¡å‹æŠ€æœ¯ä»‹ç»ï¼Œæ¬¢è¿æŠ¥åç”±æˆ‘ä¸»è®²çš„ã€Š2025å¤§æ¨¡å‹Agentæ™ºèƒ½ä½“å¼€å‘å®æˆ˜ã€‹ï¼ˆ2æœˆDeepSeekå¼ºåŒ–ç­ï¼‰https://whakv.xetslk.com/s/3uzKfW è¿›è¡Œæ›´æ·±åº¦ç³»ç»Ÿçš„å­¦ä¹ å“¦\~

![](images/6611e883-a888-461c-9492-335d68bac497.png)

&#x20;

![](images/fbd0fbfa-d3a8-428a-95bd-4fc5c9cb765e.png)

&#x20;

![](images/ee6bdcdb-f88d-414b-90ce-e6cee2de40b9.png)

**[ã€Š2025å¤§æ¨¡å‹Agentæ™ºèƒ½ä½“å¼€å‘å®æˆ˜ã€‹](https://whakv.xetslk.com/s/3uzKfW)3æœˆç­ä¸Šæ–°ç‰¹æƒ è¿›è¡Œæ—¶ï¼Œè¯¦ç»†ä¿¡æ¯æ‰«ç æ·»åŠ åŠ©æ•™ï¼Œå›å¤â€œå¤§æ¨¡å‹â€ï¼Œå³å¯é¢†å–è¯¾ç¨‹å¤§çº²&æŸ¥çœ‹è¯¾ç¨‹è¯¦æƒ…ğŸ‘‡**

![](images/fd5083cf-54e5-4851-b9f6-a0e3f65e8ded-5.jpeg)

æ­¤å¤–ï¼Œå¦‚æœå¯¹å¤§æ¨¡å‹åº•å±‚åŸç†å’Œæ¨¡å‹è®­ç»ƒæ„Ÿå…´è¶£ï¼Œæ¬¢è¿æŠ¥åç”±æˆ‘å’Œèœèœè€å¸ˆå…±åŒå¼€è®¾çš„ã€Šå¤§æ¨¡å‹åŸç†ä¸è®­ç»ƒå®æˆ˜ã€‹https://whakv.xetslk.com/s/3p66pNå®æˆ˜è¯¾ï¼Œ3æœˆæ–°ç­é¢å¤–æ–°å¢å¤§é‡DeepSeek V3\&R1æ¨¡å‹åŸç†ä¸è®­ç»ƒå®æˆ˜å†…å®¹ï¼Œæ‰«æä¸Šæ–¹äºŒç»´ç å³å¯æŸ¥çœ‹å®Œæ•´è¯¾ç¨‹å¤§çº²å“¦\~

![](images/b040c1fa-23b5-4339-bad3-5d612fde9c89.png)
